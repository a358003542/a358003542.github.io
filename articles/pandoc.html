<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="msvalidate.01" content="55CB117A61A6F8286173763FB18D9625" />

    <meta name="author" content="wanze" />
    <meta name="copyright" content="wanze" />

    <meta name="description"
        content="前言 pandoc是一个非常强大的文档格式转换工具，你可以利用它来根据markdown来转换生成epub，或者根据html来生成epub。也可以根据latex文档输出markdown或者根据latex输出epub和html等等。 从latex刷html经验总结 pandoc --toc -s ..." />


<meta name="keywords" content=", 计算机 - 文档开发, " />

<title>pandoc  -
    万泽的博客</title>

    <link href="https://a358003542.github.io/theme/dist/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://a358003542.github.io/theme/dist/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <link href="https://a358003542.github.io/theme/css/base.css" rel="stylesheet">

<link rel="stylesheet" href="https://a358003542.github.io/theme/css/pygments.css">
<link rel="stylesheet" href="https://a358003542.github.io/theme/css/article.css">
</head>

<body>
    <div class="flex-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="https://a358003542.github.io/">网站首页</a>

                <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse"
                    data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>


                <div class="navbar-collapse collapse" id="navbarContent">
                    <form action="https://a358003542.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"
                        class="d-flex me-auto">

                        <input type="search" name="q" id="tipue_search_input" class="form-control me-2"
                            placeholder="Search..." aria-label="Search">

                        <button class="btn btn-outline-primary text-nowrap" type="submit">搜索</button>
                    </form>


                    <ul class="navbar-nav mb-lg-0">

                        <li class="nav-item ">
                            <a class="nav-link "
                                href="/archives.html">所有博文</a>
                        </li>

                        <li class="nav-item ">
                            <a class="nav-link "
                                href="/categories.html">博文分类</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link  " href="https://a358003542.github.io/about.html">关于本网站</a>
                        </li>
                    </ul>


                </div>
            </div>
        </nav>


<div class="container-xxl mt-3">
    <div class="row">
        <div class="col-md-4 col-lg-3"></div>
        <header class="col-sm-12 col-md-8 col-lg-8 page-header">
            <h1><a href="https://a358003542.github.io/articles/pandoc.html"> pandoc  </a></h1>
        </header>
    </div>

    <div class="row">
        <div class="col-sm-12 col-md-4 col-lg-3">
            <div class="p-3 bg-white small">
                <div style="font-size:1.2rem;">目录</div>
                <div class="toc">
<ul>
<li><a href="#前言">前言</a><ul>
<li><a href="#从latex刷html经验总结">从latex刷html经验总结</a></li>
<li><a href="#从tex刷epub经验总结">从tex刷epub经验总结</a></li>
<li><a href="#从html刷epub经验总结">从html刷epub经验总结</a></li>
</ul>
</li>
</ul>
</div>

                <div class="p-1">首发于：<time pubdate="pubdate" datetime="2022-09-02T22:02:08.308085+08:00">2022年 9月 2日 </time>
                </div>

                <div class="p-1">最近更新于：<time datetime="2022-09-02T22:02:08.308085+08:00">2022年 9月 2日 </time>
                </div>


                <div class="p-1">分类：
                <a class="category-link" href="https://a358003542.github.io/categories.html#ji-suan-ji-wen-dang-kai-fa-ref">计算机 - 文档开发</a>
                </div>

            </div>
        </div>

        <div class="col-sm-12 col-md-8 col-lg-8">
            <div class="article-content">
                
<h2 id="前言">前言</h2>
<p>pandoc是一个非常强大的文档格式转换工具，你可以利用它来根据markdown来转换生成epub，或者根据html来生成epub。也可以根据latex文档输出markdown或者根据latex输出epub和html等等。</p>
<h3 id="从latex刷html经验总结">从latex刷html经验总结</h3>
<div class="highlight"><pre><span></span><code>pandoc --toc -s -o main.html main.tex --metadata-file=epub.yaml
</code></pre></div>
<p><code>--toc</code> 会根据latex里面的 <code>\tableofcontents</code> 再<body> 里面新增一个<nav> 字段，里面有目录结构。</nav></body></p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">nav</span> <span class="na">id</span><span class="o">=</span><span class="s">"TOC"</span> <span class="na">role</span><span class="o">=</span><span class="s">"doc-toc"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"#编者言"</span><span class="p">&gt;</span>编者言<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"#古训增广贤文"</span><span class="p">&gt;</span>古训增广贤文<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"#附录"</span><span class="p">&gt;</span>附录<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"#新增广贤文"</span><span class="p">&gt;</span>新增广贤文<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"#上集"</span><span class="p">&gt;</span>上集<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"#下集"</span><span class="p">&gt;</span>下集<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
</code></pre></div>
<p>在转化中，latex的part命令对应html的h1标签，section命令对应html的h2标签，后面的以此推断之。</p>
<p><code>-s</code> 输出完整版的html文件，也就是包含html，head，body这些标签。</p>
<p>tex里面的 title 命令 和 author 命令会让html有：</p>
<div class="highlight"><pre><span></span><code>  &lt;meta name="author" content="增广贤文" /&gt;
  &lt;title&gt;增广贤文&lt;/title&gt;
</code></pre></div>
<p>此外在body之下还会有：</p>
<div class="highlight"><pre><span></span><code>&lt;header id="title-block-header"&gt;
&lt;h1 class="title"&gt;增广贤文&lt;/h1&gt;
&lt;p class="author"&gt;增广贤文&lt;/p&gt;
&lt;/header&gt;
</code></pre></div>
<p>下面讲到的metadata也可以直接传递title和author这两个metadata，效果同上。</p>
<p><code>--metadata-file</code> 编写一个yaml文件，里面定义一些传递给pandoc的额外的参数。</p>
<h4 id="metadata解释">metadata解释</h4>
<p>title和author上面已经解释了。</p>
<ul>
<li>date 会增加这两行关于date的信息描述，一个是meta，一个在body之下。</li>
</ul>
<div class="highlight"><pre><span></span><code>    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"dcterms.date"</span> <span class="na">content</span><span class="o">=</span><span class="s">"2021-10-02"</span> <span class="p">/&gt;</span>

    <span class="p">&lt;</span><span class="nt">header</span> <span class="na">id</span><span class="o">=</span><span class="s">"title-block-header"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span> <span class="na">class</span><span class="o">=</span><span class="s">"title"</span><span class="p">&gt;</span>增广贤文<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"author"</span><span class="p">&gt;</span>增广贤文<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"date"</span><span class="p">&gt;</span>2021-10-02<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
</code></pre></div>
<ul>
<li>lang 如果没有则lang描述为空，如果设置则有：</li>
</ul>
<div class="highlight"><pre><span></span><code>&lt;html xmlns="http://www.w3.org/1999/xhtml" lang="zh" xml:lang="zh"&gt;
</code></pre></div>
<h3 id="从tex刷epub经验总结">从tex刷epub经验总结</h3>
<p>如果你的文件源是tex并想制作epub文件，那么推荐如下一步到位：</p>
<div class="highlight"><pre><span></span><code>pandoc -o main.epub main.tex --metadata-file=epub.yaml
</code></pre></div>
<p>可能会有需要利用calibre来进一步进行epub编辑，但如果能够从文件源内容控制入手一步到位当然会更好。</p>
<p>首先是目录，因为tex具有良好的目录标记定义，输出的epub目录也是良好的【这里说的epub目录指的是epub阅读左侧用于导航用的目录，也可以说是书签。】</p>
<p>epub的目录输出首先会自动根据metadata的title来生成一个h1标识，并作为第一个顶级书签。后面part或者chapter你自己随意，虽然epub内部显示效果都是可以调整的，不过epub内部editor打开可以看到，最好认为 part命令 对应epub的 一个章节也就是内部的ch001.xhtml一个独立文本。在显示上这样一个<code>ch001.xhtml</code>的独立文本是单独起页的。而假如是多个chapter命令则其仍然都会归于一个<code>ch00?.xhtml</code> 文本中，在显示tex的上一chapter和另外一chapter命令之间的内容不是单独起页的。<strong>因此我推荐在编写tex的时候认为part对应传统意义上的一章来输出epub</strong>。</p>
<p>tex里面的 title 命令 和 author 命令会让epub的<code>title_page.xhtml</code> 有内容：</p>
<div class="highlight"><pre><span></span><code>&lt;section epub:type="titlepage" class="titlepage"&gt;
  &lt;h1 class="title"&gt;增广贤文&lt;/h1&gt;
  &lt;p class="author"&gt;增广贤文&lt;/p&gt;
&lt;/section&gt;
</code></pre></div>
<p>不过这只是自动生成的封面，具体和epub的metadata相关的是 <code>content.opf</code> 哪里定义的：</p>
<div class="highlight"><pre><span></span><code>    &lt;dc:title id="epub-title-1"&gt;增广贤文&lt;/dc:title&gt;
    &lt;dc:creator id="epub-creator-1"&gt;增广贤文作者&lt;/dc:creator&gt;
</code></pre></div>
<p>是的author在epub那边是 <code>dc:creator</code> ，导入calibre会根据这里的对应来自动填入元数据。</p>
<ul>
<li>date 影响的是 <code>content.opf</code> 里的这个字段：</li>
</ul>
<div class="highlight"><pre><span></span><code>    &lt;dc:date id="epub-date"&gt;2021-12-01T04:37:02Z&lt;/dc:date&gt;
</code></pre></div>
<p>如果不填入这个metadata会自动填入当前的时间点。</p>
<ul>
<li>lang 影响的是 <code>content.opf</code> 里的这个字段：</li>
</ul>
<div class="highlight"><pre><span></span><code>    &lt;dc:language&gt;en-US&lt;/dc:language&gt;
</code></pre></div>
<p>如果不填入这个metadata会自动填入en-US。中文的代码是 <code>zh</code> ，其他语言请参看 <a href="https://www.rfc-editor.org/info/bcp47">这个网页</a> 。calibre会根据这里来自动填入语种元数据。</p>
<ul>
<li>subjects</li>
</ul>
<div class="highlight"><pre><span></span><code>subject: [文学 - 哲学,]
</code></pre></div>
<p>其影响的是 <code>content.opf</code> 里的这个字段：</p>
<div class="highlight"><pre><span></span><code>    &lt;dc:subject&gt;文学 - 哲学&lt;/dc:subject&gt;
</code></pre></div>
<p>calibre会自动根据这个来填写标签元数据。</p>
<ul>
<li>
<p>css 指定epub的css文件，否则epub只有默认的css配置。</p>
</li>
<li>
<p>cover-image 指定epub的封面。</p>
</li>
</ul>
<h3 id="从html刷epub经验总结">从html刷epub经验总结</h3>
<p>首先就多个html作为文件源的情况作出说明，请始终认为只有一个html文件源，pandoc接受多个html文件源首先就会将他们合并为一个html文件源。比如说文章内链接，本来可能在两个html文件内，都应该用一个html文件源的思路来处理。再说得详细点，假设两个html：ch1.html和ch2.html，其中ch2有一小节标记文章内链接锚点：</p>
<div class="highlight"><pre><span></span><code>&lt;section id="section1"&gt;what&lt;/section&gt;
</code></pre></div>
<p>那么ch1.html中想要正确链接该小节，直接使用 <code>&lt;a href="#section1"&gt;&lt;/a&gt;</code> 即可。</p>
<p>epub的目录输出首先会自动根据metadata的title来生成一个h1标识，并作为第一个顶级书签。后面h1或者h2你自己随意，虽然epub内部显示效果都是可以调整的，不过epub内部editor打开可以看到，最好认为 h1 标签 对应epub的 一个章节也就是内部的ch001.xhtml一个独立文本。在显示上这样一个<code>ch001.xhtml</code>的独立文本是单独起页的。而假如是多个h2命令则其仍然都会归于一个<code>ch00?.xhtml</code> 文本中，在显示上一个h2的内容和另外一个h2的内容不是单独起页的。<strong>因此我推荐在编写html的时候认为h1对应传统意义上的一章来输出epub</strong>。</p>
<p><strong>第二个推荐是所有的html头内容都删除</strong>，也就是html,head,body这些标签都可以删除，一些metadata都通过 <code>--metadata-file</code> 来传递：</p>
<p>在实践中因为calibre的epub编辑器有目录自动生成功能和页面内目录自动生成功能，所以实际制作的时候没必要加入目录页了。</p>
<p>从网络中弄来的html资源，假设是已经下载下来的图片则会自动集成到epub里面去，而很多站内的链接假设多个网页之间id命名没有重复的话，则你将href地址的前面一大串删除，只留下 <code>#what</code> 即可。不过从网络上弄来的html资源是不可控的，具有太多复杂性，不像从markdown刷epub基本上没有太多意外。所以仍然可能有大量的校对修正工作。</p>
<p>个人建议利用pandoc将多个html合并输出一个epub大概样子之后就脱离pandoc工作流程了，后续的需求都利用calibre的epub编辑工具来进行。正如前面所说的，如果是从低复杂度刷高复杂度的文档，比如说markdown到html，基本上是满意的，但如果你的参照物是某个表现形式复杂的html网页，然后通过pandoc希望刷出类似效果的epub则是总不会令你满意的，最好是直接将epub视作一个打包的html和css等资源的集合直接到epub那边去编辑。这就好比一个复杂的东西经过某个统一的流程化的东西，还希望那个复杂的东西保持其个性特殊性，则显然是不现实的。</p>
<p>在进入calibre的epub编辑之前，需要做的工作如下：</p>
<ol>
<li>
<p>html无关的head部分删除</p>
</li>
<li>
<p>html的h1, h2等文档结构标记基本确定【尤其是一些不规范的网页需要专门编写脚本来<strong>清洗h头标签</strong>，因为后面calibre自动生成就是根据这些标签来的，而且按照html规范写法也不应该随意乱用这些标签的。】</p>
</li>
<li>
<p>合并成为一个主html</p>
</li>
<li>
<p>这个时候pandoc的工作就算完成了，html情况太过于复杂，对于获得的那个主html结果肯定还有一些不满意的地方，但这都是后面的工作了。</p>
</li>
<li>
<p>脚本处理：这部分工作需要额外编写一些脚本，来分析整理主html，比如有任务： <strong>站内链接转文章内链接</strong>，<strong>站内链接html内容递归访问嵌入进来</strong>，<strong>站内链接图片下载到本地</strong>。个人实践来看，这一过程需要编写好对应的check函数，然后反复刷反复check，直到脚本下一次工作链所有的check函数会报告工作量为0，也就是就算再执行一个工作链流程也基本上什么也不会做，这个时候主程序退出。这一过程任何网络请求都应该做好缓存工作，此外整个工作链的输入输出文件IO名字要有良好的定义规范。</p>
</li>
<li>
<p>脚本处理完之后，利用pandoc将主html输出为epub文件，集成好一些epub文件元数据。</p>
</li>
</ol>
<p><strong>强调：上面的流程该做的工作都应做好无误，epub反复阅读没有大问题，才能进入到calibre的epub编辑工作。因为再也无法回头了，上面的流程那一步没做好，修改代码，再刷再修改就是，到这里就不行了。</strong> 但也不要做到尽善尽美，就是把那些数量众多一定要脚本处理的问题在上面流程做好，一些小问题小细节在calibre那边修改会更方便一些的。</p>
<p>calibre的epub编辑器有很多功能，比如目录生成啊，html代码优化啊，图片精简啊，epub检查等等，有时间会另外写篇关于calibre的epub编辑功能的文章。</p>
<div class="highlight"><pre><span></span><code>pandoc -o main.html CHAPTER-1.html CHAPTER-2.html 
pandoc --metadata-file=epub.yaml  -o main.epub main_out.html
</code></pre></div>
            </div>
        </div>

    </div>
</div>

        <footer class="footer">
            <ul class="nav justify-content-center">
                <li class="nav-item">
                    <span class="nav-link text-muted px-2">Created by Wanze & Companion with</span></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://python.org/">Python</a></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="http://getpelican.com/">Pelican</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://github.com/Python-Markdown/markdown">Markdown</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="http://oncrashreboot.com/pelican-elegant">Elegant</a></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://www.javascript.com/">Javascript</a></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://www.npmjs.com/">Npm</a></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://www.mathjax.org/">Mathjax</a>
                </li>
                <li class="nav-item">
                    <span class="nav-link text-muted px-2">etc...</span></li>
            </ul>
        </footer>
    </div>

    <script src="https://a358003542.github.io/theme/dist/lodash/js/lodash.min.js"></script>
    <script src="https://a358003542.github.io/theme/dist/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://a358003542.github.io/theme/js/base.js"></script>

<script src="https://a358003542.github.io/theme/js/article.js"></script>


</body>

</html>