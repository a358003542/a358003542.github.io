<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="msvalidate.01" content="55CB117A61A6F8286173763FB18D9625"/>

        <meta name="author" content="wanze"/>
        <meta name="copyright" content="wanze"/>

        <meta name="description"
              content="前言 django是一种构建大型商务网站的解决方案，除非目前贵公司的技术栈是已经架构在django之上的，否则不管是个人性质的小项目，或者刚刚开始的新的项目，个人推荐flask多于django的。当然在flask和tornado之间如何选择上，个人觉得更多的是在你对python的异步这一块的理解上，如果你懂python的异步，并且也知道你要做的api对并发和速度都有很高的要求，那么就应该选择tornado，否则就选择flask。 比如作为个人爱好去搭建的小网站或者api服务，那么选择flask是很适合的。本文也是作者有时鼓捣个人的小网站慢慢积累的一些东西。 推荐的启动方式 目前flask推荐的启动方式是通过： flask run 或者 python -m flask run 来启动flask。【这个方式很适合开发和测试，实际部署还是WSGI server来进行】 要正常执行上面的命令，你需要设置好一些环境变量，最主要的是 FLASK_APP 这个变量： windows set FLASK_APP=hello.py flask run linux export FLASK_APP=hello.py flask run 推荐是通过在当前工作目录下加上 .env 这个文件 …
"/>

        <meta property="og:type" content="article"/>
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="flask, web_server, " />

<meta property="og:title" content="flask模块 "/>
<meta property="og:url" content="https://a358003542.github.io/articles/flask-module.html" />
<meta property="og:description" content="前言 django是一种构建大型商务网站的解决方案，除非目前贵公司的技术栈是已经架构在django之上的，否则不管是个人性质的小项目，或者刚刚开始的新的项目，个人推荐flask多于django的。当然在flask和tornado之间如何选择上，个人觉得更多的是在你对python的异步这一块的理解上，如果你懂python的异步，并且也知道你要做的api对并发和速度都有很高的要求，那么就应该选择tornado，否则就选择flask。 比如作为个人爱好去搭建的小网站或者api服务，那么选择flask是很适合的。本文也是作者有时鼓捣个人的小网站慢慢积累的一些东西。 推荐的启动方式 目前flask推荐的启动方式是通过： flask run 或者 python -m flask run 来启动flask。【这个方式很适合开发和测试，实际部署还是WSGI server来进行】 要正常执行上面的命令，你需要设置好一些环境变量，最主要的是 FLASK_APP 这个变量： windows set FLASK_APP=hello.py flask run linux export FLASK_APP=hello.py flask run 推荐是通过在当前工作目录下加上 .env 这个文件 …" />
<meta property="og:site_name" content="wanze的博文" />
<meta property="og:article:author" content="wanze" />
<meta property="og:article:published_time" content="2020-04-05T14:12:42.687866+08:00" />
<meta name="twitter:title" content="flask模块 ">
<meta name="twitter:description" content="前言 django是一种构建大型商务网站的解决方案，除非目前贵公司的技术栈是已经架构在django之上的，否则不管是个人性质的小项目，或者刚刚开始的新的项目，个人推荐flask多于django的。当然在flask和tornado之间如何选择上，个人觉得更多的是在你对python的异步这一块的理解上，如果你懂python的异步，并且也知道你要做的api对并发和速度都有很高的要求，那么就应该选择tornado，否则就选择flask。 比如作为个人爱好去搭建的小网站或者api服务，那么选择flask是很适合的。本文也是作者有时鼓捣个人的小网站慢慢积累的一些东西。 推荐的启动方式 目前flask推荐的启动方式是通过： flask run 或者 python -m flask run 来启动flask。【这个方式很适合开发和测试，实际部署还是WSGI server来进行】 要正常执行上面的命令，你需要设置好一些环境变量，最主要的是 FLASK_APP 这个变量： windows set FLASK_APP=hello.py flask run linux export FLASK_APP=hello.py flask run 推荐是通过在当前工作目录下加上 .env 这个文件 …">


    <title>flask模块  · wanze的博文
</title>

        <link href="https://a358003542.github.io/theme/css/font-awesome.css" rel="stylesheet"
              media="screen">
        <link href="https://a358003542.github.io/theme/css/bootstrap.min.css" rel="stylesheet"
              media="screen">

        <link rel="stylesheet" type="text/css"
                  href="https://a358003542.github.io/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css"
                  href="https://a358003542.github.io/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css"
                  href="https://a358003542.github.io/theme/css/base.css" media="screen">




</head>
<body>

<nav class="navbar">
    <div class="navbar navbar-default" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target=".navbar-collapse"
                    aria-expanded="false">
                <span class="sr-only">Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a class="navbar-brand" href="https://a358003542.github.io/"><span
                    class=site-name>网站首页</span></a>
        </div>


        <div class="navbar-collapse collapse">
            <form action="https://a358003542.github.io/search.html"
                  onsubmit="return validateForm(this.elements['q'].value);"
                  class="navbar-form navbar-left">
                <div class="form-group">
                    <input type="text" name="q" id="tipue_search_input"
                           class="form-control" placeholder="Search..."
                           style="width:430px;">
                </div>
                <button class="btn btn-default" type="submit">搜索</button>
            </form>


            <ul class="nav navbar-nav nav-pills navbar-right">
                <li >
                    <a  href="/archives.html">所有文章</a></li>

                <li ><a href="/categories.html">文章分类</a></li>
                <li ><a href="/tags.html">文章标签</a></li>


                        <li >
                            <a href="https://a358003542.github.io/about.html">关于本网站</a>
                        </li>
            </ul>


        </div>
    </div>
</nav>


<div class="container-fluid">
    <div class="col-md-1 col-md-1-left"></div>
    <div class="col-md-10">
<article>
<div class="row">
    <header class="page-header col-md-10 col-md-offset-2">
    <h1><a href="https://a358003542.github.io/articles/flask-module.html"> flask模块  </a></h1>
    </header>
</div>

<div class="row">
    <div class="col-md-2 table-of-content">
        <nav>
        <h4>目录</h4>
        <div class="toc">
<ul>
<li><a href="#_1">前言</a></li>
<li><a href="#_2">推荐的启动方式</a><ul>
<li><a href="#flask_debug">FLASK_DEBUG</a></li>
<li><a href="#pycharm">pycharm启动</a></li>
</ul>
</li>
<li><a href="#flask">flask的请求分发</a></li>
<li><a href="#flask_1">flask的请求对象</a></li>
<li><a href="#flask_2">flask的请求钩子</a></li>
<li><a href="#flask_3">flask的响应对象</a></li>
<li><a href="#_3">加入错误页面</a></li>
<li><a href="#url_for">url_for</a></li>
<li><a href="#_4">静态文件</a></li>
<li><a href="#flash">flash消息</a></li>
<li><a href="#_5">大型应用结构</a></li>
<li><a href="#_6">数据库相关</a></li>
<li><a href="#flask-shell">flask shell命令定制</a></li>
<li><a href="#flask-migrate">flask-migrate</a><ul>
<li><a href="#_7">删除无用的迁移脚本</a></li>
<li><a href="#_8">彻底从零开始的迁移脚本</a></li>
</ul>
</li>
<li><a href="#flask-moment">flask-moment</a></li>
<li><a href="#flask-wtf">flask-wtf</a><ul>
<li><a href="#wtforms">WTForms模块</a></li>
<li><a href="#wtforms_1">WTForms的渲染</a></li>
<li><a href="#csrf_token">csrf_token相关</a></li>
<li><a href="#flask-bootstrap">flask-bootstrap提供的额外支持</a></li>
<li><a href="#wtformsfield">WTForms支持的Field</a></li>
<li><a href="#wtformsvalidator">WTForms提供的Validator</a></li>
</ul>
</li>
<li><a href="#flask-login">flask-login</a></li>
<li><a href="#_9">参考资料</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="col-md-8 article-content">

            
<h2 id="_1">前言</h2>
<p>django是一种构建大型商务网站的解决方案，除非目前贵公司的技术栈是已经架构在django之上的，否则不管是个人性质的小项目，或者刚刚开始的新的项目，个人推荐flask多于django的。当然在flask和tornado之间如何选择上，个人觉得更多的是在你对python的异步这一块的理解上，如果你懂python的异步，并且也知道你要做的api对并发和速度都有很高的要求，那么就应该选择tornado，否则就选择flask。</p>
<p>比如作为个人爱好去搭建的小网站或者api服务，那么选择flask是很适合的。本文也是作者有时鼓捣个人的小网站慢慢积累的一些东西。</p>
<h2 id="_2">推荐的启动方式</h2>
<p>目前flask推荐的启动方式是通过：</p>
<div class="highlight"><pre><span></span>flask run
</pre></div>
<p>或者</p>
<div class="highlight"><pre><span></span>python -m flask run 
</pre></div>
<p>来启动flask。【这个方式很适合开发和测试，实际部署还是WSGI server来进行】</p>
<p>要正常执行上面的命令，你需要设置好一些环境变量，最主要的是 <code>FLASK_APP</code> 这个变量：</p>
<p>windows </p>
<div class="highlight"><pre><span></span>set FLASK_APP=hello.py
flask run
</pre></div>
<p>linux </p>
<div class="highlight"><pre><span></span>export FLASK_APP=hello.py
flask run
</pre></div>
<p>推荐是通过在当前工作目录下加上 <code>.env</code> 这个文件，里面定义：</p>
<div class="highlight"><pre><span></span>FLASK_APP=myapp.py
FLASK_ENV=development
FLASK_DEBUG=1
</pre></div>
<p>环境变量，在运行 flask 命令的时候会自动加载这些环境变量。【这种加载行为只是针对flask命令，load_dotenv 模块之前该做的还是要做，不受影响。】</p>
<h3 id="flask_debug">FLASK_DEBUG</h3>
<p>如果设置为1则开启flask调试模式：</p>
<ul>
<li>重载器 所有源码文件变动自动重启服务器</li>
<li>调试器 出现异常在浏览器中显示异常信息</li>
</ul>
<p>生产环境一定要把调试模式关闭！</p>
<h3 id="pycharm">pycharm启动</h3>
<p>pycharm现在有专门的flask启动支持，不过也可以继续采用如上描述的启动方式，这样会更加接近服务器那边的部署环境。</p>
<p><img alt="img" src="https://a358003542.github.io/images/python_third_party/pycharm_flask.png"/></p>
<p>选择启动python脚本，选择 <code>Module name</code> ，这样就对应 <code>python -m flask</code> 命令的效果，然后加上参数 <code>run</code> ，环境变量如上所示，不用再特别调配了，工作目录设置下即可。</p>
<p>类似的你还可以再加上一个 <code>python -m flask shell</code> 命令。</p>
<h2 id="flask">flask的请求分发</h2>
<p>查看flask当前app的url分发情况</p>
<div class="highlight"><pre><span></span>app.url_map
</pre></div>
<p>默认flask有个额外的路由</p>
<div class="highlight"><pre><span></span>/static/&lt;filename&gt;
</pre></div>
<h2 id="flask_1">flask的请求对象</h2>
<p>request请求对象有：</p>
<ul>
<li>form dict 存储请求的表单字段</li>
<li>args  dict 存储URL上传递的参数</li>
<li>values form和args的合集</li>
<li>cookies dict 存储请求的所有cookies</li>
<li>headers dict 存储http的headers</li>
<li>files dict 存储请求上传的所有文件</li>
<li>get_data 返回请求主体缓冲的数据</li>
<li>get_json return dict 包含解析请求主题后得到的json</li>
<li>blueprint 处理请求的Flask蓝本</li>
<li>endpoint 处理请求的Flask端点名称</li>
<li>method HTTP请求方法</li>
<li>scheme http或https</li>
<li>is_secure 通过HTTPS发送的请求返回True</li>
<li>host  请求主机名</li>
<li>path 请求URL路径</li>
<li>query_string URL查询字符串部分</li>
<li>full_path URL 路径和查询字符串部分</li>
<li>url 完整URL</li>
<li>base_url 同url但没有查询字符串部分</li>
<li>remote_addr 远程IP地址</li>
<li>environ dict 请求原始WSGI环境 </li>
</ul>
<h2 id="flask_2">flask的请求钩子</h2>
<p>请求钩子用装饰器来实现，flask有以下四种钩子：</p>
<ul>
<li>before_request 请求之前执行</li>
<li>before_first_request 只在第一次请求前执行</li>
<li>after_request 每次请求后执行 如果程序没有抛出异常的话</li>
<li>teardown_request 每次请求之后执行，即使抛出异常</li>
</ul>
<p>请求钩子和视图函数之间变量互通一般用上下文全局变量 g ，比如 <code>before_request</code> 处理的时候设置 <code>g.user</code> 为登录用户，后面视图函数可以调用 <code>g.user</code> 来得知当前登录用户。</p>
<h2 id="flask_3">flask的响应对象</h2>
<div class="highlight"><pre><span></span>response = make_response(content, status_code)
response.set_cookie('a',1)
</pre></div>
<p>响应对象有以下属性或方法：</p>
<ul>
<li>status_code</li>
<li>headers</li>
<li>set_cookies 设置cookies</li>
<li>delete_cookies 删除一个cookies</li>
<li>content_length 内容长度</li>
<li>content_type 响应主体的媒体类型</li>
<li>set_data  </li>
<li>get_data</li>
</ul>
<p>特殊的响应： 重定向响应 状态码 302 Location部分写上目标URL flask提供 redirect函数快速生成这个重定向响应对象。</p>
<p>abort函数 其返回的是状态码404 其是抛出异常 </p>
<h2 id="_3">加入错误页面</h2>
<div class="highlight"><pre><span></span>@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'),404
</pre></div>
<p>如果是蓝图的话，要有全局的效果，则应该使用 <code>app_errorhandler</code> ：</p>
<div class="highlight"><pre><span></span><span class="nd">@main</span><span class="o">.</span><span class="n">app_errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'404.html'</span><span class="p">),</span> <span class="mi">404</span>
</pre></div>
<h2 id="url_for">url_for</h2>
<div class="highlight"><pre><span></span>url_for('index', _external=True)
</pre></div>
<ol>
<li>名字，</li>
<li>送入一些参数进去</li>
<li><code>_external</code> 绝对路径 ，一般使用相对路径即可，浏览器之外的某些链接一定要使用绝对路径</li>
</ol>
<p>如果是对应蓝图的视图函数，则前面应该加上蓝图名：</p>
<div class="highlight"><pre><span></span>url_for('main.index')
</pre></div>
<h2 id="_4">静态文件</h2>
<div class="highlight"><pre><span></span>url('static', filename='favicon.ico')
</pre></div>
<h2 id="flash">flash消息</h2>
<p>flash消息方便让用户知道一些必要的信息。flash函数可以实现这点。然后模板文件上需要加上：</p>
<div class="highlight"><pre><span></span>    {% for message in get_flashed_messages() %}
        &lt;div class="alert alert-warning"&gt;
            &lt;button type="button" class="close" data-dismiss="alert"&gt;&amp;times;&lt;/button&gt;
            {{ message }}
        &lt;/div&gt;
    {% endfor %}
</pre></div>
<h2 id="_5">大型应用结构</h2>
<p>请参看参考资料1，即有名的flasky项目的结构。下面简单说一下：</p>
<ol>
<li>
<p>配置开发测试生产分离</p>
</li>
<li>
<p>使用应用工厂函数 <code>create_app</code> 来延迟创建应用。</p>
</li>
<li>
<p>使用蓝图（Blueprint）</p>
</li>
<li>
<p>蓝图模块写法如下：</p>
</li>
</ol>
<p>```python
   from flask import Blueprint</p>
<p>main = Blueprint('main', <strong>name</strong>)</p>
<p>from . import views, errors
   ```</p>
<p>因为views errors模块那边还需要使用蓝图对象main，所以应该放在它的的后面引入进来。</p>
<ul>
<li>蓝图在应用中注册写法如下：</li>
</ul>
<p><code>python
       from .main import main as main_blueprint
       app.register_blueprint(main_blueprint)</code></p>
<ul>
<li>蓝图的错误页面需要使用 <code>app_errorhandler</code> 要注册为全局的错误处理，如果是 <code>errorhandler</code> 则只负责本蓝图内的错误。</li>
</ul>
<p><code>python
   @main.app_errorhandler(404)
   def page_not_found(e):
       return render_template('404.html'), 404</code></p>
<ul>
<li>蓝图内注册的视图函数，用 <code>url_for</code> 来获取的是 <code>main.index</code> 这种形式，即蓝图名加上视图函数名。</li>
</ul>
<h2 id="_6">数据库相关</h2>
<p><code>__tablename__</code> 定义表名，默认的表名没有遵循使用复数命名的约定 like  <code>users</code>  。</p>
<p>这一块东西后面会补充一些，但更多的是sqlalchemy和sql那边的知识。</p>
<h2 id="flask-shell">flask shell命令定制</h2>
<div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">shell_context_processor</span>
<span class="k">def</span> <span class="nf">make_shell_context</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="o">=</span><span class="n">Role</span><span class="p">)</span>
</pre></div>
<p>运行： </p>
<div class="highlight"><pre><span></span>flask shell
</pre></div>
<p>db那些变量是可以正常使用的。</p>
<p>cmd里面要配置好环境变量 <code>export FLASK_APP=hello.py</code> </p>
<h2 id="flask-migrate">flask-migrate</h2>
<p><code>flask-migrate</code> 其基于sqlalchemy 的  alembic ，然后做了一些额外的工作。 主要提供了一些便捷的命令行接口，具体使用还是要熟悉sqlalchemy和alembic。</p>
<p>一个简要的例子如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'sqlite:///app.db'</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>

<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
</pre></div>
<p>新项目首先要运行：</p>
<div class="highlight"><pre><span></span>flask db init
</pre></div>
<p>这对应alembic的 <code>alembic init</code> 命令，其将创建 <code>migrations</code> 文件夹，里面的文件就是alembic需要的，migrations文件夹是推荐和源代码一起加入版本控制的。</p>
<p>和简单的使用的alembic不同，其新建的 <code>env.py</code> 有一些优化，flask的配置环境里只要配置了 <code>SQLALCHEMY_DATABASE_URI</code> 这样变量，alembic就能正确找到数据库了。</p>
<p>然后：</p>
<div class="highlight"><pre><span></span>flask db revision # 对应的是 alembic revison
flask db migrate # 对应的是 alembic revision --autogenerate
flask db upgrade # 对应的是 alembic upgrade
flask db downgrade # 对应的是 alembic downgrade
</pre></div>
<p>一般工作流程：</p>
<ol>
<li>修改数据库模型或者说数据库模型发生了变动</li>
<li><code>flask db migrate</code> 创建迁移脚本</li>
<li>检查自动生成的脚本，改正不正确的地方</li>
<li><code>flask db upgrade</code>  将改动应用到数据库</li>
</ol>
<h3 id="_7">删除无用的迁移脚本</h3>
<p>alembic的自动生成脚本并不是万能的，需要人工审核。而就算没问题的某些迁移脚本，如果你觉得已经毫无意义了，那么将那个版本的迁移脚本删除是没有任何问题的。</p>
<h3 id="_8">彻底从零开始的迁移脚本</h3>
<p>虽然alembic的官方文档觉得没有这个必要，不过我觉得还是很有用的。</p>
<ol>
<li>首先我们在flask应用下加上这样两个命令，负责最开始的创建数据库和根本代码生成表格工作。</li>
<li>表格生成成功之后后面都用flask-migrate 或者说 alembic来管理，经过测试比如在models.py 哪里新加一列，然后利用 <code>flask db migrate</code> 是能够自动检测新加入了一列，从而自动生成的代码会更加精准。</li>
</ol>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy_utils</span> <span class="kn">import</span> <span class="n">database_exists</span><span class="p">,</span> <span class="n">create_database</span><span class="p">,</span> <span class="n">drop_database</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">initdb</span><span class="p">():</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'本命令只用于数据库初始化，后续更改请使用alembic来管理，确定请输入 [Y]'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'y'</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">engine</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
            <span class="n">create_database</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'db exists...'</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">alembic.config</span> <span class="kn">import</span> <span class="n">Config</span>
        <span class="kn">from</span> <span class="nn">alembic</span> <span class="kn">import</span> <span class="n">command</span>
        <span class="n">alembic_cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="s1">'migrations/alembic.ini'</span><span class="p">)</span>

        <span class="n">command</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">alembic_cfg</span><span class="p">,</span> <span class="s2">"head"</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">dropdb</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    TODO 生产环境不允许调用本命令</span>
<span class="sd">    :return:</span>
<span class="sd">    """</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'警告!!! 本操作将删除数据库，数据将完全丢失，确定请输入： [YYY]'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_input</span> <span class="o">==</span> <span class="s1">'YYY'</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">engine</span>

        <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
            <span class="n">drop_database</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'db not exists...'</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</pre></div>
<h2 id="flask-moment">flask-moment</h2>
<p>Moment JS 送入UTC时间会自动转换成为本地时间，服务器那边的时间戳最好是记录UTC时间。用户则应该看到本地时间。</p>
<div class="highlight"><pre><span></span>{% block scripts %}
    {{ super() }}
    {{ moment.include_moment() }}
    {{ moment.lang("zh-cn") }}
{% endblock %}
</pre></div>
<p>在模板上使用：</p>
<div class="highlight"><pre><span></span>    &lt;p&gt;当前时间是： {{ moment(current_time).format('LLLL') }}.&lt;/p&gt;
    &lt;p&gt;{{ moment(current_time).fromNow(refresh=True) }}刷新过.&lt;/p&gt;
</pre></div>
<p>具体格式请参看 <a href="http://momentjs.cn/">MomentJs 官网</a> 。</p>
<h2 id="flask-wtf">flask-wtf</h2>
<p>这块初接触在理解上是有点困难的，其实flask-wtf提供的主要是对WTForms这个模块的集成支持，然后还有一些功能比如 <code>wtf.quick_form(form)</code> 这个是 flask-bootstrap 对 WTForms的一些额外的支持。这里理解上的关键在于理解 WTForms 这个模块到底在干什么事情。</p>
<h3 id="wtforms">WTForms模块</h3>
<p>简单来说WTForms模块做的工作就是方便你在模板引擎上比如jinja2模块引擎上快速创建输入表单和相关验证事宜。</p>
<p>首先需要定义一个Form类：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">BooleanField</span><span class="p">,</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">validators</span>

<span class="k">class</span> <span class="nc">RegistrationForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span>     <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">'Username'</span><span class="p">,</span> <span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">25</span><span class="p">)])</span>
    <span class="n">email</span>        <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">'Email Address'</span><span class="p">,</span> <span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">35</span><span class="p">)])</span>
    <span class="n">accept_rules</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">(</span><span class="s1">'I accept the site rules'</span><span class="p">,</span> <span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
</pre></div>
<p>Form类里面有一些Field类，然后Field类里面可以通过一个列表定义一系列的Validators 验证器。每个Field都有一个Widget ，Widget的任务就是负责HTML的渲染工作。</p>
<p>关于这个form类值得我们注意的有：</p>
<ol>
<li>这个form对象，你可以通过 <code>form.username.data</code> 来获取表单中的值。</li>
<li>如果你在定义这个form对象的时候定义了其他 <code>validate_&lt;field_name&gt;</code> 函数，这些函数会针对特定的field_name而进行调用。如果验证失败，则抛出 <code>ValidationError</code> 异常，异常的信息将作为错误信息。</li>
</ol>
<p>这个Form类在python中的代码使用如下：</p>
<div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/submit'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">submit</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">MyForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'/success'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'submit.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>然后 flask-wtf 下的使用代码如下：</p>
<div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/submit'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">submit</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">MyForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'/success'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'submit.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>flask-wtf 定义的Form类在使用上提供的便利有：</p>
<ol>
<li>会自动将 <code>request.form</code> 或者 <code>request.files</code> 塞进去。</li>
<li>直接使用 <code>validate_on_submit</code> 方法即可，里面集成了对 request.method 的判断——<code>POST PUT PATCH DELETE</code> 都是可以的。</li>
</ol>
<p>WTForms 初始化接收值，除了第一个值 <code>request.form</code> 等，还支持对接某个model 对象，后面还可以跟上一些关键词参数：</p>
<div class="highlight"><pre><span></span>form = MyForm(request.form, user, username='zhangsan')
</pre></div>
<p>WTForms提供了很多内置的验证器支持，你还可以定义自己的验证器。这些验证器对应到上面的 <code>validate</code> 方法中，这个后面再说。</p>
<h3 id="wtforms_1">WTForms的渲染</h3>
<p>上面提到的form类实例中的Field是可以直接调用str() 来获得如下的一段HTML代码的：</p>
<div class="highlight"><pre><span></span>&lt;input id="content" name="content" type="text" value="foobar" /&gt;
</pre></div>
<p>我们看到一般模板引擎渲染时，比如jinja2，会接受form实例。然后一个一般的表单渲染如下：</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LoginForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">'Username'</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s1">'Password'</span><span class="p">)</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span>&lt;form method="POST" action="/login"&gt;
    &lt;div&gt;{{ form.username.label }}: {{ form.username(class="css_class") }}&lt;/div&gt;
    &lt;div&gt;{{ form.password.label }}: {{ form.password() }}&lt;/div&gt;
&lt;/form&gt;
</pre></div>
<p>在python代码那边，form的Field部分是可以接受一些额外的关键词参数，其将作为属性传入从而作为input标签的属性。</p>
<h3 id="csrf_token">csrf_token相关</h3>
<p>WTForms 已经有了 <code>csrf_token</code> 的支持功能：</p>
<div class="highlight"><pre><span></span> {{ form.csrf_token }}
</pre></div>
<p>关于这块具体细节请参看WTForms的csrf_token相关章节，这里不深究了，一个csrf_token安全校验。</p>
<p>而 flask-wtf 这边推荐的写法是：</p>
<div class="highlight"><pre><span></span>&lt;form method="POST" action="/"&gt;
    {{ form.hidden_tag() }}
    {{ form.name.label }} {{ form.name(size=20) }}
&lt;/form&gt;
</pre></div>
<p><code>hidden_tag</code> 这个方法是flask-wtf提供的，就是将所有隐藏的html field 渲染在这里，因为 flask-wtf 默认会加上 csrf_token 支持，也就是上面的语句：</p>
<div class="highlight"><pre><span></span> {{ form.csrf_token }}
</pre></div>
<p>这是一个hidden标签，所以最后还是会渲染在这里。</p>
<h3 id="flask-bootstrap">flask-bootstrap提供的额外支持</h3>
<p>flask-bootstrap又提供了一些额外的支持，简单来说就是编写了一些jinja2的宏。比如 <code>quick_form</code> 宏：</p>
<div class="highlight"><pre><span></span>{{ wtf.quick_form(form) }}
</pre></div>
<p>大体对应于输出这样的语句：</p>
<div class="highlight"><pre><span></span>{% import "bootstrap/wtf.html" as wtf %}
&lt;form class="form form-horizontal" method="post" role="form"&gt;
  {{ form.hidden_tag() }}
  {{ wtf.form_errors(form, hiddens="only") }}

  {{ wtf.form_field(form.field1) }}
  {{ wtf.form_field(form.field2) }}
&lt;/form&gt;
</pre></div>
<p>这里只是说大体对应，因为quick_form 宏还有一些参数可以调配。上面对应的只是默认参数的输出情况。</p>
<p>然后上面的 <code>form_errors</code> 宏 和 <code>form_field</code> 宏也都是 flask-bootstrap 那个宏文件里面定义的。总之如果刚开始对表单的显示没有什么特别的要求的话， <code>quick_form</code> 宏还是很好用的。</p>
<p>有的时候有特别的要求，个人觉得是没有必要深究flask-bootstrap 那边宏定义的情况，退化为上面的写法，再稍作定制看看是否满足你的要求。否则直接用 flask-wtf 如下这种最原始的写法，再调配下即可。</p>
<div class="highlight"><pre><span></span>&lt;form method="POST" action="/"&gt;
    {{ form.hidden_tag() }}
    {{ form.name.label }} {{ form.name(size=20) }}
&lt;/form&gt;
</pre></div>
<h3 id="wtformsfield">WTForms支持的Field</h3>
<ul>
<li>BooleanField 复选框</li>
<li>DateField 文本字段 for datetime.date</li>
<li>DateTimeField 文本字段 for datetime.datetime</li>
<li>DecimalField 文本字段 for  decimal.Decimal</li>
<li>FileField 文件上传字段</li>
<li>HiddenField 隐藏文本字段</li>
<li>FieldList 一组指定类型的字段</li>
<li>FloatField 文本字段 for float</li>
<li>FormField 把一个表单作为字段嵌入另一个表单</li>
<li>IntegerField 文本字段 for integer</li>
<li>PasswordField 密码文本字段</li>
<li>RadioField 单选按钮</li>
<li>SelectField 下拉列表</li>
<li>SelectmultipleField 下拉多选列表</li>
<li>SubmitField 表单提交按钮</li>
<li>StringField 文本字段</li>
<li>TextAreaField 多行文本字段</li>
</ul>
<h3 id="wtformsvalidator">WTForms提供的Validator</h3>
<ul>
<li>DataRequired 确保类型转换后字段有数据</li>
<li>Email 验证电子邮箱</li>
<li>EqualTo 比较两个字段的值 常用于比较两次密码是否输入一致</li>
<li>InputRequired 确保类型转换前字段有数据</li>
<li>IPAddress 验证IPv4地址</li>
<li>Length 长度验证</li>
<li>MacAddress 验证MAC地址</li>
<li>NumberRange 数字范围校验</li>
<li>Optional 允许字段没有输入，将跳过其他校验函数</li>
<li>Regexp 正则表达式校验</li>
<li>URL URL校验</li>
<li>UUID UUID校验</li>
<li>AnyOf 输入值在任一可能值中</li>
<li>NoneOf 输入值不在一组可能值中</li>
</ul>
<h2 id="flask-login">flask-login</h2>
<p>flask-login引入进来之后 所有的jinja2模块都支持 <code>current_user</code> 这个变量了。</p>
<p>然后其提供了 <code>login_required</code> 来对url进行权限控制。</p>
<p>具体flask-login的使用请参看官方文档，这里重点讲一下flask-login都做了哪些事情，这个参考资料1说的很好。</p>
<ol>
<li><code>login_user</code> 函数用于登录用户，核心任务就是将用户的id写入flask的session。类似的 <code>logout_user</code> 就是将这个id从session中删除。</li>
<li>渲染jinja2模板的时候，会出现对 flask-login 的 <code>current_user</code> 这个变量的请求。具体就是调用flask-login 的<code>_get_user</code> 函数。<code>_get_user</code> 首先检查session中有没有用户id，没有则返回 <code>AnonymousUser</code> ，有则调用 <code>user_loader</code> 装饰器注册的函数。【这里值得额外一提的是，在python代码那边引用 <code>current_user</code> 返回的不是数据库的User对象，要获得数据库对象需要使用 <code>current_user._get_current_object()</code>】</li>
<li><code>login_required</code> 是对当前的 <code>current_user</code> 的 <code>is_authenticated</code> 方法进行调用，如果True 则通过，False则拒绝。</li>
</ol>
<h2 id="_9">参考资料</h2>
<ol>
<li>Flask Web 开发第二版 米格尔·格林贝格著 安道译</li>
</ol>

            
            <hr/>

        </div>
        <section>
        <div class="col-md-2" style="float:right;font-size:0.9em;">
            <h4>首发于：</h4>
            <time pubdate="pubdate" datetime="2020-04-05T14:12:42.687866+08:00">2020年 4月 5日 </time>

            <h4>分类：</h4>
            <a class="category-link" href="https://a358003542.github.io/categories.html#web_server-ref">web_server</a>
            <h4>标签：</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://a358003542.github.io/tags.html#flask-ref">flask
                    <span>2</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
    </div>
    <div class="col-md-1"></div>

</div>


<div id="push"></div>
<button id="gotop" type="button" class="btn btn-default">
    <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
</button>

<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a> and updated by <a href="https://github.com/a358003542" title="wanze Home Page">wanze</a></li>
    </ul>
</div>
</footer>

        <script src="https://a358003542.github.io/theme/js/jquery.min.js"></script>
    <script src="https://a358003542.github.io/theme/js/bootstrap.min.js"></script>

    <script src="https://a358003542.github.io/theme/js/base.js"></script>

    


</body>
</html>