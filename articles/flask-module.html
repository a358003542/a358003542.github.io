<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="baidu-site-verification" content="D4VqC4HppC" />
	<meta name="msvalidate.01" content="55CB117A61A6F8286173763FB18D9625" />

    <meta name="author" content="cdwanze"/>
    <meta name="copyright" content="cdwanze"/>

    <meta property="og:type" content="article"/>
    <meta name="twitter:card" content="summary">

<meta name="keywords" content="flask, python好伙伴, " />

<meta property="og:title" content="flask模块 "/>
<meta property="og:url" content="/articles/flask-module.html" />
<meta property="og:description" content="前言 django是一种构建大型商务网站的解决方案，除非目前贵公司的技术栈是已经架构在django之上的，否则不管是个人性质的小项目，或者刚刚开始的新的项目，个人推荐flask多于django的。当然在flask和tornado之间如何选择上，个人觉得更多的是在你对python的异步这一块的理解上，如果你懂python的异步，并且也知道你要做的api对并发和速度都有很高的要求，那么就应该选择tornado，否则就选择flask。 比如作为个人爱好去搭建的小网站或者api服务，那么选择flask是很适合的。本文也是作者有时鼓捣个人的小网站慢慢积累的一些东西。 推荐的启动方式 目前flask推荐的启动方式是通过： flask run 或者 python -m flask run 来启动flask。【这个方式很适合开发和测试，实际部署还是WSGI server来进行】 要正常执行上面的命令，你需要设置好一些环境变量，最主要的是 FLASK_APP 这个变量： windows set FLASK_APP=hello.py flask run linux export FLASK_APP=hello.py flask run 推荐是通过在当前工作目录下加上 .env 这个文件 …" />
<meta property="og:site_name" content="cdwanze的博文" />
<meta property="og:article:author" content="cdwanze" />
<meta property="og:article:published_time" content="2019-01-03T00:00:00+08:00" />
<meta property="" content="2019-07-22T00:00:00+08:00" />
<meta name="twitter:title" content="flask模块 ">
<meta name="twitter:description" content="前言 django是一种构建大型商务网站的解决方案，除非目前贵公司的技术栈是已经架构在django之上的，否则不管是个人性质的小项目，或者刚刚开始的新的项目，个人推荐flask多于django的。当然在flask和tornado之间如何选择上，个人觉得更多的是在你对python的异步这一块的理解上，如果你懂python的异步，并且也知道你要做的api对并发和速度都有很高的要求，那么就应该选择tornado，否则就选择flask。 比如作为个人爱好去搭建的小网站或者api服务，那么选择flask是很适合的。本文也是作者有时鼓捣个人的小网站慢慢积累的一些东西。 推荐的启动方式 目前flask推荐的启动方式是通过： flask run 或者 python -m flask run 来启动flask。【这个方式很适合开发和测试，实际部署还是WSGI server来进行】 要正常执行上面的命令，你需要设置好一些环境变量，最主要的是 FLASK_APP 这个变量： windows set FLASK_APP=hello.py flask run linux export FLASK_APP=hello.py flask run 推荐是通过在当前工作目录下加上 .env 这个文件 …">

    <title>flask模块  · cdwanze的博文
</title>


    <link href="/theme/css/font-awesome.css" rel="stylesheet" media="screen">
    <link href="/theme/css/bootstrap.min.css" rel="stylesheet" media="screen">

    <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">






</head>
<body>

<nav class="navbar">
    <div class="navbar navbar-default" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false">
                <span class="sr-only">Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a class="navbar-brand" href="/"><span class=site-name>网站首页</span></a>
        </div>


        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav nav-pills navbar-right">
                <li >
                    <a href="">博文首页</a></li>

                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">查找文章<span class="caret"></span></a>
                 <ul class="dropdown-menu">
                  <li><a class="slowscroll" href="/categories.html">按分类</a></li>
                 <li><a class="slowscroll" href="/tags.html">按标签</a></li>
                </ul>
                </li>


                <li >
                    <a href="/guan-yu-ben-wang-zhan.html">关于本网站</a></li>
                <li >
                    <a href="/gong-gao.html">公告</a></li>
            </ul>

            <form action="/search.html" onsubmit="return validateForm(this.elements['q'].value);" class="navbar-form navbar-left">
                <div class="form-group">
                <input type="text" name="q"  id="tipue_search_input" class="form-control" placeholder="Search..." style="width:350px">
                </div>
                <button class="btn btn-default" type="submit">搜索</button>
            </form>
        </div>
    </div>
</nav>


<div class="container-fluid">
    <div class="col-md-1 col-md-1-left"></div>
    <div class="col-md-10">
<article>
<div class="row">
    <header class="page-header col-md-10 col-md-offset-2">
    <h1><a href="/articles/flask-module.html"> flask模块  </a></h1>
    </header>
</div>

<div class="row">
    <div class="col-md-2 table-of-content">
        <nav>
        <h4>目录</h4>
        <div class="toc">
<ul>
<li><a href="#_1">前言</a></li>
<li><a href="#_2">推荐的启动方式</a><ul>
<li><a href="#flask_debug">FLASK_DEBUG</a></li>
<li><a href="#pycharm">pycharm启动</a></li>
</ul>
</li>
<li><a href="#flask">flask的请求分发</a></li>
<li><a href="#flask_1">flask的请求对象</a></li>
<li><a href="#flask_2">flask的请求钩子</a></li>
<li><a href="#flask_3">flask的响应对象</a></li>
<li><a href="#_3">加入错误页面</a></li>
<li><a href="#url_for">url_for</a></li>
<li><a href="#_4">静态文件</a></li>
<li><a href="#flash">flash消息</a></li>
<li><a href="#_5">大型应用结构</a></li>
<li><a href="#_6">数据库相关</a></li>
<li><a href="#flask-shell">flask shell命令定制</a></li>
<li><a href="#flask-migrate">flask-migrate</a><ul>
<li><a href="#_7">删除无用的迁移脚本</a></li>
<li><a href="#_8">彻底从零开始的迁移脚本</a></li>
</ul>
</li>
<li><a href="#flask-moment">flask-moment</a></li>
<li><a href="#flask-wtf">flask-wtf</a><ul>
<li><a href="#_9">表单提交模式</a></li>
</ul>
</li>
<li><a href="#flask-mail">flask-mail</a></li>
<li><a href="#flask-login">flask-login</a></li>
<li><a href="#_10">参考资料</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="col-md-8 article-content">

            
            
<h2 id="_1">前言</h2>
<p>django是一种构建大型商务网站的解决方案，除非目前贵公司的技术栈是已经架构在django之上的，否则不管是个人性质的小项目，或者刚刚开始的新的项目，个人推荐flask多于django的。当然在flask和tornado之间如何选择上，个人觉得更多的是在你对python的异步这一块的理解上，如果你懂python的异步，并且也知道你要做的api对并发和速度都有很高的要求，那么就应该选择tornado，否则就选择flask。</p>
<p>比如作为个人爱好去搭建的小网站或者api服务，那么选择flask是很适合的。本文也是作者有时鼓捣个人的小网站慢慢积累的一些东西。</p>
<h2 id="_2">推荐的启动方式</h2>
<p>目前flask推荐的启动方式是通过：</p>
<div class="highlight"><pre><span></span>flask run
</pre></div>
<p>或者</p>
<div class="highlight"><pre><span></span>python -m flask run 
</pre></div>
<p>来启动flask。【这个方式很适合开发和测试，实际部署还是WSGI server来进行】</p>
<p>要正常执行上面的命令，你需要设置好一些环境变量，最主要的是 <code>FLASK_APP</code> 这个变量：</p>
<p>windows </p>
<div class="highlight"><pre><span></span>set FLASK_APP=hello.py
flask run
</pre></div>
<p>linux </p>
<div class="highlight"><pre><span></span>export FLASK_APP=hello.py
flask run
</pre></div>
<p>推荐是通过在当前工作目录下加上 <code>.env</code> 这个文件，里面定义：</p>
<div class="highlight"><pre><span></span>FLASK_APP=myapp.py
FLASK_ENV=development
FLASK_DEBUG=1
</pre></div>
<p>环境变量，在运行 flask 命令的时候会自动加载这些环境变量。【这种加载行为只是针对flask命令，load_dotenv 模块之前该做的还是要做，不受影响。】</p>
<h3 id="flask_debug">FLASK_DEBUG</h3>
<p>如果设置为1则开启flask调试模式：</p>
<ul>
<li>重载器 所有源码文件变动自动重启服务器</li>
<li>调试器 出现异常在浏览器中显示异常信息</li>
</ul>
<p>生产环境一定要把调试模式关闭！</p>
<h3 id="pycharm">pycharm启动</h3>
<p>pycharm现在有专门的flask启动支持，不过也可以继续采用如上描述的启动方式，这样会更加接近服务器那边的部署环境。</p>
<p><img alt="img" src="/images/python_third_party/pycharm_flask.png"/></p>
<p>选择启动python脚本，选择 <code>Module name</code> ，这样就对应 <code>python -m flask</code> 命令的效果，然后加上参数 <code>run</code> ，环境变量如上所示，不用再特别调配了，工作目录设置下即可。</p>
<p>类似的你还可以再加上一个 <code>python -m flask shell</code> 命令。</p>
<h2 id="flask">flask的请求分发</h2>
<p>查看flask当前app的url分发情况</p>
<div class="highlight"><pre><span></span>app.url_map
</pre></div>
<p>默认flask有个额外的路由</p>
<div class="highlight"><pre><span></span>/static/&lt;filename&gt;
</pre></div>
<h2 id="flask_1">flask的请求对象</h2>
<p>request请求对象有：</p>
<ul>
<li>form dict 存储请求的表单字段</li>
<li>args  dict 存储URL上传递的参数</li>
<li>values form和args的合集</li>
<li>cookies dict 存储请求的所有cookies</li>
<li>headers dict 存储http的headers</li>
<li>files dict 存储请求上传的所有文件</li>
<li>get_data 返回请求主体缓冲的数据</li>
<li>get_json return dict 包含解析请求主题后得到的json</li>
<li>blueprint 处理请求的Flask蓝本</li>
<li>endpoint 处理请求的Flask端点名称</li>
<li>method HTTP请求方法</li>
<li>scheme http或https</li>
<li>is_secure 通过HTTPS发送的请求返回True</li>
<li>host  请求主机名</li>
<li>path 请求URL路径</li>
<li>query_string URL查询字符串部分</li>
<li>full_path URL 路径和查询字符串部分</li>
<li>url 完整URL</li>
<li>base_url 同url但没有查询字符串部分</li>
<li>remote_addr 远程IP地址</li>
<li>environ dict 请求原始WSGI环境 </li>
</ul>
<h2 id="flask_2">flask的请求钩子</h2>
<p>请求钩子用装饰器来实现，flask有以下四种钩子：</p>
<ul>
<li>before_request 请求之前执行</li>
<li>before_first_request 只在第一次请求前执行</li>
<li>after_request 每次请求后执行 如果程序没有抛出异常的话</li>
<li>teardown_request 每次请求之后执行，即使抛出异常</li>
</ul>
<p>请求钩子和视图函数之间变量互通一般用上下文全局变量 g ，比如 <code>before_request</code> 处理的时候设置 <code>g.user</code> 为登录用户，后面视图函数可以调用 <code>g.user</code> 来得知当前登录用户。</p>
<h2 id="flask_3">flask的响应对象</h2>
<div class="highlight"><pre><span></span>response = make_response(content, status_code)
response.set_cookie('a',1)
</pre></div>
<p>响应对象有以下属性或方法：</p>
<ul>
<li>status_code</li>
<li>headers</li>
<li>set_cookies 设置cookies</li>
<li>delete_cookies 删除一个cookies</li>
<li>content_length 内容长度</li>
<li>content_type 响应主体的媒体类型</li>
<li>set_data  </li>
<li>get_data</li>
</ul>
<p>特殊的响应： 重定向响应 状态码 302 Location部分写上目标URL flask提供 redirect函数快速生成这个重定向响应对象。</p>
<p>abort函数 其返回的是状态码404 其是抛出异常 </p>
<h2 id="_3">加入错误页面</h2>
<div class="highlight"><pre><span></span>@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'),404
</pre></div>
<p>如果是蓝图的话，要有全局的效果，则应该使用 <code>app_errorhandler</code> ：</p>
<div class="highlight"><pre><span></span><span class="nd">@main.app_errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'404.html'</span><span class="p">),</span> <span class="mi">404</span>
</pre></div>
<h2 id="url_for">url_for</h2>
<div class="highlight"><pre><span></span>url_for('index', _external=True)
</pre></div>
<ol>
<li>名字，</li>
<li>送入一些参数进去</li>
<li><code>_external</code> 绝对路径 ，一般使用相对路径即可，浏览器之外的某些链接一定要使用绝对路径</li>
</ol>
<p>如果是对应蓝图的视图函数，则前面应该加上蓝图名：</p>
<div class="highlight"><pre><span></span>url_for('main.index')
</pre></div>
<h2 id="_4">静态文件</h2>
<div class="highlight"><pre><span></span>url('static', filename='favicon.ico')
</pre></div>
<h2 id="flash">flash消息</h2>
<p>flash消息方便让用户知道一些必要的信息。flash函数可以实现这点。然后模板文件上需要加上：</p>
<div class="highlight"><pre><span></span>    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">get_flashed_messages</span><span class="o">()</span> <span class="cp">%}</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-warning"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/button&gt;</span>
            <span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>
<h2 id="_5">大型应用结构</h2>
<p>请参看参考资料1，即有名的flasky项目的结构。下面简单说一下：</p>
<ol>
<li>
<p>配置开发测试生产分离</p>
</li>
<li>
<p>使用应用工厂函数 <code>create_app</code> 来延迟创建应用。</p>
</li>
<li>
<p>使用蓝图（Blueprint）</p>
</li>
<li>
<p>蓝图模块写法如下：</p>
</li>
</ol>
<p>```python
   from flask import Blueprint</p>
<p>main = Blueprint('main', <strong>name</strong>)</p>
<p>from . import views, errors
   ```</p>
<p>因为views errors模块那边还需要使用蓝图对象main，所以应该放在它的的后面引入进来。</p>
<ul>
<li>蓝图在应用中注册写法如下：</li>
</ul>
<p><code>python
       from .main import main as main_blueprint
       app.register_blueprint(main_blueprint)</code></p>
<ul>
<li>蓝图的错误页面需要使用 <code>app_errorhandler</code> 要注册为全局的错误处理，如果是 <code>errorhandler</code> 则只负责本蓝图内的错误。</li>
</ul>
<p><code>python
   @main.app_errorhandler(404)
   def page_not_found(e):
       return render_template('404.html'), 404</code></p>
<ul>
<li>蓝图内注册的视图函数，用 <code>url_for</code> 来获取的是 <code>main.index</code> 这种形式，即蓝图名加上视图函数名。</li>
</ul>
<h2 id="_6">数据库相关</h2>
<p><code>__tablename__</code> 定义表名，默认的表名没有遵循使用复数命名的约定 like  <code>users</code>  。</p>
<p>这一块东西后面会补充一些，但更多的是sqlalchemy和sql那边的知识。</p>
<h2 id="flask-shell">flask shell命令定制</h2>
<div class="highlight"><pre><span></span><span class="nd">@app.shell_context_processor</span>
<span class="k">def</span> <span class="nf">make_shell_context</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="o">=</span><span class="n">Role</span><span class="p">)</span>
</pre></div>
<p>运行： </p>
<div class="highlight"><pre><span></span>flask shell
</pre></div>
<p>db那些变量是可以正常使用的。</p>
<p>cmd里面要配置好环境变量 <code>export FLASK_APP=hello.py</code> </p>
<h2 id="flask-migrate">flask-migrate</h2>
<p><code>flask-migrate</code> 其基于sqlalchemy 的  alembic ，然后做了一些额外的工作。 主要提供了一些便捷的命令行接口，具体使用还是要熟悉sqlalchemy和alembic。</p>
<p>一个简要的例子如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'sqlite:///app.db'</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>

<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
</pre></div>
<p>新项目首先要运行：</p>
<div class="highlight"><pre><span></span>flask db init
</pre></div>
<p>这对应alembic的 <code>alembic init</code> 命令，其将创建 <code>migrations</code> 文件夹，里面的文件就是alembic需要的，migrations文件夹是推荐和源代码一起加入版本控制的。</p>
<p>和简单的使用的alembic不同，其新建的 <code>env.py</code> 有一些优化，flask的配置环境里只要配置了 <code>SQLALCHEMY_DATABASE_URI</code> 这样变量，alembic就能正确找到数据库了。</p>
<p>然后：</p>
<div class="highlight"><pre><span></span>flask db revision # 对应的是 alembic revison
flask db migrate # 对应的是 alembic revision --autogenerate
flask db upgrade # 对应的是 alembic upgrade
flask db downgrade # 对应的是 alembic downgrade
</pre></div>
<p>一般工作流程：</p>
<ol>
<li>修改数据库模型或者说数据库模型发生了变动</li>
<li><code>flask db migrate</code> 创建迁移脚本</li>
<li>检查自动生成的脚本，改正不正确的地方</li>
<li><code>flask db upgrade</code>  将改动应用到数据库</li>
</ol>
<h3 id="_7">删除无用的迁移脚本</h3>
<p>alembic的自动生成脚本并不是万能的，需要人工审核。而就算没问题的某些迁移脚本，如果你觉得已经毫无意义了，那么将那个版本的迁移脚本删除是没有任何问题的。</p>
<h3 id="_8">彻底从零开始的迁移脚本</h3>
<p>虽然alembic的官方文档觉得没有这个必要，不过我觉得还是很有用的。</p>
<ol>
<li>首先我们在flask应用下加上这样两个命令，负责最开始的创建数据库和根本代码生成表格工作。</li>
<li>表格生成成功之后后面都用flask-migrate 或者说 alembic来管理，经过测试比如在models.py 哪里新加一列，然后利用 <code>flask db migrate</code> 是能够自动检测新加入了一列，从而自动生成的代码会更加精准。</li>
</ol>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy_utils</span> <span class="kn">import</span> <span class="n">database_exists</span><span class="p">,</span> <span class="n">create_database</span><span class="p">,</span> <span class="n">drop_database</span>

<span class="nd">@app.cli.command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">initdb</span><span class="p">():</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'本命令只用于数据库初始化，后续更改请使用alembic来管理，确定请输入 [Y]'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'y'</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">engine</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
            <span class="n">create_database</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'db exists...'</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">alembic.config</span> <span class="kn">import</span> <span class="n">Config</span>
        <span class="kn">from</span> <span class="nn">alembic</span> <span class="kn">import</span> <span class="n">command</span>
        <span class="n">alembic_cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="s1">'migrations/alembic.ini'</span><span class="p">)</span>

        <span class="n">command</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">alembic_cfg</span><span class="p">,</span> <span class="s2">"head"</span><span class="p">)</span>


<span class="nd">@app.cli.command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">dropdb</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    TODO 生产环境不允许调用本命令</span>
<span class="sd">    :return:</span>
<span class="sd">    """</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'警告!!! 本操作将删除数据库，数据将完全丢失，确定请输入： [YYY]'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_input</span> <span class="o">==</span> <span class="s1">'YYY'</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">engine</span>

        <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
            <span class="n">drop_database</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'db not exists...'</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</pre></div>
<h2 id="flask-moment">flask-moment</h2>
<p>Moment JS 送入UTC时间会自动转换成为本地时间，服务器那边的时间戳最好是记录UTC时间。用户则应该看到本地时间。</p>
<div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">scripts</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span> <span class="nb">super</span><span class="o">()</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">moment.include_moment</span><span class="o">()</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">moment.lang</span><span class="o">(</span><span class="s2">"zh-cn"</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
<p>在模板上使用：</p>
<div class="highlight"><pre><span></span>    <span class="nt">&lt;p&gt;</span>当前时间是： <span class="cp">{{</span> <span class="nv">moment</span><span class="o">(</span><span class="nv">current_time</span><span class="o">)</span><span class="nv">.format</span><span class="o">(</span><span class="s1">'LLLL'</span><span class="o">)</span> <span class="cp">}}</span>.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">moment</span><span class="o">(</span><span class="nv">current_time</span><span class="o">)</span><span class="nv">.fromNow</span><span class="o">(</span><span class="nv">refresh</span><span class="o">=</span><span class="kp">True</span><span class="o">)</span> <span class="cp">}}</span>刷新过.<span class="nt">&lt;/p&gt;</span>
</pre></div>
<p>具体格式请参看 <a href="http://momentjs.cn/">MomentJs 官网</a> 。</p>
<h2 id="flask-wtf">flask-wtf</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">SubmitField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'hard to guess string'</span>

<span class="k">class</span> <span class="nc">NameForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">'请输入您的名字？'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s1">'提交'</span><span class="p">)</span>
</pre></div>
<p>WTForms支持的HTML字段</p>
<ul>
<li>BooleanField 复选框</li>
<li>DateField 文本字段 for datetime.date</li>
<li>DateTimeField 文本字段 for datetime.datetime</li>
<li>DecimalField 文本字段 for  decimal.Decimal</li>
<li>FileField 文件上传字段</li>
<li>HiddenField 隐藏文本字段</li>
<li>FieldList 一组指定类型的字段</li>
<li>FloatField 文本字段 for float</li>
<li>FormField 把一个表单作为字段嵌入另一个表单</li>
<li>IntegerField 文本字段 for integer</li>
<li>PasswordField 密码文本字段</li>
<li>RadioField 单选按钮</li>
<li>SelectField 下拉列表</li>
<li>SelectmultipleField 下拉多选列表</li>
<li>SubmitField 表单提交按钮</li>
<li>StringField 文本字段</li>
<li>TextAreaField 多行文本字段</li>
</ul>
<p>WTForms提供的验证函数</p>
<ul>
<li>DataRequired 确保类型转换后字段有数据</li>
<li>Email 验证电子邮箱</li>
<li>EqualTo 比较两个字段的值 常用于比较两次密码是否输入一致</li>
<li>InputRequired 确保类型转换前字段有数据</li>
<li>IPAddress 验证IPv4地址</li>
<li>Length 长度验证</li>
<li>MacAddress 验证MAC地址</li>
<li>NumberRange 数字范围校验</li>
<li>Optional 允许字段没有输入，将跳过其他校验函数</li>
<li>Regexp 正则表达式校验</li>
<li>URL URL校验</li>
<li>UUID UUID校验</li>
<li>AnyOf 输入值在任一可能值中</li>
<li>NoneOf 输入值不在一组可能值中</li>
</ul>
<h3 id="_9">表单提交模式</h3>
<p>一般表单提交模式是 POST 重定向到本视图函数 GET ，POST操作需要保存用户的一些信息则修改session中的值。</p>
<h2 id="flask-mail">flask-mail</h2>
<p>flask-mail</p>
<h2 id="flask-login">flask-login</h2>
<p>flask-login引入进来之后 所有的jinja2模块都支持 <code>current_user</code> 这个变量了。</p>
<h2 id="_10">参考资料</h2>
<ol>
<li>Flask Web 开发第二版 米格尔·格林贝格著 安道译</li>
</ol>
            
            
            <hr/>

        </div>
        <section>
        <div class="col-md-2" style="float:right;font-size:0.9em;">
            <h4>首发于：</h4>
            <time pubdate="pubdate" datetime="2019-01-03T00:00:00+08:00">2019年 1月 3日 </time>

<h4>最近更新于：</h4>
<time datetime="2019-07-22T00:00:00+08:00">2019年 7月 22日 </time>

            <h4>分类：</h4>
            <a class="category-link" href="/categories.html#pythonhao-huo-ban-ref">python好伙伴</a>
            <h4>标签：</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#flask-ref">flask
                    <span>2</span>
</a></li>
            </ul>
        </div>
        </section>
</div>
</article>
    </div>
    <div class="col-md-1"></div>

</div>


<div id="push"></div>


<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a> and updated by <a href="http://www.cdwanze.work" title="cdwanze Home Page">cdwanze</a></li>
    </ul>
</div>
</footer>

    <script src="/theme/js/jquery.min.js"></script>
<script src="/theme/js/bootstrap.min.js"></script>
<script>
    function validateForm(query) {
        return (query.length > 0);
    }
</script>


    



</body>
</html>