<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="baidu-site-verification" content="D4VqC4HppC"/>
    <meta name="msvalidate.01" content="55CB117A61A6F8286173763FB18D9625"/>

        <meta name="author" content="cdwanze"/>
        <meta name="copyright" content="cdwanze"/>

        <meta property="og:type" content="article"/>
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="protocol, 物联网, " />

<meta property="og:title" content="SIP协议学习笔记 "/>
<meta property="og:url" content="https://docs.cdwanze.work/articles/SIP-learning-note.html" />
<meta property="og:description" content="前言 SIP协议算是物联网的核心底层基础了，网上有一份关于SIP协议RFC3261的中文翻译版本了，只是翻译质量实在堪忧。本文对于协议的一些核心内容会重新翻译。然后会阅读一些基本的入门教程，然后结合阅读 《SIP Understanding Session Initiation Protocol》这本书籍来对SIP协议做更深入的了解。 有关协议实际内容部分，我会关注最前面的通俗理解部分，但关于协议的具体细节和内容，我的建议还是阅读原英文文档，没有一家翻译是完美的。本文随着作者的学习会继续对SIP协议做深入的学习介绍，只是不敢保证是大而全的。 1. SIP协议介绍 Internet的许多应用都需要建立和管理一个会话，会话在这里的含义是在参与者之间的数据的交换。由于考虑到参与者的实际情况，这些应用的实现往往是很复杂的：用户可能在终端移动，他们可能有多个名字，他们可能使用不同的媒介（比如文本，多媒体，视频，音频等）——有时候都使用。人们创造了很多不同的通讯协议用来携带哪些实时的多媒体会话数据，比如声音，影像，或者文本。本SIP（会话初始协议）和这些协议是合作关系，SIP协议让网络终端（叫做用户代理UserAgent UA）发现彼此并同意哪些他们愿意分享的会话细节。为了能够定位预定的会话参与者，和其他目的，SIP要创建一些网络主机基础设施（叫做代理服务器），通过这些代理服务器 …" />
<meta property="og:site_name" content="cdwanze的博文" />
<meta property="og:article:author" content="cdwanze" />
<meta property="og:article:published_time" content="2019-08-30T00:00:00+08:00" />
<meta property="" content="2019-08-30T00:00:00+08:00" />
<meta name="twitter:title" content="SIP协议学习笔记 ">
<meta name="twitter:description" content="前言 SIP协议算是物联网的核心底层基础了，网上有一份关于SIP协议RFC3261的中文翻译版本了，只是翻译质量实在堪忧。本文对于协议的一些核心内容会重新翻译。然后会阅读一些基本的入门教程，然后结合阅读 《SIP Understanding Session Initiation Protocol》这本书籍来对SIP协议做更深入的了解。 有关协议实际内容部分，我会关注最前面的通俗理解部分，但关于协议的具体细节和内容，我的建议还是阅读原英文文档，没有一家翻译是完美的。本文随着作者的学习会继续对SIP协议做深入的学习介绍，只是不敢保证是大而全的。 1. SIP协议介绍 Internet的许多应用都需要建立和管理一个会话，会话在这里的含义是在参与者之间的数据的交换。由于考虑到参与者的实际情况，这些应用的实现往往是很复杂的：用户可能在终端移动，他们可能有多个名字，他们可能使用不同的媒介（比如文本，多媒体，视频，音频等）——有时候都使用。人们创造了很多不同的通讯协议用来携带哪些实时的多媒体会话数据，比如声音，影像，或者文本。本SIP（会话初始协议）和这些协议是合作关系，SIP协议让网络终端（叫做用户代理UserAgent UA）发现彼此并同意哪些他们愿意分享的会话细节。为了能够定位预定的会话参与者，和其他目的，SIP要创建一些网络主机基础设施（叫做代理服务器），通过这些代理服务器 …">

    <title>
SIP协议学习笔记  · cdwanze的博文
</title>


        <link href="https://docs.cdwanze.work/theme/css/font-awesome.css" rel="stylesheet"
              media="screen">
        <link href="https://docs.cdwanze.work/theme/css/bootstrap.min.css" rel="stylesheet"
              media="screen">

            <link rel="stylesheet" type="text/css"
                  href="https://docs.cdwanze.work/theme/css/pygments.css" media="screen">
            <link rel="stylesheet" type="text/css"
                  href="https://docs.cdwanze.work/theme/css/elegant.css" media="screen">
            <link rel="stylesheet" type="text/css"
                  href="https://docs.cdwanze.work/theme/css/custom.css" media="screen">






</head>
<body>

<nav class="navbar">
    <div class="navbar navbar-default" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target=".navbar-collapse"
                    aria-expanded="false">
                <span class="sr-only">Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a class="navbar-brand" href="https://www.cdwanze.work"><span
                    class=site-name>网站首页</span></a>
        </div>


        <div class="navbar-collapse collapse">
            <form action="https://docs.cdwanze.work/search.html"
                  onsubmit="return validateForm(this.elements['q'].value);"
                  class="navbar-form navbar-left">
                <div class="form-group">
                    <input type="text" name="q" id="tipue_search_input"
                           class="form-control" placeholder="Search..."
                           style="width:430px;">
                </div>
                <button class="btn btn-default" type="submit">搜索</button>
            </form>


            <ul class="nav navbar-nav nav-pills navbar-right">
                <li >
                    <a href="https://docs.cdwanze.work">博文首页</a></li>

                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle"
                           data-toggle="dropdown" role="button"
                           aria-haspopup="true" aria-expanded="false">查找文章<span
                                class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a class="slowscroll" href="/categories.html">按分类</a>
                            </li>
                            <li><a class="slowscroll" href="/tags.html">按标签</a>
                            </li>
                        </ul>
                    </li>


                        <li >
                            <a href="https://docs.cdwanze.work/guan-yu-ben-wang-zhan.html">关于本网站</a>
                        </li>
                        <li >
                            <a href="https://docs.cdwanze.work/gong-gao.html">公告</a>
                        </li>
            </ul>


        </div>
    </div>
</nav>


<div class="container-fluid">
    <div class="col-md-1 col-md-1-left"></div>
    <div class="col-md-10">
<article>
<div class="row">
    <header class="page-header col-md-10 col-md-offset-2">
    <h1><a href="https://docs.cdwanze.work/articles/SIP-learning-note.html"> SIP协议学习笔记  </a></h1>
    </header>
</div>

<div class="row">
    <div class="col-md-2 table-of-content">
        <nav>
        <h4>目录</h4>
        <div class="toc">
<ul>
<li><a href="#_1">前言</a></li>
<li><a href="#1-sip">1. SIP协议介绍</a></li>
<li><a href="#2-sip">2. SIP协议功能概况</a></li>
<li><a href="#4-sip">4. SIP操作概览</a></li>
<li><a href="#5-sip">5. SIP协议的结构</a></li>
<li><a href="#6">6. 术语解释</a></li>
<li><a href="#7-sip">7. SIP消息</a></li>
<li><a href="#8-user-agent">8. 一般User Agent行为</a></li>
<li><a href="#12-dialogs">12. Dialogs</a></li>
<li><a href="#17-transcations">17. Transcations</a></li>
<li><a href="#18-transport">18. Transport</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="col-md-8 article-content">

            
            
<h2 id="_1">前言</h2>
<p>SIP协议算是物联网的核心底层基础了，网上有一份关于SIP协议RFC3261的中文翻译版本了，只是翻译质量实在堪忧。本文对于协议的一些核心内容会重新翻译。然后会阅读一些基本的入门教程，然后结合阅读 《SIP Understanding Session Initiation Protocol》这本书籍来对SIP协议做更深入的了解。</p>
<p>有关协议实际内容部分，我会关注最前面的通俗理解部分，但关于协议的具体细节和内容，我的建议还是阅读原英文文档，没有一家翻译是完美的。本文随着作者的学习会继续对SIP协议做深入的学习介绍，只是不敢保证是大而全的。</p>
<h2 id="1-sip">1. SIP协议介绍</h2>
<p>Internet的许多应用都需要建立和管理一个会话，会话在这里的含义是在参与者之间的数据的交换。由于考虑到参与者的实际情况，这些应用的实现往往是很复杂的：用户可能在终端移动，他们可能有多个名字，他们可能使用不同的媒介（比如文本，多媒体，视频，音频等）——有时候都使用。人们创造了很多不同的通讯协议用来携带哪些实时的多媒体会话数据，比如声音，影像，或者文本。本SIP（会话初始协议）和这些协议是合作关系，SIP协议让网络终端（叫做用户代理UserAgent UA）发现彼此并同意哪些他们愿意分享的会话细节。为了能够定位预定的会话参与者，和其他目的，SIP要创建一些网络主机基础设施（叫做代理服务器），通过这些代理服务器，UA能够发送注册、邀请信息到会话中，当然也包括其他请求。SIP是一个轻量级的，多用途的工具，可以用来创建，修改和终止会话，它独立运作于通讯协议之下，不依赖于正要建立的会话类型。</p>
<h2 id="2-sip">2. SIP协议功能概况</h2>
<p>SIP是一个应用层的控制协议，可以用来建立、修改、和终止多媒体会话（或者会议）例如Internet 电话。SIP也可以邀请参与者参加已经存在的会话，比如多方会议。媒体也可以从一个已经存在的会话中添加进来（或删除）。SIP显然也支持名字映射和重定向服务，这个可用于支持个人便携式设备－用户可以对外维护一个唯一的外部标志而不用考虑他们的实际网络地点。</p>
<p>SIP建立和终止多媒体交流，有以下五个方面上的支持：</p>
<p><strong>用户定位</strong>： 检查终端用户的位置，用于通讯。</p>
<p><strong>用户有效性</strong>：检查用户参与会话的意愿程度。</p>
<p><strong>用户能力</strong>：检查媒体和媒体的参数。</p>
<p><strong>建立会话</strong>：”ringing”, 响铃 确立会话参数在呼叫方和被叫方。</p>
<p><strong>会话管理</strong>：包括发送和终止会话，修改会话参数，激活服务等等。</p>
<p>SIP不是要做一个垂直集成的通讯系统。SIP更宁愿做一个组件，可以被其他IETF协议锁使用来构造一个完整的多媒体架构。更具体一点来说，这些协议包括实时数据传输协议（RTP）（RFC 1889）用来传输实时的数据并且提供QoS反馈，实时流协议（RSTP）(RFC 2326)用于控制流媒体的的传输，媒体网关控制协议（MEGACO）(RFC 3015)用来控制到公共电话交换网（PSTN）的网关，还有会话描述协议（SDP）（RFC 2327）用于描述多媒体会话。因此，SIP应该和其他的协议一起工作，才能对终端用户的提供完整的服务。然而SIP协议的基本功能和操作是不依赖这些协议的。</p>
<p>SIP本身并不提供服务，而是提供了一个基础来实现不同的服务。比如，SIP可以定位用户和传输一个封装好的对象到对方的当前位置且如果我们利用这点来通过SDP传输会话的描述，立刻，对方的用户代理可以得到这个会话的参数。如果我们用这个像传输会话描述（SESSION DESCRIPTION SD）一样传输呼叫方的照片，一个”呼叫ID”服务很容易就建立了。这个简单的例子说明了，SIP作为一个基础，可以在其上提供很多不同的服务。</p>
<p>SIP并不提供会议控制服务（比如议席控制或者投票系统），并且并没有建议会议应该那样管理。可以通过在SIP上建立其他的会议控制协议来发起一个会议。由于SIP可以管理参与会议的各方的会话，所以会议可以跨异构的网络，SIP 并不能，也不打算提供任何形式的网络资源预定能力。</p>
<p>安全对于提供的服务来说特别重要。要达到理想的安全程度，SIP提供了一套安全服务，包括防止拒绝服务，认证服务（用户到用户，代理到用户），完整性保证，加密和隐私服务。</p>
<p>SIP可以基于IPV4也可以基于IPV6</p>
<h2 id="4-sip">4. SIP操作概览</h2>
<p>本小节摘自SIP协议，用一个简单的例子介绍了SIP协议的一些基本操作，采用的是tutorial风格而不是那种正式的晦涩难懂的风格，还是值得好好读一下的。</p>
<p>第一个例子演示了SIP的基本功能：寻址一个终端，发送一个意欲交流的信号，协商等下要建立会话的一些会话参数和终止一个已经建立的会话。</p>
<p>下面是一个典型的例子，演示了Alice和bob这两个用户是如何交换SIP信息的。</p>
<div class="highlight"><pre><span></span>            atlanta.com . . .  biloxi.com
          .     proxy            proxy       .          
     .                                           .
  Alice’s . . . . . . . . . . . . . . . . . . . .  Bob’s
 softphone                                       SIP Phone
 |                |                |                |
 | INVITE F1      |                |                |
 |---------------&gt;| INVITE F2      |                |
 | 100 Trying F3  |---------------&gt;| INVITE F4      |
 |&lt;---------------| 100 Trying F5  |---------------&gt;|
 |                |&lt;-------------- | 180 Ringing F6 |
 |                | 180 Ringing F7 |&lt;---------------|
 | 180 Ringing F8 |&lt;---------------| 200 OK F9      |
 |&lt;---------------| 200 OK F10     |&lt;---------------|
 | 200 OK F11     |&lt;---------------|                |
 |&lt;---------------|                |                |
 |                         ACK F12                  |
 |-------------------------------------------------&gt;|
 |                     Media Session                |
 |&lt;================================================&gt;|
 |                         BYE F13                  |
 |&lt;-------------------------------------------------|
 |                      200 OK F14                  |
 |-------------------------------------------------&gt;|
 |                                                  |
</pre></div>
<p>在这个例子中，Alice在PC上使用的他的SIP应用（软体电话softphone）通过互联网去呼叫Bob的SIP phone。同时这个例子还演示了两个SIP代理服务，他们代表Alice和bob来帮助他们建立会话连接。这种典型的安排用专业术语来说就是“SIP trapezoid” （SIP梯形），就是上图的那个带点虚线的几何形状。</p>
<p>Alice呼叫Bob用的是他的SIP标识，一种Uniform Resource Identifier URI ，叫做SIP URI。SIP URI的具体定义在本memo的19.1小节。它和电子邮箱地址有相似的结构，一般会包含用户名和主机名。比如上面这个例子，就是 <code>sip:bob@biloxi.com</code> ，<code>biloxi.com</code> 是Bob的SIP 服务提供者的域名。Alice的SIP URI是 <code>sip:alice@atlanta.com</code> 。Alice可能已经输入了Bob的URI，或者点击了某个超链接，或者点击了某个地址本的入口。SIP当然也提供了加密URI，叫做SIPS URI，比如： <code>sips:bob@biloxi.com</code> 。基于SIPS URI 的呼叫要保证是安全的，信道加密的（即TLS）来用户传输所有SIP信息从呼叫者到某个域名下的被呼叫者。这样，请求安全地发送给了被呼叫者，不过这种安全机制还依赖于被呼叫者的域名策略。</p>
<p>SIP是有点类似于HTTP的那种请求/响应事务模型。每一个事务都包含一个请求（调用了具体某个方法或者说函数）和至少一个服务器那边的响应。在上面这个例子中，事务开始于Alice的软件电话发送了一个INVITE请求到Bob的SIP URI的地址哪里，INVITE这个SIP方法具体来说就是，请求者Alice希望服务器Bob接受自己。INVITE请求一系列的头部字段，头部字段是一些命名了的属性，关于本信息提供了一些额外的信息。比如说一个INVITE请求那里包含一个关于本次call的唯一标识id，目标地地址，Alice的地址和Alice希望与Bob建立会话的类型信息。INVITE信息对应上图的F1可能看起来是这个样子：</p>
<div class="highlight"><pre><span></span> INVITE sip:bob@biloxi.com SIP/2.0
 Via: SIP/2.0/UDP pc33.atlanta.com;branch=z9hG4bK776asdhds
 Max-Forwards: 70
 To: Bob &lt;sip:bob@biloxi.com&gt;
 From: Alice &lt;sip:alice@atlanta.com&gt;;tag=1928301774
 Call-ID: a84b4c76e66710@pc33.atlanta.com
 CSeq: 314159 INVITE
 Contact: &lt;sip:alice@pc33.atlanta.com&gt;
 Content-Type: application/sdp
 Content-Length: 142
</pre></div>
<p>第一行文本加密信息包含了方法名，下面的行是一系列的头部字段。上面这个例子是最小的需求集了，头部字段简要描述如下：</p>
<ul>
<li>Via 包含一个地址（pc33.atlanta.com）是Alice希望从哪里接受到本请求的响应。然后它还含有一个branch参数来标记了具体本次交互。</li>
<li>To 包含了一个显示名字（Bob）和一个SIP或者SIPS URI（sip:bob@biloxi.com），也就是本次请求的原始目的地。显示名字在RFC 2822中讨论了。</li>
<li>From 也包含了一个显示名字（Alice）和一个SIP或者SIPS URI  (sip:alice@atlanta.com)  ，说明了本次请求的原始起点。后面的header field还有个tag参数，包含一串随机字符串，这是Alice的软体电话加上去的，它被用作标记目的。</li>
<li>Call-ID 包含了用于本次call的一个全局唯一的id标识，由一个随机字符串和软体电话的主机名或者IP地址组成。这种To tag ，From tag和Call-ID的组合定义了SIP中的一种点对点的关系，称作Alice和Bob之间的会话dialog。</li>
<li>CSeq 或者 Command Sequence 包含一个整数值和方法名。CSeq的数值在dialog会话中没有一次新的请求就会增加，这是一个传统的序列数值。</li>
<li>
<p>Contact 包含了一个SIP或者SIPS URI，这表示了要联系Alice的直接方式。通常是由用户名和完整合格域名（FQDN fully qualified domain name）组成。推荐是用FQDN，很多终端系统没有注册域名，所以IP地址也是允许的。Via 头部字段是告诉其他人该往那里发送响应，而Contact 头部字段是告诉其他人那里发送将来的请求。【一个是响应，服务器的常规响应动作；一个是请求，服务器的某些请求动作】</p>
</li>
<li>
<p>Max-Forwards 最大跳跃次数 </p>
</li>
<li>Content-Type </li>
<li>Content-Length</li>
</ul>
<p>SIP的完整头部字段描述信息在本memo的第20小节。</p>
<p>具体会话session的细节，比如说媒体的类型，编码或者取样率，并不是在SIP哪里定义的。而是SIP信息的body本身包含了本会话的描述，具体是以其他的协议的格式来编写的。比如SDP协议，RFC2327，上面的示例中本没有说明，就是被SIP信息携带着的。这可以类比于电子邮箱信息或者web page网页内容被HTTP信息携带着。</p>
<p>因为软体电话不知道Bob的位置或者 biloxi.com 域名SIP服务器的位置，所以软体电话就发送INVITE给SIP服务器，其服务于 Alice 域名，atlanta.com。atlanta.com上的SIP服务器地址可以在Alice的软体电话上配置，或者可以被DHCP发现。</p>
<p>atlanta.com 上的SIP 服务器是一种称为代理服务的SIP 服务器。代理服务器接受SIP 请求然后代表各个请求者去向前分发它们。在上面的例子中，代理服务器接受了INVITE请求，然后回传了一个100（Trying）的响应给Alice的软体电话。100（Tring）响应的意思是INVITE请求已经接受到了，代理正在忙着代表它们去将INVITE请求分发到目的地。SIP 的响应使用三位的数字码，然后后面跟着一段描述文字。响应也包含 From 、To、Call-ID、CSeq和Via（其内的branch参数也一样）——这将使得Alice的软体电话将这个响应和之前发送的INVITE请求相关联。atlanta.com 上的代理服务器定位biloxi.com上的代理服务器，可能通过一系列的DNS查找操作然后找到了biloxi.com域名上的代理服务器。然后，它获取了biloxi.com代理服务器的IP地址，继续向前或者说代理这个INVITE请求到了那儿。在向前发送请求之前，atlanta.com代理服务器会加上一个额外Via头字段 ，其值记录的是本代理服务器的地址（这个INVITE请求已经包含Alice的地址了，在第一个Via那里）。biloxi.com 代理服务器接受这个INVITE请求之后，先响应100（Trying）给atlanta.com代理服务器，说INVITE信息已接受，正在处理中。这个代理服务器会查询数据库，一般叫做寻址服务，里面包含了Bob现在的IP地址。（后面章节我们会看到这个数据库该怎么样填充）biloxi.com代理服务器增加了另外一个Via 头字段，其值是把他自己的IP地址，然后将INVITE请求发送给Bob的SIP电话。</p>
<p>Bob的SIP电话在接受INVITE请求之后，会通知Bob Alice打电话过来了，好让Bob决定是否接听这个Call，也就是Bob的电话响了。Bob的SIP 电话会发送180响应（Ringing）给那两个代理，也就是直接反向返回。每个代理使用Via头字段来决定去向哪里发送响应，然后把顶部它自己的值删除【这里多个Via构成了一种类堆栈结构，取自己的，下面的是要返回的目的地。】。这样，尽管DNS和寻址服务查找在INVITE请求初始化时候是需要的，而180响应到调用者是不需要寻址或者在代理服务器中保持某种状态。此外还有好处，那就是每个代理看到INVITE请求也同样能够看到相应的响应。</p>
<p>当Alice的软体电话接受到180响应时，它会给Alice发送一个消息，或者用一个呼叫返回ringback的音频或者在Alice的屏幕上显示什么信息。</p>
<p>在这个例子中，Bob决定接听这个电话。当他拿起电话听筒，一个200响应就会发出来，表示电话已经接听了。200响应包含了一个信息体，里面有SDP媒体描述信息，是关于这次Bob愿意和Alice之间的建立的会话类型的。作为结果，这里将会有两种SDP消息交换，一种是Alice发送给Bob的，一种是Bob发送给Alice的。这两种消息交换提供了基本的协商能力，它基于简单的SDP提议/回答模型。如果Bob不想接听这个电话，或者正在忙于接听另外一个电话，一个error错误响应将会发送而不是响应正常200，这样将会导致没有媒体会话建立。SIP完整的响应码介绍在第21节。一个200响应可能看起来如下所示，看起来像是Bob发送的：</p>
<div class="highlight"><pre><span></span> Bob sends it out:
 SIP/2.0 200 OK
 Via: SIP/2.0/UDP server10.biloxi.com
 ;branch=z9hG4bKnashds8;received=192.0.2.3
 Via: SIP/2.0/UDP bigbox3.site3.atlanta.com
 ;branch=z9hG4bK77ef4c2312983.1;received=192.0.2.2
 Via: SIP/2.0/UDP pc33.atlanta.com
 ;branch=z9hG4bK776asdhds ;received=192.0.2.1
 To: Bob &lt;sip:bob@biloxi.com&gt;;tag=a6c85cf
 From: Alice &lt;sip:alice@atlanta.com&gt;;tag=1928301774
 Call-ID: a84b4c76e66710@pc33.atlanta.com
 CSeq: 314159 INVITE
 Contact: &lt;sip:bob@192.0.2.4&gt;
 Content-Type: application/sdp
 Content-Length: 131
 (Bob’s SDP not shown)
</pre></div>
<p>第一行包含了响应的状态码（200），然后是原因（OK）。剩下来的行就是头字段域，Via 、To、From、Call-ID和CSeq头字段是直接从INVITE请求上复制的。（这里有三个Via头字段，一个是Alice的软体电话添加的，一个是atlanta.com代理服务器添加的，一个是biloxi.com代理服务器添加的。）Bob的SIP电话在To头字段那里添加了一个tag参数，这个tag将会把两个终端合并为一个dialog对话，这个对话包含所有将来在这个call里面的所有请求和响应。Contact头字段包含URI，Bob可以直接通过这个值来联系。Content-Type和Content-Lenght是说信息体的情况，这里信息体包含了Bob的媒体的SDP信息。</p>
<p>作为上面例子关于DNS和寻址服务的补充，代理服务器可以灵活地“路由决策”，来决定那儿去发送请求。比如说，如果Bob的SIP电话返回了486（Busy here）响应，biloxi.com代理服务器可以将这个INVITE请求代理到Bob的语音信箱服务器哪里。一个代理服务器当然也能够同一时间发送INVITE到多个地址。这种类型的平行搜索叫做forking。</p>
<p>在上面的例子中，200（OK）在两个代理间原路返回，然后被Alice的软体电话接收。这时软体电话就停止ringback音频，然后显示本次拨号已经被接听了。终于，Alice的软体电话发送了一个确认信息，ACK，到Bob的SIP电话哪里已确认接收到了最终回应信号200。在本例中，ACK信号是直接从Alice的软体电话发送到Bob的SIP电话的，绕开了两个代理。这发生了是因为两个终端已经知道彼此的地址了，从Contact头字段上获知的，通过INVITE/200这个信息交换，而这个在INVITEE初始化之前是不知道的。在两个代理上的查找已经不需要了，所以代理们就从本次呼叫流中舍弃了。这完成INVITE/200/ACK 三次握手就是用来建立SIP会话的。更详细的细节在第13节。</p>
<p>Alice的Bob的媒体会话现在开始了，他们发送媒体包使用的是他们之前通过SDP交换同意的格式。一般来说，端对端的媒体包会选用和SIP信令不同的路径。</p>
<p>在本次会话中，不管是Alice还是Bob都可能决定改变本次媒体会话的属性。这通过re-INVITE包含新的媒体描述来完成。re-INVITE在已经存在的对话中，所以其他party知道该修改现有的会话而不是新建一个会话。其他party发送了200同意更改，请求者对200回应了ACK。如果其他party不同意更改，它会发送一个错误响应比如488（Not Accepable Here），这也会受到一个ACK。然后失败的re-INVITE不会导致已经存在的呼叫失败——该会话继续只用之前协商的属性。更多关于会话修改的细节在第14节。</p>
<p>本次呼叫结束，Bob断开了连接，然后产生了一个 BYE 信息。这个 BYE 会直接发送给Alice的软体电话，同样绕开了代理们。Alice确认接收BYE发送了200响应，这将终止本次会话和本次BYE的交互。没有ACK发送，ACK只是作为INVITE请求中对于一个响应的响应而发送。INVITE之所以这样处理的原因等下再讨论，这和SIP的可靠性机制相关，它能接听电话的时间相关和forking相关。因为这些原因，INVITE方法，不同于其他方法，更多关于会话终止的细节在第15节讨论。</p>
<p>第24.2小节描述了本例中的信息的具体细节。</p>
<p>在某些情况下，这对代理们来说可能有用，在SIP信令传输路径中，在会话期间看到终端们之间的所有信息。比如说如果 biloxi.com 代理服务器希望继续存在于SIP信令路径中，越过INVITE的初始化过程。它将在INVITE请求上添加一个要求分发头字段，叫做Record-Route，该头字段包含的URI是本代理的主机名或IP地址。该信息将会被Bob的SIP电话接收（因为Record-Route头字段在200响应中传回去了），然后该信息在本dialog对话期间被Alice的软体电话存储起来。biloxi.com代理服务将会接收然后代理ACK、BYE和对BYE的200（OK）响应。每个代理独立决定去接收后续信息，那些信息将会经过那些选择接收的那些代理。代理使用这个功能通常用于提供mid-call中间人呼叫功能。</p>
<p>注册是SIP协议的另外一个常见的操作。注册是一种方法可以让biloxi.com服务器知道目前Bob的地址。在初始化的时候，Bob的SIP电话会周期性的发送REGISTER信息到biloxi.com的服务器哪里，人们称之为SIP registrar，SIP注册器。REGISTER信息会将Bob的SIP或SIPS URI（sip:bob@biloxi.com）和他当前已经登录进去的机器（是作为一个SIP或SIPS值在Contact头字段哪里传达的）联系起来。注册器在写这种联系，也叫做绑定，到数据库中，叫做寻址服务。这个寻址服务也可被作为biloxi.com域的代理服务。通常，一个域名的注册服务器和该域名的代理服务器是在一起的，SIP服务器的各种不同类型更多是一种逻辑上的区分，而不是物理上的，这点很重要。</p>
<h2 id="5-sip">5. SIP协议的结构</h2>
<p>TODO</p>
<h2 id="6">6. 术语解释</h2>
<p>TODO</p>
<h2 id="7-sip">7. SIP消息</h2>
<p>【TODO】</p>
<h2 id="8-user-agent">8. 一般User Agent行为</h2>
<p>一个user agent代表了一个终端系统。它包含user agent client (UAC)，这产生请求，和一个user agent server，这响应请求。一个UAC能够产生请求基于一些外部刺激（用户点击按钮或者PSTN行的信号）然后处理响应。一个UAS能够接收请求然后产生响应基于用户的输入，外部刺激，程序的执行结果或者其他机制。</p>
<p>当一个UAC发送请求，请求通过一些代理服务器，这将把请求转发到UAS。当UAS产生了一个响应，响应也会转发到达UAC。</p>
<h2 id="12-dialogs">12. Dialogs</h2>
<p>dialog对话对于user agent 来说是一个很关键的概念，一个对话表达了某个时间内两个user agent之间的端对端的SIP关系。对话帮助排列两个user agent消息顺序，然后是正确的分发他们之间的请求。对话表达的是一种上下文来解释SIP的各个消息。</p>
<h2 id="17-transcations">17. Transcations</h2>
<p>SIP 是一个事务处理型协议：各个组件之间的交互发生在一系列的独立的信息交换上。更具体来说，一个SIP Transcation 由一个请求和该请求的任何响应组成，这可能包含零个或更多的临时响应和一个或更多的最终响应。就以一个INVITE请求的事务例子来说（即所谓的INVITE事务），该事务也是包含ACK的，只要最终响应不是2xx。如果响应是2xx的话，ACK会认为不是该事务的一部分。</p>
<p>之所以这样区分是基于传输200响应给发送INVITE的UAC是很重要的。把他们都传输给UAC，UAS这边要负责重发他们（第13.3.1.4小节），UAC这边要负责用ACK来确认他们。（第13.2.2.4小节）因为这个ACK只被UAC转发，所以认为这是属于他自己的事务是很有效的。</p>
<p>事务一边是client，另一边是server。client那边被称之为client transaction，server那边被称之为server transaction。client transaction发送请求，server transaction发送响应。client和server transaction都是逻辑函数嵌入到很多元素中。更确切的，他们存在于user agent和stateful代理服务器哪里。考虑第4节的例子，在这个例子中，UAC执行了client 事务，它的outbound proxy 出站代理执行了server事务。出站代理也执行了client事务，因为它发送了请求到入站代理哪里。入站代理哪里也执行了client事务，因为它发送了请求到UAS哪里。具体如下图所示：</p>
<p><img alt="Jietu20190903-182208" src="/Users/beixi/Desktop/Jietu20190903-182208.jpg"/></p>
<p>无状态代理不含client事务和server事务，事务存在于UA或一边的有状态代理和UA或另一边的有状态代理之间。就SIP事务层面上的考虑，无状态代理可以认为是完全透明的。client事务的目的就是接受某个元素上的请求，client事务就封装在该元素上（该元素被称为事务用户 TU，它可以是个UA或者状态代理），然后就是可靠地将请求传输给server事务。</p>
<h2 id="18-transport">18. Transport</h2>
<p>传输层负责在网络传输层上实际的传输请求和响应。这包括决定请求和响应的连接的使用，在定向连接传输层中。</p>
<p>传输层负责管理像TCP和SCTP或者TLS在这些协议之上的传输协议的持久连接，也包括哪些被传输层打开的连接。这包括client的Transport和server的Transport打开的连接，所以连接是被client和server传输函数分享的。这些连接按照一个address，port和连接最远端的传输层协议组成的tuple进行索引。当一个连接被传输层打开，索引就设为目标的IP和端口号还有transport。当连接被传输层接受，索引就设为源IP地址，端口号和transport。注意，因为源端口号经常是短暂的，而它也不能被知道它是否是短暂的还是被进程选择的，被传输层接受的连接经常是不复用的。结果就是两个代理在一个peering（端对端）关系中使用的定向传输将会有两个连接在使用，每个都是一个事务初始化在不同的方向。</p>
            
            
            <hr/>

        </div>
        <section>
        <div class="col-md-2" style="float:right;font-size:0.9em;">
            <h4>首发于：</h4>
            <time pubdate="pubdate" datetime="2019-08-30T00:00:00+08:00">2019年 8月 30日 </time>

<h4>最近更新于：</h4>
<time datetime="2019-08-30T00:00:00+08:00">2019年 8月 30日 </time>

            <h4>分类：</h4>
            <a class="category-link" href="https://docs.cdwanze.work/categories.html#wu-lian-wang-ref">物联网</a>
            <h4>标签：</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://docs.cdwanze.work/tags.html#protocol-ref">protocol
                    <span>3</span>
</a></li>
            </ul>
        </div>
        </section>
</div>
</article>
    </div>
    <div class="col-md-1"></div>

</div>


<div id="push"></div>


<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a> and updated by <a href="http://www.cdwanze.work" title="cdwanze Home Page">cdwanze</a></li>
    </ul>
</div>
</footer>

        <script src="https://docs.cdwanze.work/theme/js/jquery.min.js"></script>
    <script src="https://docs.cdwanze.work/theme/js/bootstrap.min.js"></script>
    <script>
        function validateForm(query) {
            return (query.length > 0);
        }
    </script>

    <script>
        function adjust_search_width() {
            var w = document.documentElement.clientWidth;
            if ((w > 755) && (w < 975)) {
                plus_width = w - 755;
                $('.navbar-form .form-control').outerWidth(210 + plus_width);
            } else if (w >= 975) {
                $('.navbar-form .form-control').outerWidth(210 + 220);
            } else if (w <= 755) {
                $('.navbar-form .form-control').css('width', '100%')
            }
        }

        $(document).ready(function () {
            adjust_search_width();
        });

        window.onresize = function () {
            adjust_search_width();
        }

    </script>


    



</body>
</html>