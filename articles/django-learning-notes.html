<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="baidu-site-verification" content="D4VqC4HppC"/>
    <meta name="msvalidate.01" content="55CB117A61A6F8286173763FB18D9625"/>

        <meta name="author" content="cdwanze"/>
        <meta name="copyright" content="cdwanze"/>

        <meta property="og:type" content="article"/>
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="django, 存档, " />

<meta property="og:title" content="django学习笔记 "/>
<meta property="og:url" content="https://docs.cdwanze.work/articles/django-learning-notes.html" />
<meta property="og:description" content="Beginning 一开始先介绍下Djanog项目的基本文件夹结构，还有一些基本的命令操作和一些基本的常识性东西。 首先是新建一个项目： 新建项目 django-admin startproject project-name 这个命令将创建一个文件夹，文件夹的名字就是这里设置的project-name，然后文件夹里面有一个manage.py文件，这个文件的主要作用就是挂载django的配置（一般是settings.py这个文件，当然你也可以修改为其他比如dev_settings.py文件）。 然后还有一个文件夹，里面有settings.py 、 urls.py 和 wsgi.py 文件。 settings.py 控制django的全部配置管理； urls.py 控制django的路径分发主入口，这个在配置中可以修改的。 wsgi.py 是你用apache或者uwsgi挂载的时候的控制入口。 这样最简单的初始项目就是可以运行的了： 开启服务器 python manage.py runserver localhost:8080 后面控制服务器监听的localhost或者外网0.0.0.0，然后就是端口号。 新建一个app …" />
<meta property="og:site_name" content="cdwanze的博文" />
<meta property="og:article:author" content="cdwanze" />
<meta property="og:article:published_time" content="2012-12-21T00:00:00+08:00" />
<meta name="twitter:title" content="django学习笔记 ">
<meta name="twitter:description" content="Beginning 一开始先介绍下Djanog项目的基本文件夹结构，还有一些基本的命令操作和一些基本的常识性东西。 首先是新建一个项目： 新建项目 django-admin startproject project-name 这个命令将创建一个文件夹，文件夹的名字就是这里设置的project-name，然后文件夹里面有一个manage.py文件，这个文件的主要作用就是挂载django的配置（一般是settings.py这个文件，当然你也可以修改为其他比如dev_settings.py文件）。 然后还有一个文件夹，里面有settings.py 、 urls.py 和 wsgi.py 文件。 settings.py 控制django的全部配置管理； urls.py 控制django的路径分发主入口，这个在配置中可以修改的。 wsgi.py 是你用apache或者uwsgi挂载的时候的控制入口。 这样最简单的初始项目就是可以运行的了： 开启服务器 python manage.py runserver localhost:8080 后面控制服务器监听的localhost或者外网0.0.0.0，然后就是端口号。 新建一个app …">

    <title>
django学习笔记  · cdwanze的博文
</title>


        <link href="https://docs.cdwanze.work/theme/css/font-awesome.css" rel="stylesheet"
              media="screen">
        <link href="https://docs.cdwanze.work/theme/css/bootstrap.min.css" rel="stylesheet"
              media="screen">

            <link rel="stylesheet" type="text/css"
                  href="https://docs.cdwanze.work/theme/css/pygments.css" media="screen">
            <link rel="stylesheet" type="text/css"
                  href="https://docs.cdwanze.work/theme/css/elegant.css" media="screen">
            <link rel="stylesheet" type="text/css"
                  href="https://docs.cdwanze.work/theme/css/custom.css" media="screen">






</head>
<body>

<nav class="navbar">
    <div class="navbar navbar-default" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target=".navbar-collapse"
                    aria-expanded="false">
                <span class="sr-only">Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a class="navbar-brand" href="https://docs.cdwanze.work/"><span
                    class=site-name>网站首页</span></a>
        </div>


        <div class="navbar-collapse collapse">
            <form action="https://docs.cdwanze.work/search.html"
                  onsubmit="return validateForm(this.elements['q'].value);"
                  class="navbar-form navbar-left">
                <div class="form-group">
                    <input type="text" name="q" id="tipue_search_input"
                           class="form-control" placeholder="Search..."
                           style="width:430px;">
                </div>
                <button class="btn btn-default" type="submit">搜索</button>
            </form>


            <ul class="nav navbar-nav nav-pills navbar-right">
                <li >
                    <a href="https://docs.cdwanze.work">博文首页</a></li>

                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle"
                           data-toggle="dropdown" role="button"
                           aria-haspopup="true" aria-expanded="false">查找文章<span
                                class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a class="slowscroll" href="/categories.html">按分类</a>
                            </li>
                            <li><a class="slowscroll" href="/tags.html">按标签</a>
                            </li>
                        </ul>
                    </li>


                        <li >
                            <a href="https://docs.cdwanze.work/pdf-ebooks.html">pdf电子书籍</a>
                        </li>
                        <li >
                            <a href="https://docs.cdwanze.work/epub-ebooks.html">epub电子书籍</a>
                        </li>
                        <li >
                            <a href="https://docs.cdwanze.work/about.html">关于本网站</a>
                        </li>
            </ul>


        </div>
    </div>
</nav>


<div class="container-fluid">
    <div class="col-md-1 col-md-1-left"></div>
    <div class="col-md-10">
<article>
<div class="row">
    <header class="page-header col-md-10 col-md-offset-2">
    <h1><a href="https://docs.cdwanze.work/articles/django-learning-notes.html"> django学习笔记  </a></h1>
    </header>
</div>

<div class="row">
    <div class="col-md-2 table-of-content">
        <nav>
        <h4>目录</h4>
        <div class="toc">
<ul>
<li><a href="#beginning">Beginning</a><ul>
<li><a href="#_1">新建项目</a></li>
<li><a href="#_2">开启服务器</a></li>
<li><a href="#app">新建一个app</a></li>
<li><a href="#_3">数据库操作</a></li>
<li><a href="#_4">交互式环境</a></li>
<li><a href="#_5">创建超级用户</a></li>
</ul>
</li>
<li><a href="#appspy">apps.py</a></li>
<li><a href="#url">url分发</a><ul>
<li><a href="#url_1">url上带参数</a></li>
<li><a href="#urlname">url定义name</a></li>
<li><a href="#full-url">获取full-url</a></li>
</ul>
</li>
<li><a href="#_6">请求和响应</a><ul>
<li><a href="#request">request</a></li>
<li><a href="#response">Response</a></li>
</ul>
</li>
<li><a href="#_7">模型的定义和使用</a><ul>
<li><a href="#settings">settings那边的配置</a></li>
<li><a href="#_8">使用多个数据库</a></li>
</ul>
</li>
<li><a href="#_9">定义模型</a><ul>
<li><a href="#_10">字段类型</a></li>
<li><a href="#_11">通用选项</a></li>
<li><a href="#_12">数据库中的关系</a></li>
<li><a href="#_13">多字段组合唯一</a></li>
</ul>
</li>
<li><a href="#_14">定义模型中的元类数据</a></li>
<li><a href="#_15">模型的使用</a><ul>
<li><a href="#_16">新建记录</a></li>
<li><a href="#_17">查询记录</a></li>
<li><a href="#_18">排序</a></li>
<li><a href="#reverse">reverse</a></li>
<li><a href="#exclude">exclude</a></li>
<li><a href="#offset-and-limit">offset and limit</a></li>
<li><a href="#_19">删除某个记录</a></li>
<li><a href="#_20">确定某记录是否存在</a></li>
<li><a href="#_21">关系的使用</a></li>
</ul>
</li>
<li><a href="#_22">序列化</a><ul>
<li><a href="#_23">理解序列化过程</a></li>
<li><a href="#modelserializer">ModelSerializer</a></li>
<li><a href="#is_valid">is_valid 方法</a></li>
<li><a href="#requestuser">在序列化类里面引用request.user</a></li>
</ul>
</li>
<li><a href="#_24">模板基本概念</a><ul>
<li><a href="#django">django如何查找模板的</a></li>
<li><a href="#djangojavascript">django的变量怎么传给javascript</a></li>
</ul>
</li>
<li><a href="#_25">扩展用户模型</a></li>
<li><a href="#_26">基于类的视图</a><ul>
<li><a href="#apiview">APIView</a></li>
<li><a href="#_27">视图再升级</a></li>
<li><a href="#genericapiview">GenericAPIView</a></li>
</ul>
</li>
<li><a href="#_28">权限管理</a><ul>
<li><a href="#_29">认证</a></li>
<li><a href="#_30">自定义身份认证</a></li>
<li><a href="#_31">权限</a></li>
<li><a href="#_32">自定义权限管理类</a></li>
</ul>
</li>
<li><a href="#_33">日志管理</a></li>
<li><a href="#logging">logging模块中级教程</a><ul>
<li><a href="#loggers">loggers</a></li>
<li><a href="#handlers">handlers</a></li>
<li><a href="#filters">filters</a></li>
<li><a href="#formatters">formatters</a></li>
<li><a href="#_34">字典统一配置</a></li>
</ul>
</li>
<li><a href="#_35">自定义命令</a></li>
<li><a href="#djangocelery">django和celery</a><ul>
<li><a href="#celery">celery的核心概念</a></li>
<li><a href="#django_1">django内文件安排</a><ul>
<li><a href="#celeryconfigpy">celeryconfig.py</a></li>
<li><a href="#__init__py">__init__.py</a></li>
<li><a href="#settingspy">settings.py</a></li>
<li><a href="#_36">定义任务</a></li>
<li><a href="#_37">启动任务</a></li>
<li><a href="#_38">手工启动一次任务</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_39">翻译</a></li>
<li><a href="#app_1">创建可复用的app</a><ul>
<li><a href="#django-whatpypi">制作django-what的pypi包</a></li>
<li><a href="#_40">测试问题</a></li>
<li><a href="#migrations">migrations问题</a></li>
</ul>
</li>
<li><a href="#_41">部署</a><ul>
<li><a href="#apache">apache</a></li>
<li><a href="#_42">关于静态文件</a></li>
<li><a href="#django_2">多django站点部署问题</a></li>
<li><a href="#_43">文件权限问题</a></li>
<li><a href="#nginx">nginx</a><ul>
<li><a href="#nginx-serve">nginx serve 静态文件</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_44">对外部署必看</a><ul>
<li><a href="#settingspy_1">settings.py 里密钥外置</a></li>
<li><a href="#allowed_hosts">ALLOWED_HOSTS</a></li>
</ul>
</li>
<li><a href="#api">API设计</a><ul>
<li><a href="#url_2">url设计</a></li>
<li><a href="#_45">方法设计</a></li>
<li><a href="#_46">参数设计</a></li>
<li><a href="#_47">状态码设计</a></li>
<li><a href="#_48">返回内容结构设计</a></li>
<li><a href="#_49">编写良好的文档</a></li>
</ul>
</li>
<li><a href="#_50">其他技巧</a><ul>
<li><a href="#python2">模型python2兼容性</a></li>
<li><a href="#migrations_1">重置migrations</a></li>
<li><a href="#_51">处理列表对象</a></li>
<li><a href="#_52">多数据库处理</a></li>
<li><a href="#django_3">如何根据django的模型对象来获取其对应的表格的名字</a></li>
<li><a href="#djangoimagefield">如何使用好django的ImageField</a></li>
<li><a href="#djangomessages">django的messages系统</a></li>
<li><a href="#csrf">csrf认证失败</a></li>
</ul>
</li>
</ul>
</div>
        </nav>
    </div>
    <div class="col-md-8 article-content">

            
            
<h2 id="beginning">Beginning</h2>
<p>一开始先介绍下Djanog项目的基本文件夹结构，还有一些基本的命令操作和一些基本的常识性东西。</p>
<p>首先是新建一个项目：</p>
<h3 id="_1">新建项目</h3>
<div class="highlight"><pre><span></span><span class="err">django-admin startproject project-name</span>
</pre></div>
<p>这个命令将创建一个文件夹，文件夹的名字就是这里设置的project-name，然后文件夹里面有一个manage.py文件，这个文件的主要作用就是挂载django的配置（一般是settings.py这个文件，当然你也可以修改为其他比如dev_settings.py文件）。</p>
<p>然后还有一个文件夹，里面有settings.py 、 urls.py 和 wsgi.py 文件。</p>
<p>settings.py 控制django的全部配置管理；</p>
<p>urls.py 控制django的路径分发主入口，这个在配置中可以修改的。</p>
<p>wsgi.py 是你用apache或者uwsgi挂载的时候的控制入口。</p>
<p>这样最简单的初始项目就是可以运行的了：</p>
<h3 id="_2">开启服务器</h3>
<div class="highlight"><pre><span></span><span class="err">python manage.py runserver localhost:8080</span>
</pre></div>
<p>后面控制服务器监听的localhost或者外网0.0.0.0，然后就是端口号。</p>
<h3 id="app">新建一个app</h3>
<div class="highlight"><pre><span></span><span class="err">python manage.py startapp app_name</span>
</pre></div>
<p>这里顺便说一下，有一些项目你可能找不到 manager.py 这个文件了，其实这个文件就是一个便捷入口罢了，所有的命令一样都可以通过 django-admin 命令来运行的。</p>
<h3 id="_3">数据库操作</h3>
<p>定义模型之后，你需要运行:</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py makemigrations app_name</span>
</pre></div>
<p>这个过程就是创建每个app下的migrations文件夹下面的一些迁移python脚本文件，有的时候某些情况你可能需要手工修改这些迁移文件。</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py migrate</span>
</pre></div>
<p>这个命令就是实际执行那些迁移python脚本。</p>
<h3 id="_4">交互式环境</h3>
<p>进入python交互环境，这个和纯python交互环境的区别就是里面可以直接使用django里面的一些东西了，比如你定义的模型对象就可以直接使用了。这个对你开发进行测试工作非常有用！</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py shell</span>
</pre></div>
<p>或者进入sql实现的交互环境:</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py dbshell</span>
</pre></div>
<h3 id="_5">创建超级用户</h3>
<p>最开始创建的项目就把admin url挂上去了，你可以去 \verb+/admin+ 这个url下看一下，但要登录除了做一下上面的数据库表格创建工作外，还需要创建一个超级用户用于登录。</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py createsuperuser</span>
</pre></div>
<h2 id="appspy">apps.py</h2>
<p>通过快捷命令创建的app模块是没有这个文件的，但是我看到某些例子里面其有这个文件，后来了解到这个文件是有特殊含义的：这是django项目用来存放app 一些相关配置信息的地方。</p>
<p>一个基本的例子如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">AppConfig</span>

<span class="k">class</span> <span class="nc">RockNRollConfig</span><span class="p">(</span><span class="n">AppConfig</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">'rock_n_roll'</span>
    <span class="n">verbose_name</span> <span class="o">=</span> <span class="s2">"Rock ’n’ roll"</span>
</pre></div>
<p>其中name定义了本app的名字和完整名字，然后你需要在本app的 <code>__init__.py</code> 文件下加入：</p>
<div class="highlight"><pre><span></span><span class="err">default_app_config = 'rock_n_roll.apps.RockNRollConfig'</span>
</pre></div>
<p>来引入这个配置文件。</p>
<p>有什么用？well，最简单的用处就是本app实际在 <code>INSTALLED_APPS</code> 哪里不是默认的文件夹名字了，而是你这里定义的名字。</p>
<p>另外一个高级用法就是定制 <code>ready</code> 方法，来初始化本app的一些信号设置。    </p>
<h2 id="url">url分发</h2>
<p>web框架的一个核心功能就是完成url分发工作，我们先来看下django的这块内容。</p>
<p>基本过程是在你的 project 的 <code>urls.py</code> 那里定义好整个项目的url分发规则。默认的内容如下:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
<p>读者有兴趣可以先看下那个admin页，在 <code>/admin</code> 那边。请确认已经执行前面的数据库操作 <code>makemigrations</code> 和 <code>migrate</code> 了，然后已经创建超级用户了 <code>createsuperuser</code> 。这样你就可以看到django默认自动创建的admin支持页面了。</p>
<p>然后接下来就是类似这样的在这里插入你自己的 app的 各个 urls定义。一般如下简单写上即可:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">path</span>
    <span class="o">....</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'app_name/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'app_name.urls'</span><span class="p">)),</span>
    <span class="o">....</span>
</pre></div>
<p>在确定没有特殊url分发需求的情况下，都推荐如上使用django官方教程推荐的这种url分发写法。</p>
<p>在某个app下的 <code>urls.py</code> 将进一步定义url分发规则:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'index'</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
<p>上面的讨论是根据django的官方教程来的，应该是推荐的写法风格。</p>
<h3 id="url_1">url上带参数</h3>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">re_path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">'^add/([\d]+)/([\d]+)$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'add'</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
<p>这里参数将逐个传递个视图函数，唯一值得一提的是django的视图函数默认第一个函数是传递进去的 <code>request</code> 参量。在 <code>views.py</code> 里面的内容如下:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
</pre></div>
<p>上面这种正则表达式的写法是老式的django的url写法，一般没有特别的需求的话，应该按照django官方教程，采用下面的推荐写法：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'add/&lt;int:a&gt;/&lt;int:b&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'add'</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
<h3 id="urlname">url定义name</h3>
<p><code>name</code> 这个参量大体类似于flask的 <code>endpoint</code> 的概念，然后django还有的 <code>reverse</code> 函数，其大体类似于flask的 <code>url_for</code> 的概念。</p>
<p>比如上面视图函数的 add 对应的url我们可以如下获得:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="n">reverse</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
<p>然后在模板中有:</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'add' 1 2 %}"</span><span class="nt">&gt;</span>link<span class="nt">&lt;/a&gt;</span>
</pre></div>
<h3 id="full-url">获取full-url</h3>
<p>上面提到的reverse函数返回的url字符串还不是完整的url，而只是相对url。如果我们要获取全站的完整url则可以使用 <code>request.build_absolute_uri(location)</code> ，如果不指定location则默认是当前的url。</p>
<h2 id="_6">请求和响应</h2>
<h3 id="request">request</h3>
<p>是的，我们的APIView的一些特殊含义的方法，都会接收一个 request对象，这个对象有：</p>
<ul>
<li>query_params 获得GET传过来的参数</li>
<li>data 获得POST PUT PATCH 传过来的参数，这还没完，传过来的文件，表单都支持。</li>
<li>user 如果请求经过认证了会返回相应的用户记录，你编写auth类的时候会知道的，如果没有认证，那么返回 <code>AnonymousUser</code></li>
</ul>
<h3 id="response">Response</h3>
<p>也就是一些特殊含义的方法的返回对象，其第一个参数是data，字典值，会自动封装成为json友好的格式。实际上我们经常看到的就是这个套路：</p>
<div class="highlight"><pre><span></span><span class="err">return Response(serializer.data)</span>
</pre></div>
<p>然后 serializer 有个 <code>is_valid</code> 方法，用来序列化类输出前的预热。这两点在后面序列化的讨论中会涉及。其他一些我们看一下吧：</p>
<div class="highlight"><pre><span></span><span class="err">Response(data, status=None, template_name=None, headers=None, content_type=None)</span>
</pre></div>
<p>headers http协议响应头，status http状态码等等。</p>
<p>整个过程套路，很多高级视图的套路都类似于下面这个例子，多看几遍吧。</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Retrieve, update or delete a snippet instance.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">snippet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</pre></div>
<p>urls.py那边加上的是:</p>
<div class="highlight"><pre><span></span><span class="err">url(r'^snippets/(?P&lt;pk&gt;[0-9]+)/$', views.SnippetDetail.as_view()),</span>
</pre></div>
<p>这里正则表达式 <code>(?P&lt;pk&gt;[0-9]+)</code> 的意思是收集某一串数字，这一串数字被命名为 <code>pk</code> 。</p>
<h2 id="_7">模型的定义和使用</h2>
<p>django的模板和sqlalchemy还是有很多地方类似的。</p>
<h3 id="settings">settings那边的配置</h3>
<ul>
<li><strong>INSTALLED_APPS:</strong> 你需要加上你新加入的 app 的名字，不加的话是不能通过 <code>makemigrations</code> 来管理数据库的。</li>
<li><strong>DATABASES:</strong> 默认会创建一个sqlite3数据库，也能满足基本的需求了，如果你想要使用mysql等数据库，则参考样例修改这里的配置。比如连接mysql的样例是:</li>
</ul>
<div class="highlight"><pre><span></span><span class="err">    DATABASES = {</span>
<span class="err">        'default': {</span>
<span class="err">            'ENGINE': 'django.db.backends.mysql',</span>
<span class="err">            'NAME': "database_name",</span>
<span class="err">            'USER': "root",</span>
<span class="err">            'PASSWORD': "",</span>
<span class="err">            'HOST': "localhost", </span>
<span class="err">            'PORT': "3306",</span>
<span class="err">            'OPTIONS': {</span>
<span class="err">                'charset': 'utf8'</span>
<span class="err">            }</span>
<span class="err">        }</span>
<span class="err">    }</span>
</pre></div>
<p>一般会加上 charset 是 utf8这个选项，当然mysql那边你也需要设置好字符编码。有的时候如下设置init_command 来设置字符编码可以让你获得更好的字符编码兼容性。</p>
<div class="highlight"><pre><span></span><span class="err">    'OPTIONS': {</span>
<span class="err">        'init_command': 'SET character_set_database=utf8 ,\</span>
<span class="err">        character_set_server=utf8,\</span>
<span class="err">        character_set_connection=utf8,\</span>
<span class="err">        collation_connection=utf8_unicode_ci',</span>
<span class="err">        'charset': 'utf8'}</span>
</pre></div>
<h3 id="_8">使用多个数据库</h3>
<p>有的时候你需要使用多个数据库，最常见的情况是某个单独的app使用另外一个数据库。</p>
<p>首先你需要再加上另外一个数据库的定义：</p>
<div class="highlight"><pre><span></span><span class="err">    DATABASES = {</span>
<span class="err">        'default': {</span>
<span class="err">        'ENGINE': 'django.db.backends.mysql',</span>
<span class="err">        'NAME': "database_name",</span>
<span class="err">        'USER': "root",</span>
<span class="err">        'PASSWORD': "",</span>
<span class="err">        'HOST': "localhost",</span>
<span class="err">        'PORT': "3306",</span>
<span class="err">        'OPTIONS': {</span>
<span class="err">            'charset': 'utf8'</span>
<span class="err">            }</span>
<span class="err">        },</span>
<span class="err">        'youapp': {</span>
<span class="err">            'ENGINE': 'django.db.backends.mysql',</span>
<span class="err">            'NAME': 'youapp',</span>
<span class="err">            'USER': 'root',</span>
<span class="err">            'PASSWORD': '',</span>
<span class="err">            'HOST': '',</span>
<span class="err">            'PORT': '',</span>
<span class="err">            'OPTIONS': {'charset': 'utf8'}</span>
<span class="err">        },</span>
<span class="err">    }</span>
</pre></div>
<p>然后在你的app那边新建一个dbrouter文件，里面定义一个YourRouter类。</p>
<div class="highlight"><pre><span></span><span class="err">DATABASE_ROUTERS = ['youapp.dbrouter.YourRouter']</span>
</pre></div>
<p>在这个类里面如下定义一些数据库选择行为：</p>
<p><strong>NOTICE: 在这个app中定义的模型记得都要加上app_label这个meta属性。</strong></p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">YourRouter</span>(<span class="n">object</span>):
    <span class="n">def</span> <span class="n">db_for_read</span>(<span class="k">self</span>, <span class="n">model</span>, **<span class="nb">hints</span>):
        <span class="k">if</span> <span class="n">model</span>.<span class="n">_meta</span>.<span class="n">app_label</span> == <span class="s">'youapp'</span>:
            <span class="k">return</span> <span class="s">'youapp'</span>
        <span class="k">return</span> <span class="n">None</span>

    <span class="n">def</span> <span class="n">db_for_write</span>(<span class="k">self</span>, <span class="n">model</span>, **<span class="nb">hints</span>):
        <span class="k">if</span> <span class="n">model</span>.<span class="n">_meta</span>.<span class="n">app_label</span> == <span class="s">'youapp'</span>:
            <span class="k">return</span> <span class="s">'youapp'</span>
        <span class="k">return</span> <span class="n">None</span>

    <span class="n">def</span> <span class="n">allow_relation</span>(<span class="k">self</span>, <span class="n">obj1</span>, <span class="n">obj2</span>, **<span class="nb">hints</span>):
        <span class="k">if</span> <span class="n">obj1</span>.<span class="n">_meta</span>.<span class="n">app_label</span> == <span class="s">'youapp'</span> <span class="o">or</span> \
            <span class="n">obj2</span>.<span class="n">_meta</span>.<span class="n">app_label</span> == <span class="s">'youapp'</span>:
            <span class="k">return</span> <span class="nb">True</span>
        <span class="k">return</span> <span class="n">None</span>

    <span class="n">def</span> <span class="n">allow_migrate</span>(<span class="k">self</span>, <span class="n">db</span>, <span class="n">app_label</span>, <span class="n">model_name</span>=<span class="n">None</span>, **<span class="nb">hints</span>):
        <span class="k">if</span> <span class="n">app_label</span> == <span class="s">'youapp'</span>:
            <span class="k">return</span> <span class="n">db</span> == <span class="s">'youapp'</span>
        <span class="k">return</span> <span class="n">None</span>
</pre></div>
<h2 id="_9">定义模型</h2>
<p>好了，开始实际定义自己的模型了。首先基本语法如下:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">question_text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="s1">'date published'</span><span class="p">)</span>
</pre></div>
<p>这个熟悉sqlalchemy的对这段代码不会很陌生，下面进一步了解一些细节吧。</p>
<h3 id="_10">字段类型</h3>
<ul>
<li><strong>IntegerField:</strong> 整型</li>
<li><strong>BigIntegerField:</strong> 大整数</li>
<li><strong>BinaryField:</strong> raw data</li>
<li><strong>BooleanField:</strong> bool 值</li>
<li><strong>CharField:</strong> 定义字符串类型，比如设置最大长度 <code>max_length</code> 这个属性。</li>
<li><strong>TextField:</strong> 大段文字用这个。</li>
<li><strong>DateField:</strong> 对应python中的 <code>datetime.date</code> 对象。</li>
<li><strong>DateTimeField:</strong> 对应python中的 <code>datetime.datetime</code> 对象。</li>
</ul>
<p>一个有用的基类:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">updated_at</span><span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span><span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>后面的模型都可以继承自该基类，基类是不会创建表格的，因为其Meta设置了 <code>abstract=True</code> 。DateTimeField加上 <code>auto_now=True</code> ，那么该模型每次 <code>save</code> 操作都会自动更新最新日期。 然后 <code>auto_now_add=True</code> 即该记录第一次创建时设置最新的日期。然后如果DateTimeField使用了 auto_now 或者 auto_now_add 这两个选项了就不要使用default选项了，还有就是自动插入的默认的时间是由 <code>django.utils.timezone.now()</code> 获得的。</p>
<p>比如后面你想获得六个小时之前的所有记录那么可以如下查询：</p>
<div class="highlight"><pre><span></span><span class="err">    checktime = timezone.now() - timedelta(hours=6)</span>
<span class="err">    result = result.exclude(created_at__gt= checktime)</span>
</pre></div>
<h3 id="_11">通用选项</h3>
<p>字段声明控制中有一些通用可选项:</p>
<ul>
<li><strong>default:</strong> 设置该字段的默认值，注意default还可以接受一个函数对象。</li>
<li><strong>null:</strong> 设置为True，则该自动会自动填充sql中的NULL值，字符串类型字段最好默认空字符。</li>
<li><strong>blank:</strong> 如果设置为True，则空值也是允许的，其和null的区别是null是说数据库那边的，而blank是说显示那边的。</li>
<li><strong>db_column:</strong> 设置该字段具体在数据库中对应的表格的名字。</li>
<li><strong>db_index:</strong> 设置为 <code>True</code> 则表示该字段开启索引。</li>
<li><strong>primary_key:</strong> 主键 。</li>
<li><strong>unique:</strong> 唯一</li>
<li><strong>unique_for_date:</strong> 比如title字段设置:</li>
</ul>
<div class="highlight"><pre><span></span><span class="err">    unique_for_date="pub_date"</span>
</pre></div>
<p>则 title字段和 pub_date 字段都不能相同。也就是在某个日期内某个title只能有唯一值。可以看作一种 <code>unique_together</code> 的应用。</p>
<h3 id="_12">数据库中的关系</h3>
<p><strong>ForeignKey:</strong> 外键引用，如果该字段的名字是user，那么实际存储在表格中的名字是user_id，你可以通过 <code>db_column</code> 来实际控制该表格的名字。- </p>
<p>我们通常说的onetomany关系就是通过定义ForeignKey来获得的。比如：</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">City</span>(<span class="n">models</span>.<span class="n">Model</span>):
     <span class="nb">name</span> = <span class="n">models</span>.<span class="n">CharField</span>(<span class="n">max_length</span>=<span class="mi">60</span>)
     <span class="k">state</span> = <span class="n">models</span>.<span class="n">CharField</span>(<span class="n">max_length</span>=<span class="mi">40</span>)
     <span class="n">zipcode</span> = <span class="n">models</span>.<span class="n">IntegerField</span>()

<span class="k">class</span> <span class="n">Address</span>(<span class="n">models</span>.<span class="n">Model</span>):
     <span class="n">number</span> = <span class="n">models</span>.<span class="n">IntegerField</span>()
     <span class="n">street</span> = <span class="n">models</span>.<span class="n">CharField</span>(<span class="n">max_length</span>=<span class="mi">100</span>)
     <span class="n">city</span> = <span class="n">models</span>.<span class="n">ForeignKey</span>(<span class="n">City</span>)
</pre></div>
<p>一个city有多个address，但是一个address只能有一个city，也就是一个外键映射到city那边。所以我觉得ForeignKey更确切的表示是manytoone关系，当某个模型有一个外键属性是，也就是可以有多个记录指向同一个它物 <a href="https://chrisbartos.com/articles/how-to-implement-one-to-many-relationship-in-django/">参阅了这篇文章</a>。</p>
<p><strong>OneToOneField</strong>
OneToOneField 比较简单，就是一个记录只有一个对应的属性，通常在用户管理的时候会用到。</p>
<p><strong>ManyToManyField</strong></p>
<p>ManyToManyField 读者请参阅我写的 <a href="http://www.cdwanze.work/articles/python/sqlalchemy-module.html#orm_2">sqlalchemy模块</a> 一文， 那里写得比较详细。</p>
<p>关于模型定义的字段，更多的内容请参看官方文档。</p>
<h3 id="_13">多字段组合唯一</h3>
<p>参考了 <a href="https://stackoverflow.com/questions/28712848/composite-primary-key-in-django">这个网页</a> ，具体就是在 <code>Meta</code>  那里定义 <code>unique_together</code> 属性。</p>
<div class="highlight"><pre><span></span><span class="err">    ...</span>
<span class="err">    title = models.CharField(max_length=255)</span>
<span class="err">    gzh_id = models.CharField(max_length=255, null=True, blank=True)</span>
<span class="err">    ...</span>
<span class="err">   class Meta:</span>
<span class="err">        db_table = 'article'</span>
<span class="err">        unique_together = ("title","gzh_id")</span>
</pre></div>
<h2 id="_14">定义模型中的元类数据</h2>
<div class="highlight"><pre><span></span><span class="err">    ...</span>
<span class="err">    class Meta:</span>
<span class="err">        db_table = 'table_name'</span>
</pre></div>
<ul>
<li>db_table 具体指定实际创建的table表格的名字。</li>
<li>abstract 将不会创建表格，该模型为抽象模型。</li>
<li></li>
</ul>
<h2 id="_15">模型的使用</h2>
<p>模型的使用最核心的部分就是查询操作，至于修改记录，则具体查询获得目标记录了，修改属性然后save即可。</p>
<h3 id="_16">新建记录</h3>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">people.models</span> <span class="kn">import</span> <span class="n">Person</span>
<span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"WeizhongTu"</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>
<p>但是要注意如果你插入一条记录出现主键重复问题了，那么程序是会返回异常的。一般推荐使用 <code>get_or_create</code> 方法：</p>
<div class="highlight"><pre><span></span><span class="err">obj, created = Person.objects.get_or_create(first_name='John', last_name='Lennon',</span>
<span class="err">                  defaults={'birthday': date(1940, 10, 9)})</span>
</pre></div>
<p>上面这个语句有查询的效果也有新建记录的效果。写的这些属性首先将进行get操作，大体是如下的加强版：</p>
<div class="highlight"><pre><span></span><span class="k">try</span><span class="o">:</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">objects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">'John'</span><span class="o">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">'Lennon'</span><span class="o">)</span>
<span class="n">except</span> <span class="n">Person</span><span class="o">.</span><span class="na">DoesNotExist</span><span class="o">:</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">Person</span><span class="o">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">'John'</span><span class="o">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">'Lennon'</span><span class="o">,</span> <span class="n">birthday</span><span class="o">=</span><span class="n">date</span><span class="o">(</span><span class="mi">1940</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">9</span><span class="o">))</span>
    <span class="n">obj</span><span class="o">.</span><span class="na">save</span><span class="o">()</span>
</pre></div>
<p>而如果单纯使用get方法，如果记录不存在那么会抛出 <strong>DoesNotExist</strong> 异常；如果找到多个记录，会抛出 <strong>MultipleObjectsReturned </strong> 异常。 get_or_created 方法如果找到多个记录也会抛出  <strong>MultipleObjectsReturned </strong> 异常。</p>
<p>这样 <code>get_or_created</code> 方法将确保总是插入一条记录或者取得记录。其中created=True则表明target是新建的记录。</p>
<p>然后是如何理解 defaults 这样选项，defaults里面定义的属性不会参与get查询过程，其参与的是在没有找到记录的情况下，设置某些值。</p>
<h3 id="_17">查询记录</h3>
<p>首先说一下获取所有的记录：</p>
<div class="highlight"><pre><span></span><span class="err">result = Person.objects.all()</span>
</pre></div>
<p>其返回的是 QuerySet 对象，QuerySet对象可以继续进行下一步的查询操作。比如下面可以继续：</p>
<div class="highlight"><pre><span></span><span class="err">result = result.filter(name="abc")</span>
</pre></div>
<p>当然就上面的例子来说直接使用filter方法即可：</p>
<div class="highlight"><pre><span></span><span class="err">result = Person.objects.filter(name="abc")</span>
</pre></div>
<h3 id="_18">排序</h3>
<p>QuerySet对象可以进一步排序：</p>
<div class="highlight"><pre><span></span><span class="err">result = result.order_by('what')</span>
</pre></div>
<h3 id="reverse">reverse</h3>
<div class="highlight"><pre><span></span><span class="err">result = result.reverse()</span>
</pre></div>
<h3 id="exclude">exclude</h3>
<p>排除某些记录，下面是排除created_at这个字段值大于某个时间的值：</p>
<div class="highlight"><pre><span></span><span class="err">result = result.exclude(created_at__gt= checktime)</span>
</pre></div>
<h3 id="offset-and-limit">offset and limit</h3>
<div class="highlight"><pre><span></span><span class="err">result = result[offset: offset+limit]</span>
</pre></div>
<h3 id="_19">删除某个记录</h3>
<p>找到目标记录的instance，然后调用 <code>delete</code> 方法即可。</p>
<h3 id="_20">确定某记录是否存在</h3>
<p>前面已经谈到了一些查询操作，而如果读者只是单纯的想确定某记录是否存在，那么使用 <code>exists</code> 方法是最快和最简便的。参考了 <a href="https://stackoverflow.com/questions/2690521/django-check-for-any-exists-for-a-query">这个网页</a> 。</p>
<div class="highlight"><pre><span></span><span class="err">if Article.objects.filter(unique_id= unique_id).exists():</span>
<span class="err">    ...</span>
</pre></div>
<h3 id="_21">关系的使用</h3>
<p>OnetoOne关系的使用非常简单， <code>a.b</code> 或者 <code>b.a</code> 都是可以的。</p>
<p>ManytoOne关系也就是由 ForeignKey 定义的关系，如果是引用外键的那个对象，那么直接 <code>a.b</code> 即可，如果是反向onetomany那种，则最好你在定义的时候就定义好 <code>related_name</code> ，（参考了 <a href="https://stackoverflow.com/questions/19799955/django-get-the-set-of-objects-from-many-to-one-relationship">这个问题</a> ）那么引用如下：</p>
<div class="highlight"><pre><span></span><span class="err">b.related_name</span>
</pre></div>
<p>具体使用细节还是请查看文档的 <a href="https://docs.djangoproject.com/zh-hans/2.0/topics/db/examples/many_to_one/">这里</a> 。</p>
<h2 id="_22">序列化</h2>
<h3 id="_23">理解序列化过程</h3>
<p>django restframework的序列化类类似于django的表单类，不同的是django的表单类是用于沟通django的Model和网页form之间的桥梁；而序列化类是用于沟通django的Model类和JSON数据格式之间的桥梁。</p>
<div class="highlight"><pre><span></span><span class="err">注</span><span class="o">:</span> <span class="n">Model</span> <span class="o">-&gt;</span> <span class="n">Serializer</span> <span class="err">（其</span><span class="n">data挂载的是python的dict字典值了</span><span class="err">）</span>

<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="o">(</span><span class="n">snippet</span><span class="o">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="na">data</span>
<span class="err">#</span> <span class="o">{</span><span class="s1">'pk'</span><span class="o">:</span> <span class="mi">2</span><span class="o">,</span> <span class="s1">'title'</span><span class="o">:</span> <span class="n">u</span><span class="s1">''</span><span class="o">,</span> <span class="s1">'code'</span><span class="o">:</span> <span class="n">u</span><span class="s1">'print "hello, world"\n'</span><span class="o">,</span> <span class="s1">'linenos'</span><span class="o">:</span> <span class="n">False</span><span class="o">,</span> <span class="s1">'language'</span><span class="o">:</span> <span class="n">u</span><span class="s1">'python'</span><span class="o">,</span> <span class="s1">'style'</span><span class="o">:</span> <span class="n">u</span><span class="s1">'friendly'</span><span class="o">}</span>
</pre></div>
<p>上面这个过程通常是在视图类特殊方法下，进行一些数据库操作之后获取数据库的目标Model的记录，然后送入序列化类，然后目标类的 <code>.data</code> 属性就是字典值了，送入Response哪里就可以作为HTTP响应的结果值了。</p>
<p>然后还有下面这种用法，将某个字典data送入序列化类的data属性中，</p>
<div class="highlight"><pre><span></span><span class="err">serializer = SnippetSerializer(data=data)</span>
</pre></div>
<p>调用序列化类的save方法来进一步完成相应的数据库操作。</p>
<div class="highlight"><pre><span></span><span class="err">serializer.save()</span>
</pre></div>
<p>这个save方法具体行为依赖于你进一步定义序列化类里面的 <code>create</code> 和 <code>update</code> 方法。如下所示：</p>
<div class="highlight"><pre><span></span>    <span class="n">def</span> <span class="k">create</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">Comment</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="k">create</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">)</span>

    <span class="n">def</span> <span class="k">update</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'created'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">created</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instance</span>
</pre></div>
<p>某些情况下你可能想直接定义save方法。</p>
<h3 id="modelserializer">ModelSerializer</h3>
<p>类似于django的表单类，可以利用 <code>ModelSerializer</code> 类来更快地创建序列化类。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Snippet</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'title'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">,</span> <span class="s1">'linenos'</span><span class="p">,</span> <span class="s1">'language'</span><span class="p">,</span> <span class="s1">'style'</span><span class="p">)</span>
</pre></div>
<p>为了证明这种简便写法对于上面的任务（包括create和update方法都会自动实现的）是完全应付得过来的。上面在shell里的代码再撸一遍。</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">'print "hello, world2"</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">snippet</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
<span class="p">{</span><span class="s1">'language'</span><span class="p">:</span> <span class="s1">'python'</span><span class="p">,</span> <span class="s1">'linenos'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">'id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'title'</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">:</span> <span class="s1">'print "hello, world2"</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'style'</span><span class="p">:</span> <span class="s1">'friendly'</span><span class="p">}</span>
</pre></div>
<h3 id="is_valid">is_valid 方法</h3>
<div class="highlight"><pre><span></span><span class="err">serializer.is_valid(raise_exception=True)</span>
</pre></div>
<p>你可以定义 <code>validate</code> 方法来进行目标对象的验证行为，或者定义 <code>validate_&lt;fieldname&gt;</code> 来定义字段级别的验证行为。</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Check that the start is before the stop.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">'finish'</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">"finish must occur after start"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div>
<h3 id="requestuser">在序列化类里面引用request.user</h3>
<p>参考了 <a href="https://stackoverflow.com/questions/30203652/how-to-get-request-user-in-django-rest-framework-serializer">这个问题</a> ，在序列化类里面需要通过 <code>self.context['request']</code> 来获取 request 对象，进而获取 user对象。</p>
<div class="highlight"><pre><span></span><span class="err">user =  self.context['request'].user</span>
</pre></div>
<h2 id="_24">模板基本概念</h2>
<p>模板基本的样子如下，下面有模板继承，block ，循环，过滤，之类的。熟悉jinja2模板的同学稍微看下大致是个什么意思就已经清楚了。</p>
<div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">"base_generic.html"</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="nv">section.title</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">section.title</span> <span class="cp">}}</span><span class="x">&lt;/h1&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">story</span> <span class="k">in</span> <span class="nv">story_list</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;h2&gt;</span>
<span class="x">  &lt;a href="</span><span class="cp">{{</span> <span class="nv">story.get_absolute_url</span> <span class="cp">}}</span><span class="x">"&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">story.headline</span><span class="o">|</span><span class="nf">upper</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">  &lt;/a&gt;</span>
<span class="x">&lt;/h2&gt;</span>
<span class="x">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">story.tease</span><span class="o">|</span><span class="nf">truncatewords</span><span class="s2">:"100"</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
<h3 id="django">django如何查找模板的</h3>
<p>在django的settings.py哪里有：</p>
<div class="highlight"><pre><span></span><span class="n">PROJECT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)))</span>

<span class="n">TEMPLATES</span><span class="o">=</span><span class="p">[</span>
<span class="err">{</span>
<span class="s1">'BACKEND'</span><span class="p">:</span><span class="s1">'django.template.backends.django.DjangoTemplates'</span><span class="p">,</span>
<span class="s1">'DIRS'</span><span class="p">:[</span>
<span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">PROJECT_DIR</span><span class="p">,</span><span class="s1">'templates'</span><span class="p">),</span>
<span class="p">],</span>
</pre></div>
<p>默认是在每个app下的templates文件里都会递归遍历查找的，这里DIRS加上了另外一个文件夹，也就是现在settings.py所在的那个文件夹下如果有templates文件夹也会去遍历的。</p>
<p>模板文件最后都会合并的，所以就存在模板的覆盖机制了，为了避免无谓的覆盖，一般模板原则上推荐的结构是在templates下面，不管是那个app下面，都再新建一个目标app的名字，再新建模板文件。当然对于稍小的项目直接扔在templates下面问题不大。</p>
<p>比如你想覆盖django自带的admin界面，就要在templates下面新建一个admin文件夹，具体什么模板文件，你要研究下django的源码了。</p>
<h3 id="djangojavascript">django的变量怎么传给javascript</h3>
<p><strong>NOTICE: 现在不推荐这种写法了，推荐走ajax通道传数据。</strong></p>
<p>django的视图函数在render的时候通过context字典值，里面的各个字段的值将传给django的模板里的变量，这个我们是知道的了，那么django的变量怎么进而传递给javascript呢。本小节参考了 <a href="https://stackoverflow.com/questions/7165656/passing-objects-from-django-to-javascript-dom">这个网页</a> 。</p>
<p>首先要传递的字段建议如下json封装下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core.serializers.json</span> <span class="kn">import</span> <span class="n">DjangoJSONEncoder</span>
<span class="p">{</span>
    <span class="n">what</span> <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">'content_images'</span><span class="p">],</span> <span class="bp">cls</span><span class="o">=</span><span class="n">DjangoJSONEncoder</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>然后在javascript那边：</p>
<div class="highlight"><pre><span></span><span class="x">var what = JSON.parse("</span><span class="cp">{{</span> <span class="nv">what</span> <span class="o">|</span> <span class="nf">safe</span> <span class="o">|</span> <span class="nf">escapejs</span> <span class="cp">}}</span><span class="x">")</span>
</pre></div>
<p>注意 <code>safe</code> 和 <code>escapejs</code> 过滤器。</p>
<h2 id="_25">扩展用户模型</h2>
<p>本小节主要参考了这篇 <a href="https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html">不错的文章</a> 。一般扩展django自带的用户模型，最常见的就下面两种情况，实际上这两种情况你可能都会使用到。第一种是 User 模型 和 Profile 模型的分开，然后User用来存放登录相关信息，而Profile用来存放更多的用户资料信息，一般User 和 Profile 是 onetoone 关系，这个时候我们会考虑建立一个signals文件来保证没创建一个User就会跟着创建一个Profile：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>

<span class="kn">from</span> <span class="nn">profiles.models</span> <span class="kn">import</span> <span class="n">Profile</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user_profile</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
        <span class="n">Profile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>

<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_user_profile</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>然后你可能对django默认的auth机制，比如session cookies等不太满意，那么推荐你直接建立自己的 User 模型， 继承自 AbstractBaseUser ，我大概看了一下 AbstractBaseUser 的源码，其做的工作都是围绕着 password这个字段来的，而且只要你在settings里面定义好了:</p>
<div class="highlight"><pre><span></span><span class="err">AUTH_USER_MODEL = ...</span>
</pre></div>
<p>就都是可以正常工作的。继承之后定义自己的字段这是不多用多说的，然后推荐进一步继承 <code>PermissionsMixin</code> 这个类。</p>
<div class="highlight"><pre><span></span><span class="err">class User(AbstractBaseUser, PermissionsMixin):</span>
<span class="err">    email = models.EmailField(_('email address'), unique=True)</span>
</pre></div>
<p><code>PermissionsMixin</code> 这个类定义了一些群组信息还有什么的。</p>
<p>然后这三个字段属性有特殊含义，都是可以自己设置的：</p>
<div class="highlight"><pre><span></span><span class="err">    USERNAME_FIELD = 'username'</span>
<span class="err">    EMAIL_FIELD = 'email'</span>
<span class="err">    REQUIRED_FIELDS = ['email']</span>
</pre></div>
<p>然后你需要写好 objects 这个 UserManager ，其继承自 <code>BaseUserManager</code> ，你可以做其他一些定制，这个是个什么东西？这个就是之前我们看到的 <code>Model.objects.what</code> 之类的这种用法。在这里你需要根据自己的情况定义好： </p>
<ul>
<li>create_user</li>
<li>create_superuser</li>
</ul>
<p>这两个方法即可。就用这两个方法来控制用户的创建行为。其中 <code>create_superuser</code> 主要负责把 </p>
<ul>
<li>is_superuser</li>
<li>is_staff </li>
</ul>
<p>设为True。</p>
<h2 id="_26">基于类的视图</h2>
<p>首先我们从django哪里初步了解了下基于类的视图的概念，就是如下代码：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'GET'</span><span class="p">:</span>
        <span class="c1"># &lt;view logic&gt;</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">'result'</span><span class="p">)</span>
</pre></div>
<p>变为更简洁的：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>

<span class="k">class</span> <span class="nc">MyView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># &lt;view logic&gt;</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">'result'</span><span class="p">)</span>
</pre></div>
<p>然后依赖类的继承，引入Minxin类，可以让我们在http的很多restful风格请求上，总是一次又一次出现的那些套路，实现代码复用。其基本知识就是python的类的继承，我们可以直接从django restframework 这个模块直接用手来见识这种DRY理念的实现。</p>
<h3 id="apiview">APIView</h3>
<p>django restframework的 APIView 继承自 django 的 View，然后针对restful api 进行了很多优化，在某些情况下可能你编写的视图，就继承自APIView就是合适的，后面介绍的通用视图和其他高级视图等等，都是在某些情况下特别合适和让你少写代码，好用就用，仅此而已。如果不合适，那么自己定义 get post put 等等方法也是很方便的。</p>
<h3 id="_27">视图再升级</h3>
<p>在某些情况下使用 APIView 类和 Mixin 可能是最合适不过的，下面谈谈django restframework 提供的高级通用视图类。这些类都是继承自 <code>GenericAPIView</code> ，他们都有一个特点，那就是有点类似于 Serializer -&gt; ModelSerializer 的升级过程，如果你的视图类方法主要操作对象是基于数据库Model的各个操作，那么推荐视图类继承自 <code>GenericAPIView</code> 。</p>
<h3 id="genericapiview">GenericAPIView</h3>
<p>GenericAPIView 继承自 django restframework 的 APIView 类，其提供的一个很重要的特性是 <code>queryset</code> ，你设定 queryset属性或者实现 <code>get_queryset</code> 方法，该视图类的很多方法都是围绕着<code>queryset</code> 来展开的。</p>
<p>具体 CRUD 数据操作有对应的 Minxin类，然后和GenericAPIView 组合出了很多高级的视图类。</p>
<p>一个好的建议对于这块，看源码，源码都很简单的，看懂了，发现符合自己的需要那就使用它，让自己少写点代码。如果有额外的定制需求，那就重写对应的某个方法就是了。</p>
<h2 id="_28">权限管理</h2>
<h3 id="_29">认证</h3>
<p>在视图类里定义 <code>authentication_classes</code> 来确定目标视图类的认证行为，如果没有则采取默认的认证管理类行为。</p>
<h3 id="_30">自定义身份认证</h3>
<p>写自己的身份认证类，继承自 <code>BaseAuthentication</code> ，然后重写 <code>authenticate(self, request)</code> 方法，认证成功则返回 <code>(user, auth)</code> ，否则返回None。request.user 是当前登录的用户实例， request.auth 是当前登录auth的信息。</p>
<p>某些情况下身份认证失败你可能想要抛出 <code>AuthenticationFailed</code> 异常。</p>
<h3 id="_31">权限</h3>
<p>在视图类里定义 <code>permission_classes</code> 来确定目标视图类的权限管理行为，如果没有则采用默认的权限管理类行为。</p>
<p>认证完了就会进去权限管理，也就是权限检查的时候 <code>request.user</code> <code>request.auth</code> 已经是可以调用的了。</p>
<p>最简单的权限管理类就是 <code>IsAuthenticated</code> ，允许通过身份验证的用户访问，拒绝没通过的用户访问。</p>
<p><code>IsAuthenticatedOrReadOnly</code> 类的意思是通过身份认证的用户完全访问，没有通过身份验证的用户只能进行只读访问。</p>
<h3 id="_32">自定义权限管理类</h3>
<p>自定义权限管理类，继承自 <code>BasePermission</code> ，然后实现下面一个两个方法：</p>
<ul>
<li>has_permission(self, request, view)</li>
<li>has_object_permission(self, request, view, obj)</li>
</ul>
<p>如果请求被授予权限，则返回True，如果没有权限则返回False。</p>
<p>自定义权限管理类还可以加上 <code>message</code> 属性，用户权限没通过抛出 <code>PermissionDenied</code> 异常的额外显示信息。</p>
<h2 id="_33">日志管理</h2>
<p>django使用python的logging模块来作为的自己的日志系统，所以django项目日志管理的深入学习离不开对于logging模块的深入学习。</p>
<h2 id="logging">logging模块中级教程</h2>
<p>logging模块的中级使用需要了解如下几个词汇：loggers, handlers, filters, and formatters。</p>
<h3 id="loggers">loggers</h3>
<p>记录器 之前我们运行logging.info，就是调用的默认的记录器，然后一般我们会针对每个python的模块文件创建一个记录器。</p>
<div class="highlight"><pre><span></span><span class="err">logger = logging.getLogger(__name__)</span>
</pre></div>
<p>这个 <code>__name__</code> 只是一种简便的命名方法，如果你勤快或者某种情况下有需要的话完全可以自己手工给记录器取个名字。</p>
<p>然后这个 <code>getLogger</code> 函数如果你后面指定的名字之前已经定义了（这通常是指在其他第三方模块下定义了），那么你通过这个 <code>getLogger</code> 然后指定目标名字就会得到对应的该记录器。这通常对于DIY某个第三方模块的日志记录器有用。</p>
<p>记录器可以挂载或者卸载某个处理器对象或过滤器对象：</p>
<ul>
<li>logger.addHandler()</li>
<li>logger.removeHandler()</li>
<li>logger.addFilter()</li>
<li>logger.removeFilter()</li>
</ul>
<p>记录器通过 <code>setLevel()</code> 方法来设置最小记录级别，这个和后面的Handler级别是协作关系。</p>
<h3 id="handlers">handlers</h3>
<p>处理器负责分发日志信息到目标地去。这里主要介绍这几个Handler类：</p>
<ul>
<li>StreamHandler 将信息以流的形式输出，这通常指输出到终端</li>
<li>FileHandler 将信息写入到某个文件中去</li>
<li>RotatingFileHandler 将信息写入某个文件，如果文件大小超过某个值，则另外新建一个文件继续写。</li>
<li>TimeRotatingFileHandler 将信息写入某个文件，每隔一段时间，比如说一天，就会自动再新建一个文件再往里面写。</li>
</ul>
<p>处理器对象也有 <code>setLevel</code> 方法，这个前面也提及了，和记录器的 <code>setLevel</code> 是协作关系，更详细的描述是，信息先记录器处理并分发给对应的处理器对象，然后再处理器处理再分发到目的地。</p>
<p>处理器可以挂载 格式器 对象和 过滤器 对象。</p>
<ul>
<li>handler.setFormatter()</li>
<li>handler.addFilter()</li>
<li>handler.removeFilter()</li>
</ul>
<h3 id="filters">filters</h3>
<p>过滤器</p>
<h3 id="formatters">formatters</h3>
<p>格式器，具体信息的格式定义。</p>
<h3 id="_34">字典统一配置</h3>
<p>django的setting.py就会有这样的配置，具体含义还是很明显的，就是定义处理器，格式器，记录器等。</p>
<div class="highlight"><pre><span></span><span class="err">LOGGING = {</span>
<span class="err">    'version': 1,</span>
<span class="err">    'disable_existing_loggers': False,</span>
<span class="err">    'formatters': {</span>
<span class="err">        'simple': {</span>
<span class="err">            'format': "%(asctime)s %(name)s [%(levelname)s] %(thread)d %(module)s %(funcName)s %(lineno)s: %(message)s"</span>
<span class="err">        }</span>
<span class="err">    },</span>
<span class="err">    'handlers': {</span>
<span class="err">        'log_file': {</span>
<span class="err">            'class': 'sdsom.common.log.DedupeRotatingAndTimedRotatingFileHandler',</span>
<span class="err">            'filename': config.get('web', 'log_path'),</span>
<span class="err">            'when': 'midnight',</span>
<span class="err">            'maxBytes':int(config.get('web','log_max_bytes')),</span>
<span class="err">            'interval': 1,</span>
<span class="err">            'backupDay': int(config.get('web', 'log_backup_days')),</span>
<span class="err">            'dedupetime': int(config.get('web', 'log_dedupe_time')),</span>
<span class="err">            'formatter': 'simple'</span>
<span class="err">        },</span>
<span class="err">    },</span>
<span class="err">    'loggers': {</span>
<span class="err">        'django.request': {</span>
<span class="err">            'handlers': ['log_file'],</span>
<span class="err">            'level': config.get('web', 'log_level'),</span>
<span class="err">            'propagate': True,</span>
<span class="err">        },</span>
<span class="err">    }</span>
<span class="err">}</span>
</pre></div>
<h2 id="_35">自定义命令</h2>
<p>在目标app下面新建一个 <code>management</code> 文件夹，然后新建一个 <code>commands</code>  文件夹，注意这两个文件夹都要带上 <code>__init__.py</code> 文件。</p>
<p>然后commands文件夹里面就可以定义一些python脚本了，这些脚本成为命令可以直接如下调用：</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py command_name</span>
</pre></div>
<p>你可以通过：</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py help</span>
</pre></div>
<p>来查看目前已经有的命令列表。</p>
<p>一个基本的命令模块如下所示：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span><span class="p">,</span> <span class="n">CommandError</span>
<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Question</span> <span class="k">as</span> <span class="n">Poll</span>

<span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s1">'Closes the specified poll for voting'</span>

    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'poll_id'</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">poll_id</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">'poll_id'</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">poll</span> <span class="o">=</span> <span class="n">Poll</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">poll_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Poll</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s1">'Poll "</span><span class="si">%s</span><span class="s1">" does not exist'</span> <span class="o">%</span> <span class="n">poll_id</span><span class="p">)</span>

            <span class="n">poll</span><span class="o">.</span><span class="n">opened</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">poll</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">(</span><span class="s1">'Successfully closed poll "</span><span class="si">%s</span><span class="s1">"'</span> <span class="o">%</span> <span class="n">poll_id</span><span class="p">))</span>
</pre></div>
<h2 id="djangocelery">django和celery</h2>
<p>django-crontab这个模块我试过的，还是很便捷的，不过其还是基于系统的crontab，而如果我们将django和celery组合起来，celery灵活的消息分发机制，无疑将给未来开发带来更多的可能性。celery的官方文档在 <a href="http://docs.celeryproject.org/en/latest/index.html">这里</a> ，本文主要讲一下celery的基本概念和django的集成问题，更多celery的知识请参阅官方文档。</p>
<h3 id="celery">celery的核心概念</h3>
<ul>
<li>broker  任务队列服务提供者，celery推荐使用redis或者rabbitmq作为broker。</li>
<li>task 具体执行的任务，其实就是定义的一些函数。</li>
<li>backend 用来存储任务之后的输出结果</li>
<li>worker celery的启动就是开启一个worker。</li>
</ul>
<h3 id="django_1">django内文件安排</h3>
<p>本小节参考了 <a href="https://medium.com/@yehandjoe/celery-4-periodic-task-in-django-9f6b5a8c21c7">这篇文章</a> 和 <a href="http://geek.csdn.net/news/detail/128791">这篇文章</a> 。需要提醒读者的是，django和celery集成现在并不需要额外安装什么插件了，而且下面讲的配置实际上就是一个单独的celery app大部分都是类似的，只是多了一些细节上的处理和优化。</p>
<h4 id="celeryconfigpy">celeryconfig.py</h4>
<p>首先推荐在你的django app <code>settings.py</code> 旁新建个 <code>celeryconfig.py</code> 文件，有的教程让设置这个配置文件名字为 <code>celery.py</code> ，这样很不好，文件名和某个模块名字重复有时会出问题的。里面的内容如下：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">'DJANGO_SETTINGS_MODULE'</span><span class="p">,</span> <span class="s1">'project_name.settings'</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">'project_name'</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s1">'django.conf:settings'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">'CELERY'</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">debug_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Request: </span><span class="si">{0!r}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>
</pre></div>
<p>这个下面新建的任务不过是方便测试罢了，然后上面几行配置基本上死的。最值得讲的就是这两行：</p>
<div class="highlight"><pre><span></span><span class="err">app.config_from_object('django.conf:settings', namespace='CELERY')</span>
<span class="err">app.autodiscover_tasks()</span>
</pre></div>
<p>第一行是从django的配置对象中读取配置，特别注意的就是那个 <code>namespace='CELERY'</code> ，这样只有 <code>CELERY_</code> 开头的配置才会读取，而且对应原celery配置的关系是：</p>
<div class="highlight"><pre><span></span><span class="err">CELERY_BROKER_URL  -&gt; BROKER_URL</span>
</pre></div>
<p>我那次就是 <code>CELERY_BEAT_SCHEDULE</code> 写成了 <code>CELERYBEAT_SCHEDULE</code> 然后老实发现周期性程序启动不起来。</p>
<p>第二行也是一个优化细节，从函数名字也可以看到，就是自动发现任务。在你的django的其他app里面新建一个 <code>tasks.py</code> ，celery会自动发现你定义的任务。</p>
<h4 id="__init__py"><code>__init__.py</code></h4>
<p>还是你的django项目的project <code>settings.py</code> 那个文件夹里面，<code>__init__.py</code> 推荐写上这几行内容：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.celeryconfig</span> <span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">celery_app</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery_app'</span><span class="p">,)</span>
</pre></div>
<h4 id="settingspy">settings.py</h4>
<p>具体celery的一些配置就统一写在 <code>settings.py</code> 文件里面，上面也提到了，都要 <code>CELERY_</code> 开头，大体如下所示：</p>
<div class="highlight"><pre><span></span><span class="n">CELERY_BROKER_URL</span> <span class="o">=</span> <span class="s1">'redis://localhost:6379'</span>
<span class="c1">#CELERY_RESULT_BACKEND = 'redis://localhost:6379'</span>
<span class="c1">#CELERY_ACCEPT_CONTENT = ['application/json']</span>
<span class="c1">#CELERY_RESULT_SERIALIZER = 'json'</span>
<span class="c1">#CELERY_TASK_SERIALIZER = 'json'</span>
<span class="n">CELERY_TIMEZONE</span> <span class="o">=</span> <span class="s1">'Asia/Shanghai'</span>
<span class="c1"># schedules</span>
<span class="kn">from</span> <span class="nn">celery.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>
<span class="n">CELERY_BEAT_SCHEDULE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'crawl_juhe_every_one_hour'</span><span class="p">:</span> <span class="p">{</span>
         <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'wxarticles.tasks.crawl_juhe'</span><span class="p">,</span>
         <span class="s1">'schedule'</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="s1">'*/3'</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s1">'every_miniute_for_test'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'wxarticles.tasks.test_celery'</span><span class="p">,</span>
        <span class="s1">'schedule'</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(),</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
<h4 id="_36">定义任务</h4>
<p>好了，定义任务，实际上就是定义一个函数，比如下面这个简单的打印函数来确认celery周期程序是工作着的：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">shared_task</span>

<span class="nd">@shared_task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">test_celery</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'celery is working.'</span><span class="p">)</span>
</pre></div>
<p>celery的crontab功能很强大，比如上面的 <code>crontab()</code> 就是每分钟执行一次。具体请参看 <a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html">官方文档</a> 之。</p>
<h4 id="_37">启动任务</h4>
<p>和celery其他操作都是一样的，就是启动worker：</p>
<div class="highlight"><pre><span></span><span class="err">celery -A project_name worker -l info</span>
</pre></div>
<p><code>-A</code> 选项跟着 celery app的名字，在这里也就是django项目的名字。 <code>-l</code> 选项设置日志打印级别。</p>
<p>你还可以加上 <code>-B</code> 来同时启动周期性任务。</p>
<p>或者另外开个命令：</p>
<div class="highlight"><pre><span></span><span class="err">celery -A project_name beat -l info</span>
</pre></div>
<hr/>
<p>其他制作脚本啊，制作后台程序，制作服务啊，使用supervisor啊，实际上和celery关系已经不大了，可以不在这里说了。</p>
<h4 id="_38">手工启动一次任务</h4>
<p>参考了 <a href="https://stackoverflow.com/questions/12900023/how-can-i-run-a-celery-periodic-task-from-the-shell-manually">这个网页</a> 。</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">shell</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">my_task</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">eager_result</span> <span class="o">=</span> <span class="n">my_task</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
<h2 id="_39">翻译</h2>
<p>django的翻译其实已经很便捷了，因为我关注于后台api的编写，所以实际上很多教程说的：</p>
<div class="highlight"><pre><span></span><span class="err">TEMPLATES = [</span>
<span class="err">    {</span>
<span class="err">        ...</span>
<span class="err">        'OPTIONS': {</span>
<span class="err">            'context_processors': [</span>
<span class="err">                ...</span>
<span class="err">                'django.template.context_processors.i18n',</span>
<span class="err">            ],</span>
<span class="err">        },</span>
<span class="err">    },</span>
<span class="err">]</span>
</pre></div>
<p>这个配置只和模板输出的翻译有关，有需要再加上。</p>
<p>然后MIDDLESWARES 哪里要加上：</p>
<div class="highlight"><pre><span></span><span class="err">    'django.middleware.locale.LocaleMiddleware',</span>
</pre></div>
<p>然后就是这些配置：</p>
<div class="highlight"><pre><span></span><span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s1">'zh-Hans'</span>

<span class="n">USE_I18N</span> <span class="o">=</span> <span class="k">True</span>
</pre></div>
<p>设置好你的语言代码，这是没有问题的。</p>
<p>我看了一下 django restframework 的翻译管理相关，发现大体这样配置就可以了，很多教程说的设置 <code>LOCALE_PATHS</code> 变量觉得没必要，默认的每个app下面的locale文件夹够用了。</p>
<p>然后就是目标py文件下的 字符串 如下装饰之：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>
<span class="o">...</span>

        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">'Users must have a username.'</span><span class="p">))</span>
</pre></div>
<p>Model字段定义的名字可以加上，verbose_name 可以加上，然后异常信息可以加上等等。</p>
<p>加完了之后运行：</p>
<div class="highlight"><pre><span></span><span class="err">django-admin makemessages -l zh_Hans </span>
</pre></div>
<p>app下面没有locale文件夹的创建个就是了，某些文件你不想管，比如 manage.py ，那么加上 <code>--ignore</code> 选项即可。</p>
<p>windows下不是很方便，推荐在linux服务器下创建了目标 django.po 文件，然后再修改文件即可。其中po文件的头部有些东西，估计：</p>
<div class="highlight"><pre><span></span><span class="err">"Language: zh-Hans\n"</span>
</pre></div>
<p>已经是必填的，其他有时间也填上吧。</p>
<p>然后运行:</p>
<div class="highlight"><pre><span></span><span class="err">django-admin compilemessages </span>
</pre></div>
<p>如果不出意外的，翻译就已经生效了。</p>
<h2 id="app_1">创建可复用的app</h2>
<p>创建可复用的app会极大的降低你的目标django项目的复杂度，如果可能，将你的app打造成可复用的风格总是首选。</p>
<h3 id="django-whatpypi">制作django-what的pypi包</h3>
<p>有关pypi包的制作就不赘述了，下面主要在官方文档 <a href="https://docs.djangoproject.com/en/1.11/intro/reusable-apps/">这里</a> 的基础上讨论一些问题。</p>
<h3 id="_40">测试问题</h3>
<p>我试着如下安装测试过程：</p>
<div class="highlight"><pre><span></span><span class="err">python setup.py sdist</span>
<span class="err">pip install dist/what.tar.gz</span>
</pre></div>
<p>然后安装官方文档，在INSTALL_APPS那里设置好。app是可以正常使用的。但在安装测试过程中，这实在有点繁琐了。推荐还是将整个app文件夹复制到你的测试webapp那边去，然后一边修改一边看。测试好了再把内容同步到pypi安装包那边去。</p>
<h3 id="migrations">migrations问题</h3>
<p>官方文档之所以选择制作sdist和用pip install tar包这种风格是有原因的，经测试egg包在访问上很成问题，只有用pip安装这种方法，在site-packages那边你安装才是文件夹风格而不是那种egg文件。这样你等下执行：</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py makemigrations app_name</span>
</pre></div>
<p>才会成功。</p>
<p>而且实际生成的迁移文件就放在site-packages那里的目标文件夹下的。所以你制作pypi包的时候不要把migrations文件夹里面的其他迁移文件包含进去了，要包含就包含 <code>__init__.py</code> 文件即可。</p>
<p>当然就算你不是制作django的目标pypi包，其他django项目在 <code>.gitignore</code> 文件上加上这一行总是不错的：</p>
<div class="highlight"><pre><span></span><span class="err">*/migrations/*</span>
</pre></div>
<p>PS: 我知道stackoverflow那边都认为应该加上，还有人专门写了长篇大论认为应该加上。我确定的只有一点：早期测试开发过程，所有的migrations文件夹里面都只有 <code>__init__.py</code> 这个空白文件，保持代码整洁，在测试开发阶段不花精力在这上面，这是没有争议的。</p>
<h2 id="_41">部署</h2>
<p>这里所谓的部署就是用apache或nginx这样的web服务器来对接django项目，说的再具体一点就把django作为一个wsgi程序服务起来。</p>
<p>本文关于apache的部署讲解较为成熟。</p>
<h3 id="apache">apache</h3>
<p>上例子吧：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;IfModule</span> <span class="err">!wsgi_module</span><span class="nt">&gt;</span>
    LoadModule wsgi_module modules/mod_wsgi.so
<span class="nt">&lt;/IfModule&gt;</span>

WSGIPythonHome "/home/wanze/venv"
WSGIPythonPath "/home/wanze/venv/webapp"

<span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
    ServerName api.cdwanze.work

    WSGIScriptAlias / /home/wanze/venv/webapp/webapp/wsgi.py

    <span class="nt">&lt;Directory</span> <span class="err">/home/wanze/venv/webapp</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;IfVersion</span> <span class="nt">&gt;</span>= 2.4&gt;
            Require all granted
        <span class="nt">&lt;/IfVersion&gt;</span>
        <span class="nt">&lt;IfVersion</span> <span class="err">&lt;</span> <span class="err">2.4</span><span class="nt">&gt;</span>
            Order deny,allow
            Allow from all
        <span class="nt">&lt;/IfVersion&gt;</span>
    <span class="nt">&lt;/Directory&gt;</span>

    Alias "/static" "/home/wanze/venv/webapp/static"

    <span class="nt">&lt;Directory</span>  <span class="err">/home/wanze/venv/webapp/static</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;IfVersion</span> <span class="nt">&gt;</span>= 2.4&gt;
            Require all granted
        <span class="nt">&lt;/IfVersion&gt;</span>
        <span class="nt">&lt;IfVersion</span> <span class="err">&lt;</span> <span class="err">2.4</span><span class="nt">&gt;</span>
            Order deny,allow
            Allow from all
        <span class="nt">&lt;/IfVersion&gt;</span>
    <span class="nt">&lt;/Directory&gt;</span>

<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>
<ul>
<li>首先是检测wsgi模块加载了没有，没有把它加载上。</li>
<li>WSGIPythonHome 这个设置你的python的虚拟环境的所在目录，比如上面的例子 venv/bin下面就是python可执行脚本。</li>
<li>WSGIPythonPath 这个设置你的Django项目目录所在</li>
<li>WSGIScriptAlias 这个设置你的WSGI文件所在</li>
<li>Alias 和下面Directory 设置是服务你的项目的静态文件的。</li>
</ul>
<h3 id="_42">关于静态文件</h3>
<p>关于静态文件再补充下，上面服务的静态文件是在项目目录下的static文件夹下，这里所谓的静态文件主要是djano和djangorestframwork等框架带的静态文件，其通过  <code>python manage.py collectstatic</code> 命令来生成这些内容。</p>
<p>你需要在settings那里设置 <code>STATIC_ROOT</code> 值。</p>
<div class="highlight"><pre><span></span><span class="err">STATIC_ROOT= os.path.join(BASE_DIR, 'static')</span>
</pre></div>
<h3 id="django_2">多django站点部署问题</h3>
<p>多个django站点都通过 <code>mod_wsgi</code> 来部署是不能继续像前面那样写： </p>
<div class="highlight"><pre><span></span><span class="err">WSGIScriptAlias / /path/to/mysite.com/mysite/wsgi.py</span>
<span class="err">WSGIPythonHome /path/to/venv</span>
<span class="err">WSGIPythonPath /path/to/mysite.com</span>
</pre></div>
<p>而必须每个通过deamon模式来（参考了 <a href="https://stackoverflow.com/questions/14923083/multiple-sites-in-django">这个网页</a> ）：</p>
<div class="highlight"><pre><span></span><span class="err">&lt;VirtualHost *:80&gt;</span>
<span class="err">    ServerName api.cdwanze.work</span>
<span class="err">    WSGIDaemonProcess cdwanze_api  processes=1 python-path=/home/wanze/venv/myapi python-home=/home/wanze/venv/ threads=10  </span>
<span class="err">    WSGIProcessGroup cdwanze_api</span>
<span class="err">    WSGIScriptAlias / /home/wanze/venv/myapi/myapi/wsgi.py process-group=cdwanze_api</span>
<span class="err">    ...</span>
</pre></div>
<p>其中 <code>WSGIProcessGroup</code> 目前来看名字是随意的，但必须写。然后在定义daemon进程的时候 <code>python-path</code> 是定义到你的django project那里， <code>python-home</code> 是定义到你的python虚拟环境那里。</p>
<h3 id="_43">文件权限问题</h3>
<p>除了上面设置好 Directory 之外，你可能还会遇到其他某些文件的读写权限问题，在查看日志的时候发现提示说那个文件没有权限读写了。这个时候首先要明确httpd的执行User和Group是谁，然后在看目标文件夹或文件的具体权限。</p>
<p>Django项目的wsgi文件是需要有执行权限的。还有Django项目操纵数据库，比如sqlite3这种文件数据库，你可能也会遇到读写权限问题。</p>
<p>还有值得一提的是如果某个母文件夹没有可执行权限，那么里面的所有文件都是不可见的。</p>
<h3 id="nginx">nginx</h3>
<p>nginx要对接wsgi接口需要uwsgi这个模块将wsgi接口服务起来。</p>
<div class="highlight"><pre><span></span><span class="err">pip install uwsgi</span>
</pre></div>
<p>更多细节请参看uwsgi的 <a href="http://uwsgi-docs.readthedocs.io/en/latest/tutorials/Django_and_nginx.html">官方文档</a> 。</p>
<p>ngnix的配置如下：</p>
<div class="highlight"><pre><span></span><span class="nt">upstream</span> <span class="nt">django</span> <span class="p">{</span>
    <span class="err">server</span> <span class="err">127.0.0.1:8001</span><span class="p">;</span> 
<span class="p">}</span>

<span class="nt">server</span> <span class="p">{</span>
    <span class="err">location</span> <span class="err">/</span> <span class="err">{</span>
        <span class="err">uwsgi_pass</span>  <span class="err">django</span><span class="p">;</span>
        <span class="err">include</span>     <span class="err">/path/to/your/mysite/uwsgi_params</span><span class="p">;</span> 
    <span class="p">}</span>
<span class="err">}</span>
</pre></div>
<h4 id="nginx-serve">nginx serve 静态文件</h4>
<div class="highlight"><pre><span></span><span class="n">server</span> <span class="err">{</span>
    <span class="k">listen</span>      <span class="mi">80</span><span class="p">;</span>
    <span class="p">......</span>

    <span class="n">client_max_body_size</span> <span class="mi">75</span><span class="n">M</span><span class="p">;</span>

    <span class="k">location</span> <span class="o">/</span><span class="n">media</span>  <span class="err">{</span>
        <span class="k">alias</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="n">media</span><span class="p">;</span>
    <span class="err">}</span>

    <span class="k">location</span> <span class="o">/</span><span class="k">static</span> <span class="err">{</span>
        <span class="k">alias</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="k">static</span><span class="p">;</span>
    <span class="err">}</span>

    <span class="p">......</span>
<span class="err">}</span>
</pre></div>
<p>更多nginx配置细节请参看我写的关于nginx配置的专门的文章。</p>
<h2 id="_44">对外部署必看</h2>
<p>django项目如果对外部署的话，因为python是一个动态脚本语言，所以会有很多安全性的问题需要检查，否则你的项目对外会很不安全。本文主要参看官方文档的 <a href="https://docs.djangoproject.com/en/2.0/howto/deployment/checklist/">这里</a> 。</p>
<p>第一当然首先是确保 <code>DEBUG=False</code> ，对外开着 <code>DEBUG=True</code> 那简单是开玩笑了。</p>
<p>然后是运行：</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py check --deploy</span>
</pre></div>
<h3 id="settingspy_1">settings.py 里密钥外置</h3>
<p>settings.py 文件里面不要有任何密钥信息，包括 <code>SECRET_KEY</code> 你的数据库连接信息或者其他密钥等等，所有这些信息都应该作为环境变量引入或者从某个配置文件中读取出来。</p>
<h3 id="allowed_hosts">ALLOWED_HOSTS</h3>
<p>要某是限定好域名，要某是你的nginx服务器那边对入口请求已经做好了限定，凡是不认识的域名HOST请求都抛出444错误：</p>
<div class="highlight"><pre><span></span><span class="err">server {</span>
<span class="err">    listen 80 default_server;</span>
<span class="err">    return 444;</span>
<span class="err">}</span>
</pre></div>
<h2 id="api">API设计</h2>
<p>首先讲一下这里讨论的API设计和网络上流行的Restful风格的API设计都只是一般性原则，并不是强制性的要求。然后API还分为内部使用和对外的API，如果对外的API那么接口最好遵循无惊讶原则，遵循大家都通用的一些写法风格，但如果是内部使用的API，那么很多情况下，还要考虑自己内部使用的便捷性要求。</p>
<h3 id="url_2">url设计</h3>
<p>目前url域名都推荐使用 api.what.com 这样的风格，然后关于API的版本，在URL上加上版本号，并不是一个很好的主意。在当前前后端分离的大背景下，这给前端和后端的代码都带来了一些额外的复杂度。</p>
<p>版本号按照 <a href="http://www.ruanyifeng.com/blog/2011/09/restful.html">阮一峰的这篇文章</a> ，推荐使用 Accept 字段：</p>
<div class="highlight"><pre><span></span><span class="n">Accept</span><span class="o">:</span> <span class="n">vnd</span><span class="o">.</span><span class="na">example</span><span class="o">-</span><span class="n">com</span><span class="o">.</span><span class="na">foo</span><span class="o">+</span><span class="n">json</span><span class="o">;</span> <span class="n">version</span><span class="o">=</span><span class="mf">2.0</span>
</pre></div>
<p>url的第一个字段我喜欢使用django的app的名字，然后接下来的第二个字段推荐按照 Restful 风格写上目标资源的名字，并不一定要强制写上名词的复数形式，不过如果有两个url，一个是操纵目标资源集，一个是定向操纵某个目标资源，那么尾缀写上s区分是推荐的风格。</p>
<p>然后针对某个资源或者目标资源集的一些额外的动作，这里所谓的额外的动作是指除了常规的Restful风格的那些增删查改动作之外的额外的动作需求，在上面讨论的Restful风格url基础上加上第三个字段，第三个字段是额外动作的名字是个不错的风格。</p>
<h3 id="_45">方法设计</h3>
<p>方法通用的 GET POST ，GET用于查询获取资源信息，POST用于创建或修改信息这是没有疑问的。</p>
<p>虽然Restful风格还推荐的DELETE，PATCH等方法，但似乎大家实际编写都只是使用GET和POST方法。</p>
<h3 id="_46">参数设计</h3>
<p>查询操作如果针对的是目标资源集合，有以下参数是推荐加上的：</p>
<ul>
<li>limit 返回个数</li>
<li>offset 偏移值，可以通过它来实现分页效果</li>
<li>sort 或者sortby等，总之一个排序的参数</li>
<li>reverse 排序是否反转的参数</li>
</ul>
<h3 id="_47">状态码设计</h3>
<p>具体请参看HTTP的各个状态码。</p>
<h3 id="_48">返回内容结构设计</h3>
<p>我喜欢使用这种风格：</p>
<ol>
<li>成功则直接返回各个结果：</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">{</span>
<span class="err">    'a':1</span>
<span class="err">}</span>
</pre></div>
<p>有些人会说成功之后也应该加上code:200的代码，可是这是完全没有必要的，如果你需要获取数据，那么拿就是了，如果你怕数据不存在，那么加个针对目标数据的判断即可。加个code:200，但是目标数据字段还是不存在，程序不一样也会报错？</p>
<ol>
<li>失败则必须带上code错误码和msg错误信息</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">{</span>
<span class="err">    'code': 10001,</span>
<span class="err">    'msg': 'your error msg'</span>
<span class="err">}</span>
</pre></div>
<p>错误码软件系统内部应该有一个统一的规范，常见的错误类型有：</p>
<ul>
<li>资源没有找到</li>
<li>找到多个资源</li>
<li>未知错误</li>
<li>输入缺少参数</li>
</ul>
<h3 id="_49">编写良好的文档</h3>
<p>这是当然。</p>
<h2 id="_50">其他技巧</h2>
<h3 id="python2">模型python2兼容性</h3>
<p>为了提高模型python2兼容性，推荐模型定义上加个如下装饰器。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">python_2_unicode_compatible</span>


<span class="nd">@python_2_unicode_compatible</span> 
<span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">question_text</span>
</pre></div>
<p>以前不加这个装饰器，python2之前用的是 <code>__unicode__</code> 方法。</p>
<h3 id="migrations_1">重置migrations</h3>
<p>一般的方法把migrations文件删掉，把表格删掉并不能成功，因为他们忽视了django_migrations这个表格里面的数据（参考了 <a href="https://stackoverflow.com/questions/23755523/how-to-reset-migrations-in-django-1-7">这个网页</a>）。</p>
<p>如果你把 <code>django_migrations</code> 里面的对应app的迁移数据删掉，然后再makemigrations和migrate，那么就更重新开始的一样。</p>
<div class="highlight"><pre><span></span><span class="err">python manage.py makemigrations app_name</span>
<span class="err">python manage.py migrate app_name</span>
</pre></div>
<h3 id="_51">处理列表对象</h3>
<p>我们需要自定义一个model的新Field对象来解决这个问题，具体就叫做ListField。</p>
<div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">parse_to_python</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">except</span> <span class="k">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rasie</span> <span class="n">ValidationError</span>


<span class="k">class</span> <span class="n">ListField</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">TextField</span><span class="p">):</span>
    <span class="ss">"""</span>
<span class="ss">    存储python列表对象</span>
<span class="ss">    """</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="ss">"Stores a python list"</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">super</span><span class="p">(</span><span class="n">ListField</span><span class="p">,</span> <span class="k">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">to_python</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="k">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">parse_to_python</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">get_prep_value</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="k">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">six</span><span class="p">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">def</span> <span class="n">value_to_string</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="k">self</span><span class="p">.</span><span class="n">value_from_object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">self</span><span class="p">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">from_db_value</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="k">connection</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="k">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">parse_to_python</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
<ul>
<li><code>from_db_value</code> 当数据从数据库里面读取出来，总会调用这个方法。包括（including in aggregates and <a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/#django.db.models.query.QuerySet.values"><code>values()</code></a> calls。 所以这是最重要最核心的一个定制方法，其含义是很明显的，不用多说了。</li>
</ul>
<hr/>
<p>这四个方法大体如下流程：</p>
<div class="highlight"><pre><span></span><span class="n">python</span>  <span class="o">&lt;-</span> <span class="n">to_python</span>  <span class="o">&lt;-</span>   <span class="n">from_db_value</span><span class="o">&lt;-</span> <span class="n">database</span>

<span class="n">python</span> <span class="o">-&gt;</span><span class="n">value_to_string</span> <span class="o">-&gt;</span> <span class="n">get_prep_value</span> <span class="o">-&gt;</span> <span class="n">database</span>
</pre></div>
<p><strong>NOTICE</strong> 上图主要是方便读者理解，实际上django并不是这样逐个处理的。按照官方文档的说法 <code>to_python</code> 和django的反序列（deserialization ）有关，其还必须处理好三种情况：None，目标对象，字符串情况。</p>
<p><code>value_to_string</code> 和序列化有关，和<code>to_python</code> 是相对的。<code>get_prep_value</code> 和我们在输入get(what='20170809') 执行查询是有关，讲过其转化成为sql实际查询中用到的字符串（比如说datetimefield）就做了一些额外的处理工作。 </p>
<h3 id="_52">多数据库处理</h3>
<p>一个django项目里面可能因为某些原因，某些app需要单独操作另外的数据库，这种情况你首先在 <code>settings</code> 那里定义好数据库的配置：</p>
<div class="highlight"><pre><span></span><span class="err">    DATABASES = {</span>
<span class="err">        'default': {</span>
<span class="err">            ...</span>
<span class="err">        },</span>
<span class="err">        'newdb': {</span>
<span class="err">            'ENGINE': 'django.db.backends.mysql',</span>
<span class="err">            ...</span>
<span class="err">        },</span>
</pre></div>
<p>然后加上这个dbroute对象：</p>
<div class="highlight"><pre><span></span><span class="err">DATABASE_ROUTERS = ['articles.dbrouter.ArticlesRouter']</span>
</pre></div>
<p>然后在你的app那里定义好dbroute对象：</p>
<div class="highlight"><pre><span></span><span class="x">class ArticlesRouter(object):</span>
<span class="x">    def db_for_read(self, model, **hints):</span>
<span class="x">        if model._meta.app_label == 'articles':</span>
<span class="x">            return 'articles'</span>
<span class="x">        return None</span>

<span class="x">    def db_for_write(self, model, **hints):</span>
<span class="x">        if model._meta.app_label == 'articles':</span>
<span class="x">            return 'articles'</span>
<span class="x">        return None</span>

<span class="x">    def allow_relation(self, obj1, obj2, **hints):</span>
<span class="x">        if obj1._meta.app_label == 'articles' or \</span>
<span class="x">            obj2._meta.app_label == 'articles':</span>
<span class="x">            return True</span>
<span class="x">        return None</span>

<span class="x">    def allow_migrate(self, db, app_label, model_name=None, **hints):</span>
<span class="x">        if app_label == 'articles':</span>
<span class="x">            return db == 'articles'</span>
<span class="x">        return None</span>
</pre></div>
<p>从上面的代码可以看出来，你定义的模型 <code>Meta</code> 那里必须定义好 <code>app_label</code> 属性。更多信息请参看官方文档的 <a href="https://docs.djangoproject.com/en/1.11/topics/db/multi-db">这里</a> 。</p>
<h3 id="django_3">如何根据django的模型对象来获取其对应的表格的名字</h3>
<p>参看 <a href="http://stackoverflow.com/questions/233045/how-to-read-the-database-table-name-of-a-model-instance">这个网页</a> 。</p>
<p>答: </p>
<div class="highlight"><pre><span></span><span class="err">model_instance._meta.db_table</span>
</pre></div>
<h3 id="djangoimagefield">如何使用好django的ImageField</h3>
<p>参考了 <a href="http://gregblogs.com/django-saving-an-image-using-imagefield-explain-a-little/">这篇文章</a> 。</p>
<p>ImageField和FileField很类似，除了还多了 <code>width</code> 和 <code>height</code> 属性，然后就是在上传的时候确保文件是图片文件。</p>
<p>具体在模型文件中的定义如下:</p>
<div class="highlight"><pre><span></span><span class="err">banner = models.ImageField(upload_to=game_2048_images, blank=True,</span>
<span class="err">                           storage=OverwriteStorage(), default="placeholder.jpg")</span>
</pre></div>
<p>上面的 <code>upload_to</code> 是控制图片在计算机中的保存路径，可以直接指定一个文件夹路径，但这通常不够灵活，这里通过一个函数来实现更加灵活的路径指定:</p>
<div class="highlight"><pre><span></span><span class="err">def game_2048_images(instance, filename):</span>
<span class="err">    """</span>
<span class="err">    where image upload to.</span>
<span class="err">    """</span>
<span class="err">    return 'game/2048/images/{}/{}'.format(instance.user.username, filename)</span>
</pre></div>
<p>这里具体路径是根据你在 <code>settings</code> 里面指定的 <code>MEDIA_ROOT</code> 而来，然后再指定里面的具体的文件夹路径。我们看到函数还可以接受具体模型对应的实例，从而建立自动根据user用户名来分配不同的文件夹路径。</p>
<p><code>storage=OverwriteStorage()</code> 实现了如果文件名重复则覆盖的逻辑:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">OverwriteStorage</span>(<span class="n">FileSystemStorage</span>):
    <span class="s">'''</span>
<span class="s">    存储文件或图片，如果文件名重复则覆盖。</span>
<span class="s">    '''</span>

    <span class="n">def</span> <span class="n">get_available_name</span>(<span class="k">self</span>, <span class="nb">name</span>):
        <span class="k">if</span> <span class="k">self</span>.<span class="nb">exists</span>(<span class="nb">name</span>):
            <span class="n">os</span>.<span class="n">remove</span>(<span class="n">os</span>.<span class="n">path</span>.<span class="nb">join</span>(<span class="n">settings</span>.<span class="n">MEDIA_ROOT</span>, <span class="nb">name</span>))
        <span class="k">return</span> <span class="nb">name</span>
</pre></div>
<p>ImageField 可以和rest_framework的序列化类形成很好的联动，最后序列化之后返回的是文件路径url字符串，测试的时候我们可以如下用django来挂载这些静态资源文件，实际运营的时候则推荐用nginx怎么设置一下url分发。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls.static</span> <span class="kn">import</span> <span class="n">static</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
    <span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">static</span><span class="p">(</span><span class="s1">'/data/'</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">)</span>
</pre></div>
<p>在保存传过来的图片文件的时候，常规构建form对象也是可行的:</p>
<div class="highlight"><pre><span></span><span class="n">form</span> <span class="o">=</span> <span class="n">Game2048InfoForm</span><span class="p">(</span>
    <span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">FILES</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">target_info</span><span class="p">)</span>

<span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="n">is_valid</span><span class="p">():</span>
    <span class="n">new_game_info</span> <span class="o">=</span> <span class="n">form</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">'form invalid'</span><span class="p">)</span>
</pre></div>
<p>否则你需要通过:</p>
<div class="highlight"><pre><span></span><span class="err">request.FILES['imgfield']</span>
</pre></div>
<p>这样的语法来获取图片内容。</p>
<h3 id="djangomessages">django的messages系统</h3>
<p>本小节主要参看了 <a href="https://www.webforefront.com/django/setupdjangomessages.html">这个网页</a> 。</p>
<p>使用django的messages系统，首先需要如下所示在settings里面进行一些配置：</p>
<div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="p">......</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="p">,</span>
    <span class="p">......</span>

<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="err">{</span>
         <span class="s1">'OPTIONS'</span><span class="p">:</span> <span class="err">{</span>
            <span class="s1">'context_processors'</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">'django.contrib.messages.context_processors.messages'</span><span class="p">,</span>
                <span class="p">......</span>
</pre></div>
<p>然后在views那边，使用 <code>messages.add_message()</code> 来往django信息系统里面发送一个信息，此外还有如下的这些快捷方法：</p>
<ul>
<li>messages.debug()</li>
<li>messages.info()</li>
<li>messages.success()</li>
<li>messages.warning()</li>
<li>messages.error()</li>
</ul>
<p>你还可以如下设置每个request请求下的信息系统级别：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="n">messages</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</pre></div>
<p>下面我定义了一个简单的flash函数</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flash</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">'info'</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    利用django的message系统发送一个信息，对接模板的sweetalert。</span>
<span class="sd">    """</span>
    <span class="n">level_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'info'</span><span class="p">:</span> <span class="n">messages</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="s1">'debug'</span><span class="p">:</span> <span class="n">messages</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="s1">'success'</span><span class="p">:</span> <span class="n">messages</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
        <span class="s1">'warning'</span><span class="p">:</span> <span class="n">messages</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
        <span class="s1">'error'</span><span class="p">:</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="p">}</span>

    <span class="n">level</span> <span class="o">=</span> <span class="n">level_map</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>

    <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'ok'</span>
</pre></div>
<p>之所以做这样的封装是为了更好地对接sweetalert这个javascript库，然后模块加入如下内容从而从而实现信息的具体弹出行为。</p>
<div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">"</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">'js/sweetalert.min.js'</span> <span class="cp">%}</span><span class="s">"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">msg</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
    sweetAlert({
        title: '<span class="cp">{{</span><span class="nv">msg.extra_args</span><span class="cp">}}</span>',
        text: '<span class="cp">{{</span> <span class="nv">msg.message</span> <span class="cp">}}</span>',
        type: '<span class="cp">{{</span> <span class="nv">msg.level_tag</span> <span class="cp">}}</span>',
      })
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</pre></div>
<h3 id="csrf">csrf认证失败</h3>
<p>一般提到的表单那边加上：</p>
<div class="highlight"><pre><span></span><span class="err">&lt;form method="post"&gt;{% csrf_token %}</span>
</pre></div>
<p>但后来我还是遇到csrf认证失败问题，最后参考 <a href="https://stackoverflow.com/questions/38841109/csrf-validation-does-not-work-on-django-using-https">这个问题的答案</a> 如下设置才可以。</p>
<div class="highlight"><pre><span></span><span class="err">CSRF_TRUSTED_ORIGINS = ['www.cdwanze.work']</span>
</pre></div>
            
            
            <hr/>

        </div>
        <section>
        <div class="col-md-2" style="float:right;font-size:0.9em;">
            <h4>首发于：</h4>
            <time pubdate="pubdate" datetime="2012-12-21T00:00:00+08:00">2012年 12月 21日 </time>
            <h4>分类：</h4>
            <a class="category-link" href="https://docs.cdwanze.work/categories.html#cun-dang-ref">存档</a>
            <h4>标签：</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://docs.cdwanze.work/tags.html#django-ref">django
                    <span>1</span>
</a></li>
            </ul>
        </div>
        </section>
</div>
</article>
    </div>
    <div class="col-md-1"></div>

</div>


<div id="push"></div>


<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a> and updated by <a href="http://docs.cdwanze.work" title="cdwanze Home Page">cdwanze</a></li>
    </ul>
</div>
</footer>

        <script src="https://docs.cdwanze.work/theme/js/jquery.min.js"></script>
    <script src="https://docs.cdwanze.work/theme/js/bootstrap.min.js"></script>
    <script>
        function validateForm(query) {
            return (query.length > 0);
        }
    </script>

    <script>
        function adjust_search_width() {
            var w = document.documentElement.clientWidth;
            if ((w > 755) && (w < 975)) {
                plus_width = w - 755;
                $('.navbar-form .form-control').outerWidth(210 + plus_width);
            } else if (w >= 975) {
                $('.navbar-form .form-control').outerWidth(210 + 220);
            } else if (w <= 755) {
                $('.navbar-form .form-control').css('width', '100%')
            }
        }

        function adjust_markdown_css(){
            $('table').addClass('table');
            $('table').addClass('table-striped');
        }

        $(document).ready(function () {
            adjust_search_width();
            adjust_markdown_css();
        });

        window.onresize = function () {
            adjust_search_width();
        }

    </script>


    



</body>
</html>