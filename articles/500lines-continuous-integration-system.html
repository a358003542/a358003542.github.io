<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="msvalidate.01" content="55CB117A61A6F8286173763FB18D9625" />

    <meta name="author" content="wanze" />
    <meta name="copyright" content="wanze" />

    <meta name="description"
        content="前言 本文讨论的500lines项目的一个简单的持续集成系统文章在这里：(aosabook.org) 。 持续集成系统简称CI system，其作用主要是当有新的代 …" />


<meta name="keywords" content="500lines, 备用, " />

<title>500lines项目之一个持续集成系统  -
    万泽的博客</title>

    <link href="https://a358003542.github.io/theme/dist/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://a358003542.github.io/theme/dist/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <link href="https://a358003542.github.io/theme/css/base.css" rel="stylesheet">

<link rel="stylesheet" href="https://a358003542.github.io/theme/css/pygments.css">
<link rel="stylesheet" href="https://a358003542.github.io/theme/css/article.css">
</head>

<body>
    <div class="flex-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="https://a358003542.github.io/">网站首页</a>

                <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse"
                    data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>


                <div class="navbar-collapse collapse" id="navbarContent">
                    <form action="https://a358003542.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"
                        class="d-flex me-auto">

                        <input type="search" name="q" id="tipue_search_input" class="form-control me-2"
                            placeholder="Search..." aria-label="Search">

                        <button class="btn btn-outline-primary text-nowrap" type="submit">搜索</button>
                    </form>


                    <ul class="navbar-nav mb-lg-0">

                        <li class="nav-item ">
                            <a class="nav-link "
                                href="/archives.html">所有博文</a>
                        </li>

                        <li class="nav-item ">
                            <a class="nav-link "
                                href="/categories.html">博文分类</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link  " href="https://a358003542.github.io/about.html">关于本网站</a>
                        </li>
                    </ul>


                </div>
            </div>
        </nav>


<div class="container-xxl mt-3">
    <div class="row">
        <div class="col-md-4 col-lg-3"></div>
        <header class="col-sm-12 col-md-8 col-lg-8 page-header">
            <h1><a href="https://a358003542.github.io/articles/500lines-continuous-integration-system.html"> 500lines项目之一个持续集成系统  </a></h1>
        </header>
    </div>

    <div class="row">
        <div class="col-sm-12 col-md-4 col-lg-3">
            <div class="p-3 bg-white small">
                <div style="font-size:1.2rem;">目录</div>
                <div class="toc">
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#观察组件">观察组件</a></li>
<li><a href="#任务分发器">任务分发器</a></li>
<li><a href="#任务运行器">任务运行器</a></li>
<li><a href="#总结">总结</a></li>
</ul>
</div>

                <div class="p-1">首发于：<time pubdate="pubdate" datetime="2020-12-07T00:00:00+08:00">2020年 12月 7日 </time>
                </div>

                <div class="p-1">最近更新于：<time datetime="2021-01-17T05:02:26.199220+08:00">2021年 1月 17日 </time>
                </div>


                <div class="p-1">分类：
                <a class="category-link" href="https://a358003542.github.io/categories.html#bei-yong-ref">备用</a>
                </div>

                <div class="p-1">标签：
                <ul class="list-of-tags tags-in-article"><li><a href="https://a358003542.github.io/tags.html#500lines-ref">500lines<span>3</span></a></li></ul>
                </div>
            </div>
        </div>

        <div class="col-sm-12 col-md-8 col-lg-8">
            <div class="article-content">
                
<h2 id="前言">前言</h2>
<p>本文讨论的500lines项目的一个简单的持续集成系统文章在这里：<a href="http://aosabook.org/en/500L/a-continuous-integration-system.html">(aosabook.org)</a> 。</p>
<p>持续集成系统简称CI system，其作用主要是当有新的代码提交时，确保该提交没有中断任何测试。因此持续集成系统主要工作就是获取新的代码提交，运行测试并报告结果。</p>
<p>一个简单的持续集成系统包含三个部分：一个观察组件，一个测试任务分发器和一个测试任务运行器。</p>
<p>一个理想的持续集成系统应该是能容错的和承压的，如果是单机器单进程运行上面的三个任务则是不能容错和承压的。所以接下来项目在设计上让这三个任务或者说三个组件是分开的三个进程。然后这三个进程之间通信采用套接字形式，也因此现在该持续集成系统具有分布式的特性了。</p>
<p>这种分布式设计进一步可以引入计算机架构设计上的故障切换机制，即某个机器发生故障了，马上另外一个备用的机器将会顶替其工作。</p>
<p>我对该项目代码进行了一些修改，具体参见 <a href="https://github.com/a358003542/500lines_ci">a358003542/500lines_ci: 500lines a continuous integration system (github.com)</a> 。项目python代码更新为了python3版本。项目为了更具平台扩展性使用gitpython而不适用sh脚本。</p>
<h2 id="观察组件">观察组件</h2>
<p>观察组件是 <code>repo_observer.py</code> 文件。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="n">Repo</span>
<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="kn">from</span> <span class="nn">helpers</span> <span class="kn">import</span> <span class="n">COMMIT_ID_FILE</span><span class="p">,</span> <span class="n">run_or_fail</span><span class="p">,</span> <span class="n">communicate</span>
<span class="kn">from</span> <span class="nn">helpers</span> <span class="kn">import</span> <span class="n">COMMUNICATE_OK</span><span class="p">,</span> <span class="n">COMMUNICATE_STATUS</span>

<span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"repo_observer.log"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">poll</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--dispatcher-server"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"dispatcher host:port, "</span> \
                             <span class="s2">"by default it uses localhost:8888"</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">"localhost:8888"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"repo"</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">"REPO"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"path to the repository this will observe"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">dispatcher_host</span><span class="p">,</span> <span class="n">dispatcher_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">update_repo</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">repo</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">COMMIT_ID_FILE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">communicate</span><span class="p">(</span><span class="n">dispatcher_host</span><span class="p">,</span>
                                       <span class="nb">int</span><span class="p">(</span><span class="n">dispatcher_port</span><span class="p">),</span>
                                       <span class="n">COMMUNICATE_STATUS</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">"Could not communicate with dispatcher server: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">COMMUNICATE_OK</span><span class="p">:</span>
                <span class="n">commit</span> <span class="o">=</span> <span class="s2">""</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">COMMIT_ID_FILE</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">commit</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

                <span class="n">response</span> <span class="o">=</span> <span class="n">communicate</span><span class="p">(</span><span class="n">dispatcher_host</span><span class="p">,</span>
                                       <span class="nb">int</span><span class="p">(</span><span class="n">dispatcher_port</span><span class="p">),</span>
                                       <span class="sa">f</span><span class="s2">"dispatch:</span><span class="si">{</span><span class="n">commit</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">COMMUNICATE_OK</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Could not dispatch the test: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span>
                                    <span class="n">response</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"dispatched!"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Something wrong happened to the dispatcher</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Could not dispatch the test: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span>
                                <span class="n">response</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">update_repo</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">git</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">git</span>

    <span class="n">run_or_fail</span><span class="p">(</span><span class="n">git</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'HEAD'</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'hard'</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="n">info</span><span class="o">=</span><span class="s1">'Could not reset git'</span><span class="p">)</span>

    <span class="c1"># get the most recent commit</span>
    <span class="n">log_info</span> <span class="o">=</span> <span class="n">run_or_fail</span><span class="p">(</span><span class="n">git</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'-n1'</span><span class="p">,),</span>
                           <span class="n">info</span><span class="o">=</span><span class="s2">"Could not call 'git log' on repository"</span><span class="p">)</span>

    <span class="n">last_commit_id</span> <span class="o">=</span> <span class="n">log_info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">run_or_fail</span><span class="p">(</span><span class="n">git</span><span class="o">.</span><span class="n">pull</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">"Could not pull from repository"</span><span class="p">)</span>

    <span class="n">new_log_info</span> <span class="o">=</span> <span class="n">run_or_fail</span><span class="p">(</span><span class="n">git</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'-n1'</span><span class="p">,),</span>
                               <span class="n">info</span><span class="o">=</span><span class="s2">"Could not call 'git log' on repository"</span><span class="p">)</span>

    <span class="n">new_commit_id</span> <span class="o">=</span> <span class="n">new_log_info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">new_commit_id</span> <span class="o">!=</span> <span class="n">last_commit_id</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'found changes.'</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">COMMIT_ID_FILE</span><span class="p">,</span> <span class="s1">'wt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">new_commit_id</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">poll</span><span class="p">()</span>
</code></pre></div>
<p>观察组件通过分析clone的观察仓库的commit_it和更新仓库后的commit_id，如果发现不同，则说明仓库代码有变化，那么将会把最新的commit_id写入一个文件中。</p>
<p>后面发现了这个文件将会向任务分发器发送一个信号，分发一个新的任务。观察组件套接字信号交流上很简单，此外还有一个状态确认和OK返回。</p>
<h2 id="任务分发器">任务分发器</h2>
<p>任务分发器是 <code>dispatcher.py</code> 。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">socketserver</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="kn">from</span> <span class="nn">helpers</span> <span class="kn">import</span> <span class="n">communicate</span><span class="p">,</span> <span class="n">COMMUNICATE_PING</span><span class="p">,</span> <span class="n">COMMUNICATE_PONG</span><span class="p">,</span> \
    <span class="n">COMMUNICATE_STATUS</span><span class="p">,</span> <span class="n">COMMUNICATE_OK</span><span class="p">,</span> <span class="n">COMMUNICATE_REGISTER</span><span class="p">,</span> \
    <span class="n">COMMUNICATE_DISPATCH</span><span class="p">,</span> <span class="n">COMMUNICATE_RESULT</span>

<span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"dispatcher.log"</span><span class="p">)</span>


<span class="c1"># Shared dispatcher code</span>
<span class="k">def</span> <span class="nf">dispatch_tests</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">commit_id</span><span class="p">):</span>
    <span class="c1"># NOTE: usually we don't run this forever</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"trying to dispatch to runners"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">communicate</span><span class="p">(</span><span class="n">runner</span><span class="p">[</span><span class="s2">"host"</span><span class="p">],</span>
                                   <span class="nb">int</span><span class="p">(</span><span class="n">runner</span><span class="p">[</span><span class="s2">"port"</span><span class="p">]),</span>
                                   <span class="sa">f</span><span class="s2">"runtest:</span><span class="si">{</span><span class="n">commit_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">COMMUNICATE_OK</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"adding id </span><span class="si">{</span><span class="n">commit_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">server</span><span class="o">.</span><span class="n">dispatched_commits</span><span class="p">[</span><span class="n">commit_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">runner</span>
                <span class="k">if</span> <span class="n">commit_id</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">pending_commits</span><span class="p">:</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">pending_commits</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span>
                <span class="k">return</span>  <span class="c1"># first response runner</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ThreadingTCPServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingMixIn</span><span class="p">,</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="n">runners</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Keeps track of test runner pool</span>
    <span class="n">dead</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Indicate to other threads that we are no longer running</span>
    <span class="n">dispatched_commits</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Keeps track of commits we dispatched</span>
    <span class="n">pending_commits</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Keeps track of commits we have yet to dispatch</span>


<span class="k">class</span> <span class="nc">DispatcherHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    The RequestHandler class for our dispatcher.</span>
<span class="sd">    This will dispatch test runners against the incoming commit</span>
<span class="sd">    and handle their requests and test results</span>
<span class="sd">    """</span>

    <span class="n">command_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(\w+)(:.+)*"</span><span class="p">)</span>
    <span class="n">BUF_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.request is the TCP socket connected to the client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BUF_SIZE</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">command_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">command_groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">"Invalid command"</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">command_groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="n">COMMUNICATE_STATUS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"COMMUNICATE_STATUS"</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">COMMUNICATE_OK</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="n">COMMUNICATE_REGISTER</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">command_groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">":(\w*)"</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"host"</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s2">"port"</span><span class="p">:</span> <span class="n">port</span><span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"COMMUNICATE_REGISTER: runner on </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">runners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">COMMUNICATE_OK</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="n">COMMUNICATE_DISPATCH</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"COMMUNICATE_DISPATCH"</span><span class="p">)</span>
            <span class="n">commit_id</span> <span class="o">=</span> <span class="n">command_groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">"No runners are registered"</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The coordinator can trust us to dispatch the test</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">COMMUNICATE_OK</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">dispatch_tests</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">commit_id</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="n">COMMUNICATE_RESULT</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"COMMUNICATE_RESULT"</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">command_groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
            <span class="n">commit_id</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">length_msg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># 3 is the number of ":" in the sent command</span>
            <span class="n">remaining_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BUF_SIZE</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">length_msg</span> <span class="o">&gt;</span> <span class="n">remaining_buffer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span>
                    <span class="n">length_msg</span> <span class="o">-</span> <span class="n">remaining_buffer</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">dispatched_commits</span><span class="p">[</span><span class="n">commit_id</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">"test_results"</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">"test_results"</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"test_results/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">commit_id</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)[</span><span class="mi">3</span><span class="p">:]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">COMMUNICATE_OK</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">"Invalid command"</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">serve</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--host"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"dispatcher's host, by default it uses localhost"</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">"localhost"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--port"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"dispatcher's port, by default it uses 8888"</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">8888</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Create the server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadingTCPServer</span><span class="p">((</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)),</span> <span class="n">DispatcherHandler</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">'serving on </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="c1"># Create a thread to check the runner pool</span>
    <span class="k">def</span> <span class="nf">runner_checker</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">manage_commit_lists</span><span class="p">(</span><span class="n">runner</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">commit</span><span class="p">,</span> <span class="n">assigned_runner</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">dispatched_commits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">assigned_runner</span> <span class="o">==</span> <span class="n">runner</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">server</span><span class="o">.</span><span class="n">dispatched_commits</span><span class="p">[</span><span class="n">commit</span><span class="p">]</span>
                    <span class="c1"># runner is not ok, remove it to pending list</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">pending_commits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="n">server</span><span class="o">.</span><span class="n">runners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">server</span><span class="o">.</span><span class="n">dead</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">communicate</span><span class="p">(</span><span class="n">runner</span><span class="p">[</span><span class="s2">"host"</span><span class="p">],</span>
                                           <span class="nb">int</span><span class="p">(</span><span class="n">runner</span><span class="p">[</span><span class="s2">"port"</span><span class="p">]),</span>
                                           <span class="n">COMMUNICATE_PING</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">COMMUNICATE_PONG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"removing runner </span><span class="si">{</span><span class="n">runner</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                        <span class="n">manage_commit_lists</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">manage_commit_lists</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>

    <span class="c1"># this will kick off tests that failed</span>
    <span class="k">def</span> <span class="nf">redistribute</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">server</span><span class="o">.</span><span class="n">dead</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">commit</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">pending_commits</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"running redistribute"</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">pending_commits</span><span class="p">)</span>
                <span class="n">dispatch_tests</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">commit</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">runner_heartbeat</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">runner_checker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">server</span><span class="p">,))</span>
    <span class="n">redistributor</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">redistribute</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">server</span><span class="p">,))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">runner_heartbeat</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">redistributor</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1"># Activate the server; this will keep running until you</span>
        <span class="c1"># interrupt the program with Ctrl+C or Cmd+C</span>
        <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
        <span class="c1"># if any exception occurs, kill the thread</span>
        <span class="n">server</span><span class="o">.</span><span class="n">dead</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">runner_heartbeat</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">redistributor</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">serve</span><span class="p">()</span>
</code></pre></div>
<p>任务分发器在任务上和套接字信号上稍微复杂了一点。后面那两个子线程任务主要就是完成这个工作：任务运行器健康度检查，如果某个任务运行器突然挂掉了，那么将会把之前分配给的任务再发一次。</p>
<p>核心流程继续之前的dispatch命令来就直接运行<code>dispatch_tests</code> 来实际分发任务了。</p>
<p>任务分发器在套接字信号上一是STATUS-OK回报，一是任务运行器刚开始需要在任务分发器这边注册的。最后RESULT只是一个后续任务运行之后结果收集机制。</p>
<h2 id="任务运行器">任务运行器</h2>
<p>任务运行器是 <code>test_runner.py</code> 这个文件。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">socketserver</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="n">Repo</span>
<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="kn">from</span> <span class="nn">helpers</span> <span class="kn">import</span> <span class="n">run_or_fail</span><span class="p">,</span> <span class="n">communicate</span><span class="p">,</span> <span class="n">COMMIT_ID_FILE</span><span class="p">,</span> <span class="n">COMMUNICATE_OK</span><span class="p">,</span> \
    <span class="n">COMMUNICATE_STATUS</span><span class="p">,</span> <span class="n">COMMUNICATE_PING</span><span class="p">,</span> <span class="n">COMMUNICATE_PONG</span><span class="p">,</span> <span class="n">COMMUNICATE_RUNTEST</span><span class="p">,</span> \
    <span class="n">COMMUNICATE_RESULT</span>

<span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"test_runner.log"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ThreadingTCPServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingMixIn</span><span class="p">,</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="n">dispatcher_server</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Holds the dispatcher server host/port information</span>
    <span class="n">last_communication</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Keeps track of last communication from dispatcher</span>
    <span class="n">busy</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Status flag</span>
    <span class="n">dead</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Status flag</span>


<span class="k">class</span> <span class="nc">TestHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    The RequestHandler class for our server.</span>
<span class="sd">    """</span>

    <span class="n">command_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(\w+)(:.+)*"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.request is the TCP socket connected to the client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">command_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">command_groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">"Invalid command"</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="n">COMMUNICATE_PING</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"COMMUNICATE_PING"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">last_communication</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">COMMUNICATE_PONG</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="n">COMMUNICATE_RUNTEST</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"got runtest command: am I busy? </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">busy</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">busy</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"COMMUNICATE_BUSY"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">"BUSY"</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">COMMUNICATE_OK</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"COMMUNICATE_RUNTEST"</span><span class="p">)</span>
                <span class="n">commit_id</span> <span class="o">=</span> <span class="n">command_groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">busy</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="n">commit_id</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">repo_folder</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">busy</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">"Invalid command"</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit_id</span><span class="p">,</span> <span class="n">repo_folder</span><span class="p">):</span>
        <span class="c1"># update git repo</span>
        <span class="n">test_runner_script</span><span class="p">(</span><span class="n">repo_folder</span><span class="p">,</span> <span class="n">commit_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">"results"</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">"results"</span><span class="p">)</span>

        <span class="c1"># run the tests</span>
        <span class="n">test_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repo_folder</span><span class="p">,</span> <span class="s2">"tests"</span><span class="p">)</span>
        <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span><span class="p">()</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="n">test_folder</span><span class="p">)</span>
        <span class="n">result_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"results"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span>
        <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">result_file</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
        <span class="n">result_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"results"</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">result_file</span><span class="p">:</span>
            <span class="c1"># give the dispatcher the results</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">result_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">communicate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="p">[</span><span class="s2">"host"</span><span class="p">],</span>
                        <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="p">[</span><span class="s2">"port"</span><span class="p">]),</span>
                        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">COMMUNICATE_RESULT</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">commit_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">serve</span><span class="p">():</span>
    <span class="n">range_start</span> <span class="o">=</span> <span class="mi">8900</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--host"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"runner's host, by default it uses localhost"</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">"localhost"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--port"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"runner's port, by default it uses values &gt;=</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">range_start</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--dispatcher-server"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"dispatcher host:port, by default it uses "</span> \
                             <span class="s2">"localhost:8888"</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">"localhost:8888"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"repo"</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">"REPO"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"path to the repository this will observe"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">runner_host</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">host</span>
    <span class="n">runner_port</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">:</span>
        <span class="n">runner_port</span> <span class="o">=</span> <span class="n">range_start</span>
        <span class="k">while</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadingTCPServer</span><span class="p">((</span><span class="n">runner_host</span><span class="p">,</span> <span class="n">runner_port</span><span class="p">),</span>
                                            <span class="n">TestHandler</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">runner_port</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EADDRINUSE</span><span class="p">:</span>
                    <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">runner_port</span> <span class="o">=</span> <span class="n">runner_port</span> <span class="o">+</span> <span class="n">tries</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Could not bind to ports in range </span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">range_start</span><span class="p">,</span> <span class="n">range_start</span> <span class="o">+</span> <span class="n">tries</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">runner_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadingTCPServer</span><span class="p">((</span><span class="n">runner_host</span><span class="p">,</span> <span class="n">runner_port</span><span class="p">),</span> <span class="n">TestHandler</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="n">repo_folder</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">repo</span>

    <span class="n">dispatcher_host</span><span class="p">,</span> <span class="n">dispatcher_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">dispatcher_server</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"host"</span><span class="p">:</span> <span class="n">dispatcher_host</span><span class="p">,</span>
                                <span class="s2">"port"</span><span class="p">:</span> <span class="n">dispatcher_port</span><span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">communicate</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="p">[</span><span class="s2">"host"</span><span class="p">],</span>
                           <span class="nb">int</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="p">[</span><span class="s2">"port"</span><span class="p">]),</span>
                           <span class="s2">"register:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">runner_host</span><span class="p">,</span> <span class="n">runner_port</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">COMMUNICATE_OK</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Can't register with dispatcher!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># first register runner need init last_communication</span>
        <span class="n">server</span><span class="o">.</span><span class="n">last_communication</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dispatcher_checker</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
        <span class="c1"># Checks if the dispatcher went down. If it is down, we will shut down</span>
        <span class="c1"># if since the dispatcher may not have the same host/port</span>
        <span class="c1"># when it comes back up.</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">server</span><span class="o">.</span><span class="n">dead</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">server</span><span class="o">.</span><span class="n">last_communication</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">communicate</span><span class="p">(</span>
                        <span class="n">server</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="p">[</span><span class="s2">"host"</span><span class="p">],</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="p">[</span><span class="s2">"port"</span><span class="p">]),</span>
                        <span class="n">COMMUNICATE_STATUS</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">COMMUNICATE_OK</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Dispatcher is no longer functional"</span><span class="p">)</span>
                        <span class="n">server</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Can't communicate with dispatcher: </span><span class="si">{e}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                    <span class="k">return</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">dispatcher_checker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">server</span><span class="p">,))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1"># Activate the server; this will keep running until you</span>
        <span class="c1"># interrupt the program with Ctrl-C</span>
        <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
        <span class="c1"># if any exception occurs, kill the thread</span>
        <span class="n">server</span><span class="o">.</span><span class="n">dead</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_runner_script</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">commit_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">COMMIT_ID_FILE</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">COMMIT_ID_FILE</span><span class="p">)</span>

    <span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">git</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">git</span>

    <span class="n">run_or_fail</span><span class="p">(</span><span class="n">git</span><span class="o">.</span><span class="n">clean</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'-d'</span><span class="p">,</span> <span class="s1">'-f'</span><span class="p">,</span> <span class="s1">'-x'</span><span class="p">),</span>
                <span class="n">info</span><span class="o">=</span><span class="s1">'Could not clean repository'</span><span class="p">)</span>
    <span class="n">run_or_fail</span><span class="p">(</span><span class="n">git</span><span class="o">.</span><span class="n">pull</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s1">'Could not call git pull'</span><span class="p">)</span>
    <span class="n">run_or_fail</span><span class="p">(</span><span class="n">git</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">commit_id</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'hard'</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="n">info</span><span class="o">=</span><span class="s1">'Could not update to given commit hash'</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">serve</span><span class="p">()</span>
</code></pre></div>
<p>任务运行器一是刚开始需要向任务分发器回报，其次任务分发器那边会不断地询问各个人物运行器的健康度，任务运行器这边需要写好PING-PONG消息机制。</p>
<p>后面还多一个子线程是一种完善策略，保证任务分发器挂掉了这边任务运行器也会自动结束。</p>
<p>任务运行首先更新git仓库，然后通过unittest来运行tests文件夹下的测试代码，结果临时保存到了results文件下面。然后继续利用利用搭建好的套接字交流机制来通过result命令将运行后的结果发给任务分发器。</p>
<h2 id="总结">总结</h2>
<p>最后运行仍然和原来一样：</p>
<div class="highlight"><pre><span></span><code>python dispatcher.py
python test_runner.py &lt;path/to/test_repo_clone_runner&gt;
python repo_observer.py --dispatcher-server=localhost:8888 &lt;path/to/repo_clone_obs&gt;
</code></pre></div>
<p>对原仓库进行了文件更改，将会触发dispatch，继而触发任务分发器的runtest命令。</p>
<p>值得一提的是 <code>dispatched_commits</code> 里面的runner记录是必须在后面result报告完之后才会被删除，如果在这个过程中某个runner挂掉了，那么任务分发器的那个任务仍然是未完成状态，等下你再启动一个新的runner，将会分配任务给这个新的runner。</p>
<p>这个项目在分布式任务管理上的设计值得学习体会，同时上面的编码会大量涉及到套接字相关网络编程的东西，这些基础知识也需要读者掌握。</p>
            </div>
        </div>

    </div>
</div>

        <footer class="footer">
            <ul class="nav justify-content-center">
                <li class="nav-item">
                    <span class="nav-link text-muted px-2">Created by Wanze & Companion with</span></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://python.org/">Python</a></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="http://getpelican.com/">Pelican</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://github.com/Python-Markdown/markdown">Markdown</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="http://oncrashreboot.com/pelican-elegant">Elegant</a></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://www.javascript.com/">Javascript</a></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://www.npmjs.com/">Npm</a></li>
                <li class="nav-item">
                    <a class="nav-link text-muted px-2" href="https://www.mathjax.org/">Mathjax</a>
                </li>
                <li class="nav-item">
                    <span class="nav-link text-muted px-2">etc...</span></li>
            </ul>
        </footer>
    </div>

    <script src="https://a358003542.github.io/theme/dist/lodash/js/lodash.min.js"></script>
    <script src="https://a358003542.github.io/theme/dist/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://a358003542.github.io/theme/js/base.js"></script>

<script src="https://a358003542.github.io/theme/js/article.js"></script>


</body>

</html>